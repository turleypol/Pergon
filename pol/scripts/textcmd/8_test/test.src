use attributes;
use cfgfile;
use datafile;
use file;
use guilds;
use math;
use os;
use polsys;
use storage;
use unicode;
use uo;
use util;
use vitals;
// include "include/spawnnet";
// include "util/loot";
include "../../../pkg/opt/daymoonweather/daymoonweather";
include "../../../pkg/std/housing/house";
include "include/animal";
include "include/berufe";
include "include/client";
include "include/clock";
include "include/itemnpc";
include "include/modifyskill";
include "include/npc";
include "include/objtype";
include "include/onlinesearch";
include "include/packets";
include "include/pergoninfos";
include "include/quests";
include "include/spellcheck";
include "include/starteqp";
include "include/utility";

////////////////////////
// Klassendefinitionen
////////////////////////

Var content:={ };              // Buchinhalt
       content.+titleauthor:={ }; //   Titel und Autor
       content.+story:="";        //   Inhalt

/////////////////////
// Buchdefinitionen
/////////////////////

Var empty:=content;
       empty.titleauthor:={"", "Die Geschichte", "von", "Pergon", "", "Zoltan Nebar"};
       empty.story:="Mein Name ist Zoltan Nebar. Ich bin Gelehrter der "+
         "Wissenschaften der Natur und Geschichte. Die sind die Fakten, "+
         "die ich ueber unsere Welt bisher zusammengetragen habe. Viele "+
         "der Hinweise sind nur sehr vage und aus alten, muendlichen "+
         "Ueberlieferungen. Wie lange diese Welt schon existiert weis "+
         "keiner genau. Eins aber ist sicher, seit der Erschaffung der "+
         "Welt wird sie unter 2 Goettern aufgeteilt. Ihre Namen sind Khas "+
         "und Osin. Beide zusammen stellten ein Gleichgewicht dar. Pergon "+
         "war kaum besiedelt, als es zu einem Streit zwischen den Goettern "+
         "kam. Auf ihren Welten brachen Kriege aus. Pergon spielte wegen "+
         "der nur kleinen Anzahl an Glaeubigen eine geringe Rolle in dem "+
         "Konflikt. Im Verlaufe des Krieges gelang es Khas die Heimatwelt "+
         "von Osin zu erobern. Dabei konnte er seinen einzigen Sohn, "+
         "Orssol, gefangen nehmen. Osin war gezwungen sich aus dem Konfikt "+
         "zurueckzuziehen, um neue Kraefte zu sammeln. Vor etwa 10000 "+
         "Jahren begann Osin damit, hier auf Pergon einen neue Streitmacht "+
         "zu formieren, die 'Himmlische Armee'. Er versammelte seine "+
         "treuesten und glaeubigsten Anhaenger um sich herum. Natuerlich "+
         "erfuhr Khas davon und begann seine eigenen Legionen zu versammeln. "+
         "Die Armee ist bis heute als 'Dunkele Horde' bekannt. Die folgenden "+
         "Jahrehunderte muessen fuer die damaligen Bewohner grausam und "+
         "bitter gewesen sein. Die tobenden Schlachten vernichteten ganze "+
         "Kontinente. Viele der Pergoner starben. Die ist wohl auch ein "+
         "Grund warum so wenig ueber die Geschichte bekannt ist. Die "+
         "entscheidene Schlacht soll ueber dem offenem Meer gefuehrt worden "+
         "sein. Osin unterlag aber der verblieben Streitmacht der Dunkelen "+
         "Horde und zog sich auf das letzte Stueck Land Pergon`s zurueck. "+
         "Dies ist die Insel auf der wir heute noch leben. Osin errichtete "+
         "mit einem mystischen Artefakt eine Schutzbarriere um einen Teil "+
         "des Landes. Khas belagerte diese Barriere mehere Jahrzehnte, "+
         "jedoch gelang es ihm nicht sie zu durchbrechen. Osin wurde nicht "+
         "mehr gesehen und Khas brach die Belagerung ab, um als Sieger "+
         "ueber die Welten zu herrschen. Seit diesem Tag gab es keine "+
         "grossen Kriege mehr auf Pergon. Soweit die Erzaehlungen. Wenn "+
         "die Legende stimmt sind wir Nachkommen der letzten Pergoner und "+
         "vielleicht steckt in uns ein Teil der Himmlischen Armee. Osin "+
         "ist nicht wieder gesehen worden. Haelt er sich noch immer hier "+
         "auf ? Was ist mit seinem Sohn passiert ? Die Barriere jedefalls, "+
         "die uns vor Angriffen von Monstern schuetzt, haelt bis heute. "+
         "Diese mystische Artefakt muss also noch intakt sein und sich "+
         "irgendwo auf Pergon befinden. Ein Teil des Volkes glaubt fest an "+
         "die alten Legenden, dass Osin wieder auftauchen wird und Pergon "+
         "eine neue, bessere Zeit erleben wird. Ich als Gelehrter werde "+
         "weiter nach Hinweisen und Spuren suchen, bevor ich mich in einen "+
         "fanatischen Glauben stuerze, der schon soviel Leid gebracht hat. "+
         "[weitere Zeilen befinden sich in der Bibliothek]";

// Program TextCMD_Test(who, params, uc_params, langcode)
Program TextCMD_Test(who)
  If (!who.isa(POLCLASS_MOBILE) Or who.cmdlevel==CMDLEVEL_DEVELOPER) // Via Console oder Client (doofes Eremit ;o)
    Set_Script_Option(SCRIPTOPT_NO_RUNAWAY, 1);

    If (who.isa(POLCLASS_MOBILE)) // Via Client...
      SendSysMessagePergon(who, "Test-Script aktiviert...", "", _DEFAULT_TEXT_FONT, 38);
    EndIf
    SysLog("Test-Script aktiviert...");

   // ForEach accountname in ListAccounts(); {{{
   //   Var account:=FindAccount(accountname);
   //   If (account)
   //     SysLog("Account: '"+accountname+"'");
   //
   //     Var charnr;
   //     For (charnr:=1; charnr<=5; charnr:=charnr+1)
   //       Var char:=account.getcharacter(charnr);
   //       If (char)
   //         SysLog("  "+char.name);

           // Var item;
           // ForEach item In EnumerateItemsInContainer(char.backpack)
           //   If (item.objtype=0x0fef)
           //     SysLog("    "+item.name);
           //     If ((item.name=="Pergon Der Anfang") Or (item.name=="Das Anfangsbuch")
           //        Or (item.name=="Die Geschichte von Pergon"))
           //       DestroyItem(item);
           //       SysLog("      ausgetauscht");
           //     EndIf
           //   EndIf
           // EndForEach
           // Create_Book(char);

           // Var worldbank:=FindStorageArea(STORAGE_BANK);
           // If (worldbank)
           //   Var bank_obj_name:=ST_PREF_BANK+char.serial;
           //   Var bankbox:=FindRootItemInStorageArea(worldbank, bank_obj_name);
           //   If (!bankbox)
           //     bankbox:=CreateRootItemInStorageArea(worldbank, bank_obj_name, UOBJ_BANKBOX);
           //   EndIf
           //   If (bankbox)
           //     SysLog(bankbox.serial);
           //   EndIf
           // EndIf

           // Var class:=Lower(GetObjProperty(char, SKBERUF));
           // If (!class)
           //   class:=KLASSE_BERUF_NIX;
           // EndIf
           // SysLog("    Beruf = "+class);
           // SetCreateSkills(char);
           // SysLog("      ("+SetClass(char, class)+")");

           // SysLog("     "+CreateItemInBackpackPergon(char, UOBJ_GOLD_COIN, 5000));
   //       EndIf
   //     EndFor
   //   Else
   //     SysLog("'"+accountname+"' gibt es nicht !");
   //   EndIf
   // EndForEach

  //  ForEach accountname in ListAccounts();
  //    Var account:=FindAccount(accountname);
  //    If (account)
  //      SysLog("Account: '"+accountname+"'");
  //
  //      Var charnr;
  //      For (charnr:=1; charnr<=5; charnr:=charnr+1)
  //        Var char:=account.getcharacter(charnr);
  //        If (char)
  //          If (char.cmdlevel)
  //      SysLog("  "+char.name+" ("+accountname+") - "+char.cmdlevel);
  //
  //     // If ((accountname=="paul") Or (accountname=="bert") Or (accountname=="bertram"))
  //     //   SysLog("  "+char.name+" ("+char.x+", "+char.y+", "+char.z+")");
  //           //
  //           //   If (char.cmdlevel>CMDLEVEL_GM)
  //           //     char.cmdlevel:=CMDLEVEL_GM;
  //           //   EndIf
  //           //
  //           //   SendStringAsTipWindow(char, "So viel Frevel wird von den Goettern nicht geduldet!");
  //     //   account.ban(1);
  //     // EndIf
  //        EndIf
  //        EndIf
  //      EndFor
  //    Else
  //      SysLog("'"+accountname+"' gibt es nicht !");
  //    EndIf
  //  EndForEach }}}

    // diverse Tests {{{
    // StabilityTest();
    // MemoryTest();
    // MemoryTest2();
    // MemoryTest3();
    // MemoryTest4(params);
    // CleanUp();
    // Accounts_sperren();
    // SysLogSkillNames();
    // SysLogSkillProperties();
    // Accounts_loeschen();
    // EraseBackPackContent();
    // CountContainerContent(who);
    // CountBackPackContent();
    // SetStartEqp(who, params);
    // SetLostSkill();
    // InitNewStats();
    // FixJhelomNewbie();
    // FixWrongProperties();
    // FixWrongPropertiesGlobal();
    // FixZeroSkills();
    // FindLegendeSkills();
    // ResetOneSkill();
    // SetAttributeCapProp();
    // UnfreezePlayer();
    // FixObjProperties();
    // FixUnmovableNPCSellItems(who);
    // GetStichwortList("befreien");
    // KlassenBerufe_einlesen();
    // FixErrorsInChars();
    // DoListBerufe();
    // CountBankfachItems();
    // CheckArmorZeux(who);
    // ExchangeSkills();
    // TestFontColor(who);
    // TestFindParentContainer(who);
    // TestGetObjProperty(who);
    // ActivateNewSkillsMore();
    // SpellBookPergon(who);
    // TestPolCore(who);
    // ListScriptCycles(who);
    // LogRunAwayProblems();
    // TestCheckSkill(who, params);
    // ListNPCTemplates();
    // ListNPCTemplatesExcel();
    // FindWeaponLessNPCTemplates();
    // ListNPCEquipTemplatesExcel();
    // EmptyMerchantStorage(who);
    // DeleteAncientCharacter(who); // WARNUNG: Die Funktion ist gefahrlich!
    // SaveRemovedBankboxes(who, 0);
    // CheckContainerSetup(who);
    // TestPol094Functionality(who);
    // Check_Dmg_Mod(who);
    // TestUsedPol094Functionality(who);
    // TestGetObjPropertyNames(who);
    // CreateMissingSpellbook();
    // MakeNewbieItem({UOBJ_SPELLBOOK, 0x6100, 0xa100, 0xb100});
    // ListWeaponArmorCloth(who);
    // CheckMiningOutput(who);
    // ListDoorsLighting(who);
    // ListHouses(who);
    // ListHouseInfos();
    // ListEquippableHandItems(who);
    // ListAllEquippedItems(who);
    // CheckReparableItems(who);
    // ShowNPCItems(who);
    // SaveChars();
    // ListPotentielleSchmuggleWare();
    // DistroTestAllItemsAndNPCs(who);
    // CheckNFixItemProperties(who);
    // GenerateItemListForDB(who);
    // TestWWWOnlineWorkAround();
    // AnalyzeItem(who, params);
    // DupliziereCharacter(who);
    // DupliziereItem(who, item);
    // CheckStandingHeight(who);
    // HebeTeppich(who);
    // VersenkeItems(who);
    // ListUsableNPCTemplates(who);
    // ListCMDLevelChars();
    // DegradeCMDLevelChars();
    // GrantPrivsToCMDLevelChars();
    // DetectOnlineCMDLevelCharsSince(who);
    // ListChars();
    // TestCountActiveCharacters();
    // ListInconsistentItems(who, params);
    // Wetter_anschalten();
    // SpectatorTest(who);
    // SetSpellPanelMatrix(who);
    // ConvertSendPacketLine(who);
    // NPCDeathNameTest(who);
    // CheckSkillGainFunctions(who);
    // SetMissingWerkzeugMaxHP(who);
    // FixWerkzeugRepairSkill(who, params);
    // TestReserveRelease(who);
    // DupliziereBackpackItems(who);
    // CheckPol095Bugs(who);
    // CheckPol095Bugs2(who);
    // CheckPol095Features(who, params);
    // LogActivePlayerGM();
    // CountBackpackItems(who);
    // LogInterestingStuff(who);
    // ListeMailAddresses();
    // ListNPCTemplateNames();
    // ListNPCs();
    // ChangeNPCScript();
    // RemoveAnchorProp();
    // CheckItemProps(who);
    // DeleteWholeCharacter();
    // EmptyAllHouses(who);
    // SearchForMissedItems(who);
    // DestroyAllHouses(who);
    // DestroyEverythingButLeaveHousesXYZ(who);
    // UnLockOldSecureContainer(who);
    // UnlockBlockedAccount();
    // ResetOnlineCounter();
    // EraseUnusedCharCProps();
    // ResetSpawnRunes(who);          <-- nochmal testen, weil mag nich direkt
    // GenerateActSkillConfigData(who);
    // RenameWeapons();
    // RemoveCorpses(who);
    // TestOnlineSearch(who);
    // CheckStackability(who, params);
    // TransformStaticHouses(who);
    // ManuallyAddHouseFriend(who);
    // ManuallyAddGuildHouseFriend(who);
    // DestroySpecialItemsFromWorld(who);
    // RestoreSpecialItemsIntoWorld(who);
    // ListBankboxContent(who);
    // CheckDateOutput();
    // Pol095BugText(who);
    // DestroyMountItems();
    // TestBookStuff(who);
    // ResetSpellPanel();
    // ListSpawnRunes(who);
    // RestoreHouseSigns();
    // CheckNewAIFeatures(who, params);
    // CheckAndReCreateBackpacks();
    // CheckGetItemDescriptor(who);
    // FixSpawnnetAnchors(who);
    // ShowNPCGlobals(who);
    // ChangeGuildmaster(who);
    // LogGuildInfos(who);
    // TestListNewsAccounts();
    // RemoveTownStoneKandidat(who);
    // CheckMultisCfgDifferences(who);
    // CheckMultisCfgDifferences2(who);
    // TestDifferentRealms(who);
    // FindHorses(who);
    // FindTierzuchtTiere(who);
    // TestWeather(who, params);
    // TestLight(who, params);
    // TestRegions(who);
    // TestCreationTime(who, params);
    // TestSpyOnClient(who);
    // TestRandomFloat();
    // FindTownGuards(who);
    // FixNPCGender(who);
    // DestroySpecialItemsFromRange(who);
    // TestServerClientPackets(who);
    // FixItemNames(who);
    // FixItemColor(who);
    // GenerateTilesList(who);
    // TestCoreFunctions(who);
    // SummonNPC(who, params);
    // CheckCreateNPC(who);
    // MakeEquipMovable(who);
    // ArenaQuest(who, params);
    // ExchangeElementals(who);
    // ExchangeBears(who);
    // ExchangeMainAIAnimals(who);
    // KillNPCsByScriptType(who);
    // HeavenizeNPCs(who, params);
    // CheckQuestArrow(who, params);
    // FindSpawnRunes(who);
    // TestZonk(who);
    // TestRealmBugs(who);
    // CreateHairBeard(who, params);
    // CheckCombatDelayMod(who, params);
    // TestListMobiles(who);
    // ListSpawnNetItems(who);
    // DeleteAccount(who, params);
    // SplitAccount(who, params);
    // TestEnumerateItemsInContainer(who, params);
    // TestSecureTradeWin(who, params);
    // TestFindPathCrashes(who, params);
    // TestDifferentThings(who, params);
    // DetectSenslessNPCs(who);
    // CheckCharmedNPC();
    // InitHateLove(); // Siehe animal.inc
    // TestHousingTool(who);
    // TestHugeGumps(who, params);
    // TestHugeGumps2(who, params);
    // BloodCrash(who, params);
    // AttachCrash(who);
    // TestFindPathFlags(who, params);
    // TestMathStuff(who);
    // TestPacketByteOrder(who);
    // TestRequestInput(who);
    // ShowRunawayScriptInfo(who, params);
    // TestSendDialogGump(who, params);
    // ModifyPunishInfo(who);
    // TestNewBuggedAustinFeatures(who);
    // TestAccountScriptObject(who);
    // ModifyAllBauAccounts(who);
    // TestMoveObjectToLocation(who);
    // CheckNPCAttaching(who, params);
    // FindAndDestroyTeleporterInRange(who, params);
    // ConvertGuilds();
    // TestMLStuff(who);
    // ConvertStabledPetsSearch(who);
    // Wahlen_starten(who);
    // StaticsExportEremit(who, params);
    // StaticsExchange(who);
    // UnBlockAccounts(who);
    // CheckAccountProperties();
    // DeleteItemsWithSerial(who);
    // }}}

    //ModifyItemsInWorld();
    // RemoveForgottenBlood();
    // BugTest();
    
    //FixRemovedGuilds();
    
    //InitNewNameSystem();
    
    //DestroyKindlings();
    //BauAccounts_sperren();

    If (who.isa(POLCLASS_MOBILE)) // Via Client...
      SendSysMessagePergon(who, "Test-Script deaktiviert.", "", _DEFAULT_TEXT_FONT, 38);
    EndIf
    SysLog("Test-Script deaktiviert.");
  Else
    SendSysMessagePergon(who, "Dieses Script ist zu kritisch, als das Ihr es ausfuehren duerft!", "", _DEFAULT_TEXT_FONT, 38);
  EndIf
EndProgram

////////////////////////////////////////////////////////
// Accounts_sperren - Deaktiviert die Spieler-Accounts
////////////////////////////////////////////////////////

Function BauAccounts_sperren()
  If (!GetGlobalProperty(BAUSERVER))
    SysLog("Kein BauServer!");
    return;
  Endif
  Var exclude:={
  {"Chaos",8},
  {"turley",8},
  {"mehdorn",8},
  {"Regen",8},
  {"Anselm",5},
  {"Zanica",5}, 
  {"medusa",5},
  {"peramo",5},
  {"Paul",5},
  {"Tamina",6}
  };

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    var charnr;
    If (!account)
      SysLog("'"+accountname+"' gibt es nicht !");
      continue;
    EndIf
    var keep:=0;
    foreach acc in exclude
      if (acc[1]==accountname)
        keep:=_acc_iter;
        break;
      endif
    EndForEach
    
    var charc:=0;
    For (charnr:=1; charnr<=5; charnr+=1)
      Var char:=account.getcharacter(charnr);
      If (char)
        charc+=1;
      EndIf
    EndFor
    if (keep)
      if (charc>1)
        SysLog("more then one char " + accountname+" but keep state!");
        continue;
      endif
      For (charnr:=1; charnr<=5; charnr+=1)
        Var char:=account.getcharacter(charnr);
        If (char)
          if (char.cmdlevel != exclude[keep][2])
            SysLog("Setting cmdlevel from {} to {} for {} in {}".format(char.cmdlevel,exclude[keep][2], char.name, accountname));
            char.cmdlevel:=exclude[keep][2];
          Else
            SysLog("Matching cmdlevel for {} ({}) in {}".format(char.name, char.cmdlevel,accountname));
          endif
        EndIf
      EndFor
      continue;
    endif
    
    For (charnr:=1; charnr<=5; charnr+=1)
      Var char:=account.getcharacter(charnr);
      If (char)
        char.cmdlevel:=0;
        char.concealed:=0;
      EndIf
    EndFor
    account.disable();
  EndForEach
EndFunction

Function DestroyKindlings()
  var itemList := ListItemsNearLocationOfType(3031, 658, 42, 2, 0x0de1);
  ForEach item in (itemList)
    DestroyItem(item);
    SleepMS(2);
  EndForEach
  itemList := ListItemsNearLocationOfType(3031, 658, 42, 2, 0x0de2);
  ForEach item in (itemList)
    DestroyItem(item);
    SleepMS(2);
  EndForEach
  itemList := ListItemsNearLocationOfType(3031, 658, 41, 2, UOBJ_ASHES);
  ForEach item in (itemList)
    DestroyItem(item);
    SleepMS(2);
  EndForEach
EndFunction

Function InitNewNameSystem()
  
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (!account)
      continue;
    EndIf
    account.eraseprop("CharKenn");
    account.eraseprop("wantchar");
    Var charnr;
    For (charnr:=1; charnr<=5; charnr+=1)
      Var char:=account.getcharacter(charnr);
      If (!char)
        continue;
      EndIf
      
      // Unnütze CProps löschen
      char.eraseprop("name_unchecked");
      char.eraseprop("SkLern");
      char.eraseprop("SkErfahrung");
      
      // Bei unbenannten Spielern neuen Standardnamen setzen
      If (char.name == "Unbenannt")
        If (char.gender)
          SetName(char, "Neue Bewohnerin");
        Else
          SetName(char, "Neuer Bewohner");
        EndIf
      EndIf
      
      // myname darf nur den eigentlichen Namen enthalten
      var myname := char.getprop("myname");
      var newmyname := RemoveTown(RemoveGuildPrefix(char));
      If (!Compare(myname, newmyname))
        char.setprop("myname", newmyname);
      EndIf
      
    EndFor
  EndForEach
EndFunction

Function FixRemovedGuilds()
  
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (!account)
      continue;
    EndIf
    Var charnr;
    For (charnr:=1; charnr<=5; charnr+=1)
      Var member:=account.getcharacter(charnr);
      If (!member)
        continue;
      EndIf
      member.eraseprop("guild_id"); // old cprop
      
      If (member.guild)
        continue;
      EndIf

      member.eraseprop("guildtitle");
      member.eraseprop("gc_talk");
      member.eraseprop("gc_hear");

      Var title :="";
      If (member.name["Ritter "]) // RdO
        title:="Ritter";
      ElseIf (member.name["Sir "])
        title:="Sir";
      ElseIf (member.name["Lady "])
       title:="Lady";
      ElseIf (member.name["Cruor "])  // OdN
        title:="Cruor";
      ElseIf (member.name["Cruoria "])
        title:="Cruoria";
      ElseIf (member.name["Magus "])
        title:="Magus";
      ElseIf (member.name["Fascina "])
        title:="Fascina";
      ElseIf (member.name["Furor "])
        title:="Furor";
      ElseIf (member.name["Shinma "])
        title:="Shinma";
      ElseIf (member.name["Praetor "])  // Lyrell
        title:="Praetor";
      ElseIf (member.name["Praetorin "])
        title:="Praetorin";
      ElseIf (member.name["Artesan "])
        title:="Artesan";
      ElseIf (member.name["Artesana "])
        title:="Artesana";
      ElseIf (member.name["Frater "])
        title:="Frater";
      ElseIf (member.name["Soror "])
        title:="Soror";
      ElseIf (member.name["Maestra "]) // IGM
        title:="Maestra";
      ElseIf (member.name["Maestro "])
        title:="Maestro";
      ElseIf (member.name["Signor "])
        title:="Signor";
      ElseIf (member.name["Signora "])
        title:="Signora";
      ElseIf (member.name["Bruder "])  // JdD
        title:="Bruder";
      ElseIf (member.name["Bellatrix "])
        title:="Bellatrix";
      ElseIf (member.name["Inquisitor "]) // IdF
        title:="Inquisitor";
      ElseIf (member.name["Inquisitorin "])
        title:="Inquisitorin";
      EndIf
      LogToFile("log/fixguilds.log","loesche cprops an "+member.name+" ("+hex(member.serial)+")"); 
      If (!title)
        continue;
      EndIf
      var name        := member.name;
      name[title+" "] := "";
      LogToFile("log/fixguilds.log","aendere name an "+member.name+" ("+hex(member.serial)+") zu "+name); 
      SetName(member,name);
      SetObjProperty(member, "myname", RemoveTown(name));

    EndFor
  EndForEach
EndFunction

/////////////////////////////////////
// StabilityTest - Stabilitaetstest
/////////////////////////////////////

Function StabilityTest()
  Var x;
  Var y;

  Var index;
  For (index:=1; index<=1000; index:=index+1)
    Repeat
      x:=RandomInt(588)+2053;
      y:=RandomInt(575)+673;
    Until (CreateNpcFromTemplate("stablem", x, y, GetWorldHeight(x, y)));

    SysLog("Stability "+index+" / "+ReadGameClock()+" / ("+x+", "+y+")");

    Sleep (RandomInt(18)+2);
  EndFor
EndFunction

//////////////////////////////////////////////////
// MemoryTest - Wieviel RAM frisst die Kiste so?
//////////////////////////////////////////////////
//
// Test 1 - normal gespawnte Welt -> 10.000 Viecher erzeugen und töten / keine Spieler / Lachdanan-Gentoo
// Test 2 - leere Welt            -> 10.000 Viecher erzeugen und töten / keine Spieler / Lachdanan-Gentoo
// Test 3 - normal gespawnte Welt -> 10.000 Viecher erzeugen und töten / keine Spieler / Tiu-XP
// Test 4 - leere Welt            -> 10.000 Viecher erzeugen und töten / keine Spieler / Tiu-XP
// Test 5 - normal gespawnte Welt -> 10.000 Viecher erzeugen und töten / keine Spieler / Pergon-Gentoo (59.2% - 65%)

Function MemoryTest()
  Var puffer:={};
  Var count:=1;
  Var x, y;
  Var npc;

  SetGlobalProperty("#MemoryTest", 1); // Damit man den auch stoppen kann

  While ((count<10100) And GetGlobalProperty("#MemoryTest"))
    If (count<10000)
      Repeat
        x:=RandomInt(588)+2053;y:=RandomInt(575)+673;
        npc:=CreateNpcFromTemplate("headless", x, y, GetWorldHeight(x, y));
      Until (npc);

      puffer[count]:=npc.serial;

      SysLog("Memory/CreateNPC "+Lower(Hex(npc.serial))+" / "+count+" / "+ReadGameClock()+" / "+PolCore().mobilecount);
    EndIf

    If (count>100)
      KillMobile(SystemFindObjectBySerial(puffer[count-100]), "TextCMD Test-MemoryTest");

      SysLog("Memory/KillNPC   "+Lower(Hex(puffer[count-100]))+" / "+PolCore().mobilecount);
    EndIf

    count:=count+1;
    Sleep (RandomInt(3)+2); // (RandomInt(4)+2);
  EndWhile

  EraseGlobalProperty("#MemoryTest");
EndFunction

///////////////////////////////////////////////////
// MemoryTest2 - Wieviel RAM frisst die Kiste so?
///////////////////////////////////////////////////
//
// Test 1 - leere Welt -> 100.000 Waffen mit  ControlScript erzeugen und loeschen
// Test 2 - leere Welt -> 100.000 Waffen ohne ControlScript erzeugen und loeschen

Function MemoryTest2()
  Var puffer:={};
  Var count:=1;
  Var x, y;
  Var npc;

  SetGlobalProperty("#MemoryTest", 1); // Damit man den auch stoppen kann

  While ((count<10100) And GetGlobalProperty("#MemoryTest"))
    If (count<10000)
      Repeat
        x:=RandomInt(588)+2053;y:=RandomInt(575)+673;
        npc:=CreateNpcFromTemplate("headless", x, y, GetWorldHeight(x, y));
      Until (npc);

      puffer[count]:=npc.serial;

      SysLog("Memory/CreateNPC "+Lower(Hex(npc.serial))+" / "+count+" / "+ReadGameClock()+" / "+PolCore().mobilecount);
    EndIf

    If (count>100)
      KillMobile(SystemFindObjectBySerial(puffer[count-100]), "TextCMD Test-MemoryTest");

      SysLog("Memory/KillNPC   "+Lower(Hex(puffer[count-100]))+" / "+PolCore().mobilecount);
    EndIf

    count:=count+1;
    Sleep (RandomInt(3)+2); // (RandomInt(4)+2);
  EndWhile

  EraseGlobalProperty("#MemoryTest");
EndFunction

///////////////////////////////////////////////////
// MemoryTest3 - Wieviel RAM frisst die Kiste so?
///////////////////////////////////////////////////

Function MemoryTest3()
  SysLog(PolCore().internal(1));
EndFunction

///////////////////////////////////////////////////
// MemoryTest4 - Wieviel RAM frisst die Kiste so?
///////////////////////////////////////////////////

Function MemoryTest4(params)
  params:=CInt(params);
  If (params==1)
    Var days:=ReadConfigFile("::days");
    SysLog(days["WholeDay"].length);
    UnloadConfigFile("::days");
  Else
    Var days:=ReadConfigFile("days");
    SysLog(days["WholeDay"].length);
    UnloadConfigFile("days");
  EndIf
EndFunction

/////////////////////////////////
// CleanUp - Bereinigt die Welt
/////////////////////////////////

Function CleanUp()
  Var items:={0x6009, 0x600a, 0x600b, 0x600c, 0x600d, 0x600e, 0x600f,
    0x6010, 0x6011, 0x6012, 0x6013, 0x6014, 0x6015, 0x6016, 0x6017, 0x6018};

  SysLog("Account-Cleaning gestartet...");
  CleanUpAccounts(items);
  SysLog("Account-Cleaning beendet.");

  SysLog("World-Cleaning gestartet...");
  CleanUpWorld(items);
  SysLog("World-Cleaning beendet.");

  SysLog("NPC-Cleaning gestartet...");
  CleanUpNPCs(items);
  SysLog("NPC-Cleaning beendet.");
EndFunction

////////////////////////////////////////////////////////
// CleanUpAccounts - Loescht ein Item aus den Accounts
////////////////////////////////////////////////////////

Function CleanUpAccounts(items)
  Var count;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      count:=0;

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          ForEach item In EnumerateItemsInContainer(char.backpack)
            If (item.objtype in items)
              DestroyItem(item);
              count:=count+1;
            EndIf
          EndForEach

          Var worldbank:=FindStorageArea(STORAGE_BANK);
          If (worldbank)
            Var bankbox:=FindRootItemInStorageArea(worldbank, ST_PREF_BANK+char.serial);
            If (bankbox)
              ForEach item In EnumerateItemsInContainer(bankbox)
                If (item.objtype in items)
                  DestroyItem(item);
                  count:=count+1;
                EndIf
              EndForEach
            EndIf
          EndIf
        EndIf
      EndFor

      If (count)
        SysLog("  Account: '"+accountname+"' ("+count+")");
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////
// CleanUpWorld - Loescht ein Item aus der Welt
/////////////////////////////////////////////////

Function CleanUpWorld(items)
  Var count:=0;

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_CONTAINER))
      ForEach inside_item in EnumerateItemsInContainer(item)
        If (inside_item.objtype in items)
          DestroyItem(inside_item);
          count:=count+1;
        EndIf
      EndForEach
    ElseIf (item.isa(POLCLASS_ITEM))
      If (item.objtype in items)
        DestroyItem(item);
        count:=count+1;
      EndIf
    EndIf
  EndForEach

  If (count)
    SysLog("  World ("+count+")");
  EndIf
EndFunction

/////////////////////////////////////////////////////////
// CleanUpNPCs - Loescht ein Item aus der NPC-Backpacks
/////////////////////////////////////////////////////////

Function CleanUpNPCs(items)
  Var worldbank:=FindStorageArea(STORAGE_BANK);
  Var storage:=FindStorageArea(STORAGE_MERCHANT);
  If ((worldbank) And (storage))
    Var count;
    Var bankbox;

    Var serial;
    For (serial:=1; serial<500000; serial:=serial+1)
      count:=0;

      bankbox:=FindRootItemInStorageArea(worldbank, ST_PREF_BANK+serial);
      If (bankbox)
        ForEach item In EnumerateItemsInContainer(bankbox)
          If (item.objtype in items)
            DestroyItem(item);
            count:=count+1;
          EndIf
        EndForEach
      EndIf

      bankbox:=FindRootItemInStorageArea(storage, serial+" FS");
      If (bankbox)
        ForEach item In EnumerateItemsInContainer(bankbox)
          If (item.objtype in items)
            DestroyItem(item);
            count:=count+1;
          EndIf
        EndForEach
      EndIf

      bankbox:=FindRootItemInStorageArea(storage, serial+" PB");
      If (bankbox)
        ForEach item In EnumerateItemsInContainer(bankbox)
          If (item.objtype in items)
            DestroyItem(item);
            count:=count+1;
          EndIf
        EndForEach
      EndIf

      bankbox:=FindRootItemInStorageArea(storage, serial+" 1C");
      If (bankbox)
        ForEach item In EnumerateItemsInContainer(bankbox)
          If (item.objtype in items)
            DestroyItem(item);
            count:=count+1;
          EndIf
        EndForEach
      EndIf

      If (!SystemFindObjectBySerial(serial))
        DestroyRootItemInStorageArea(worldbank, ST_PREF_BANK+serial);
        DestroyRootItemInStorageArea(storage, serial+" FS");
        DestroyRootItemInStorageArea(storage, serial+" PB");
        DestroyRootItemInStorageArea(storage, serial+" 1C");
      EndIf

      If (count)
        SysLog("  NPC: '"+serial+"' ("+count+")");
      EndIf
    EndFor
  EndIf
EndFunction

//////////////////////////////////////////////////
// Create_Book - Erzeugt ein Story-Einstiegsbuch
//////////////////////////////////////////////////

Function Create_Book(who)
  Var book:=CreateItemInBackpackPergon(who, 0x0fef, 1);
  If (book)
    book.name:="Die Geschichte von Pergon";
    SetObjProperty(book, "bookcontent", empty);
    SetObjProperty(book, "writeable", 0);
  Else
    SysLog(who.name+" mag kein Buch !");
  EndIf
EndFunction

////////////////////////////////////////////////////////
// Accounts_sperren - Deaktiviert die Spieler-Accounts
////////////////////////////////////////////////////////

Function Accounts_sperren()
  Var exclude:={"niere", "fraggle", "Shinigami", "Firefox",
    "Der Guru", "SeBB", "Pacmaker", "bean", "Dshihad", "Der_Guru",
    "Whiskey", "demohn", "Iwan"};

  ForEach accountname in ListAccounts()
    If (accountname in exclude)
      SysLog("Account: '"+accountname+"' wurde NICHT geblockt!");
    Else
      Var account:=FindAccount(accountname);
      If (account)
        account.disable();

        SysLog("Account: '"+accountname+"' deaktiviert!");
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////
// Accounts_loeschen - Loescht die Spieler-Accounts
/////////////////////////////////////////////////////

Function Accounts_loeschen()
  Var exclude:={"niere", "fraggle", "Shinigami", "Firefox",
    "Der Guru", "SeBB", "Pacmaker", "bean", "Dshihad", "Der_Guru",
    "Whiskey", "demohn", "Iwan"};

  ForEach accountname in ListAccounts()
    If (accountname in exclude)
      SysLog("Account: '"+accountname+"' wurde NICHT geloescht!");
    Else
      Var account:=FindAccount(accountname);
      If (account)
        SysLog("Account: "+accountname);

        Var charnr;
        For (charnr:=1; charnr<=5; charnr:=charnr+1)
          Var char:=account.getcharacter(charnr);
          If (char)
            SysLog("  Character: "+char.name);

            DeleteCharacterPergon(account, charnr);
          EndIf
        EndFor
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////
// EraseBackPackContent - Loescht BackPack-Inhalt
///////////////////////////////////////////////////

Function EraseBackPackContent()
  Var items;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          items:=EnumerateItemsInContainer(char.backpack);
          SysLog("  "+char.name+" "+char.weight+" "+items.size());

          ForEach item in items
            DestroyItem(item);
          EndForEach
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////
// SysLogSkillNames - Gibt alle SkillNames aus
////////////////////////////////////////////////

Function SysLogSkillNames()
  Var skillnames:={ };

  ForEach sorted in (GetSkillsSorted())
    var skill:=GetSkillInfo(sorted);
    skillnames.append(skill.name+" ("+skill.trainname+")");
  EndForEach

  SysLog(skillnames);
EndFunction

/////////////////////////////////////////////////////////
// SysLogSkillProperties - Gibt alles zu den Skills aus
/////////////////////////////////////////////////////////

Function SysLogSkillProperties()
  Var datafile:=CreateDataFile("Skills", DF_KEYTYPE_INTEGER);

  SysLog("TrainName AdvDex AdvInt AdvStr [Chance Formel MinPunkte MaxPunkte]");

  Var elem;
  ForEach sorted in (GetSkillsSorted())
    var skill:=GetSkillInfo(sorted);
    elem:=datafile.createelement(skill.id);
    elem.setprop("TrainName", skill.trainname);
    If (skill.advdex)
      elem.setprop("AdvDex", skill.advdex);
    Else
      elem.setprop("AdvDex", "");
    EndIf
    If (skill.advint)
      elem.setprop("AdvInt", skill.advint);
    Else
      elem.setprop("AdvInt", "");
    EndIf
    If (skill.advstr)
      elem.setprop("AdvStr", skill.advstr);
    Else
      elem.setprop("AdvStr", "");
    EndIf
    If (skill.unhides==0)
      elem.setprop("Unhides", 0);
    Else
      elem.setprop("Unhides", 1);
    EndIf

    Var text:=skill.trainname;
    While (text[" "])
      text[" "]:="_";
    EndWhile
    text:=text+" "+GetStatAdvInfo(skill.advdex)+" "+
      GetStatAdvInfo(skill.advint)+" "+GetStatAdvInfo(skill.advstr);
    If (skill.unhides==0)
      SysLog(text+" 0");
    Else
      SysLog(text+" 1");
    EndIf
  EndForEach

  UnloadDataFile("Skills");
EndFunction

/////////////////////////////////////////////////////////
// GetStatAdvInfo - Liefert Stat-Anstiegs-Informationen
/////////////////////////////////////////////////////////

Function GetStatAdvInfo(advstring)
  If (advstring)
    Var points:=SplitWords(advstring)[2];
    points["d"]:=" ";
    points["+"]:=" ";
    points:=SplitWords(points);

    Return (advstring+" "+(CInt(points[1])+CInt(points[3]))+" "+(CInt(points[1])*CInt(points[2])+CInt(points[3])));
  Else
    Return ("0 0 0 0");
  EndIf
EndFunction

////////////////////////////////////////////////////////////
// CountContainerContent - Wieviel Zeux ist in Containern?
////////////////////////////////////////////////////////////

Function CountContainerContent(who)
  Var count;

  ForEach item in ListItemsNearLocation(who.x, who.y, who.z, 10000)
    If (item.isa(POLCLASS_CONTAINER))
      count:=EnumerateItemsInContainer(item).size();

      If (count>140)
        SysLog("Cont "+item.x+", "+item.y+", "+item.z+" = "+count+" "+item.weight);
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////
// CountBackPackContent - Wieviel Zeux ist im Backpack?
/////////////////////////////////////////////////////////

Function CountBackPackContent()
  Var count;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          count:=EnumerateItemsInContainer(char.backpack).size();

          If (count>140)
            SysLog("Account: "+accountname);
            SysLog("Char "+char.name+" "+Hex(char.serial)+" = "+count);
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////
// SetStartEqp - Setze Start-Equipment
////////////////////////////////////////

Function SetStartEqp(who, params)
  Var charskills:=ReadConfigFile(FILE_CHARSKILLS);
  If (charskills)
    Var skills:=charskills["Player_"+params];
    If (skills)
      Var tgt:=Target(who);
      Var equipskills:={ };

      ForEach skill in GetConfigStringArray(skills, "BerufSkill")
        equipskills.append(SplitWords(skill)[1]);
      EndForEach

      ForEach skill in GetConfigStringArray(skills, "HauptSkill")
        equipskills.append(SplitWords(skill)[1]);
      EndForEach

      CreateStartingEquipment(tgt, equipskills);
    EndIf

    UnloadConfigFile(FILE_CHARSKILLS);
  EndIf
EndFunction

//////////////////////////////////////////////////
// SetLostSkill - Ruestet den letzten Skill nach
//////////////////////////////////////////////////

Function SetLostSkill()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          If (char.cmdlevel < CMDLEVEL_SEER)
            CheckSkillLimitAndCut(char, GetSkillName(MAX_SKILLS));
          EndIf

          SysLog("  "+char.name);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////
// InitNewStats - Initialisiert die Stats
///////////////////////////////////////////

Function InitNewStats()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          SetObjProperty(char, ATTRIBUTEWERTKENNUNG+ATTRIBUTEID_DEXTERITY,
            BaseSkillToRawSkillPergon((GetDexPergon(char)-GetDexModPergon(char))*10+1));
          SetObjProperty(char, ATTRIBUTEWERTKENNUNG+ATTRIBUTEID_INTELLIGENCE,
            BaseSkillToRawSkillPergon((GetIntPergon(char)-GetIntModPergon(char))*10+1));
          SetObjProperty(char, ATTRIBUTEWERTKENNUNG+ATTRIBUTEID_STRENGTH,
            BaseSkillToRawSkillPergon((GetStrPergon(char)-GetStrModPergon(char))*10+1));

          SysLog("  "+char.name);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////
// FixZeroSkills - Behebt den Bug mit geloeschten Skills
//////////////////////////////////////////////////////////

Function FixZeroSkills()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          CheckPlayerLimitsAndCut(char);

         // If (!(char.serial in {0x1, 0xf29, 0xb12})) // weder Eremit, Caine, noch Jason
         //   SysLog(char.name+" ["+char.acctname+"] runtergestuft von "+char.cmdlevel);
         //   char.cmdlevel:=CMDLEVEL_SEER;
         // EndIf

         // If (GetObjProperty(char, "#CastSpell"))
         //   SysLog("  #CastSpell - "+char.name+" ["+accountname+"]");
         // EndIf
         // EraseObjProperty(char, "#CastSpell");
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////////////
// FindLegendeSkills - Sucht nach Spielern, die Legende wo sind
/////////////////////////////////////////////////////////////////

Function FindLegendeSkills()
  Var skillid:=SKILLID_ZAEHMEN;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (!char.cmdlevel)
            If ((GetObjProperty(char, SKILLTYPKENNUNG+skillid)==SKILLTYP_BERUF) And (GetSkillPergon(char, skillid)>=100))
              SysLog("  Legende im "+skillid+" = "+char.name+" ["+char.acctname+"] mit "+GetSkillPergon(char, skillid));
            EndIf
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////
// ResetOneSkill - Setzt einen Skill zurueck
//////////////////////////////////////////////

Function ResetOneSkill()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          Case (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_ALCHEMIE))
            SKILLTYP_BERUF:   If (GetSkillPergon(char,SKILLID_ALCHEMIE)>80)
                                SetSkillPergon(char, SKILLID_ALCHEMIE, 80);
                              ElseIf (GetSkillPergon(char,SKILLID_ALCHEMIE)>30)
                                SetSkillPergon(char, SKILLID_ALCHEMIE, 30);
                              EndIf
            SKILLTYP_HAUPT:
            SKILLTYP_NEBEN:
            SKILLTYP_WEITERE: If (GetSkillPergon(char,SKILLID_ALCHEMIE)>30)
                                SetSkillPergon(char, SKILLID_ALCHEMIE, 30);
                              EndIf
          EndCase

          CheckPlayerLimitsAndCut(char);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////
// FixJhelomNewbie - Setzt ueberall die Property
//////////////////////////////////////////////////

Function FixJhelomNewbie()
  Var count;
  Var i;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          SysLog("  "+char.name);

          SetObjProperty(char, TYPNEWBIE, 1);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////
// FixWrongProperties - Korrigiert falsche Einstellungen
//////////////////////////////////////////////////////////

Function FixWrongProperties()
  ForEach accountname in {"Yppolita"}
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Case (accountname)
        "Yppolita": //
         // account.setprop("CharKenn", "FeiverakBreeder2_567678");
          Var char:=account.getcharacter(1);
          If (char)
           // SetObjProperty(char, SKKLASSE, KLASSE_HANDWERKER);
           // SetObjProperty(char, SKBERUF, "Zeugschmied");

           // account.setprop("CharKenn", "Devoir1_564785");

            SetObjProperty(char, SKILLTYPKENNUNG+SKILLID_VERSTECKEN, SKILLTYP_NEBEN);
            SetObjProperty(char, SKILLTYPKENNUNG+SKILLID_SCHLEICHEN, SKILLTYP_WEITERE);
           // SetRawSkillPergon(char, SKILLID_FECHTKUNST, GetRawSkillPergon(char, SKILLID_INFANTERIEWAFFEN));
            EraseObjProperty(char, SKILLTYPKENNUNG+SKILLID_MUSIZIEREN);
            EraseObjProperty(char, SKILLTYPKENNUNG+SKILLID_FOERSTEREI);
          EndIf
      EndCase
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////
// FixWrongPropertiesGlobal - Korrigiert falsche Einstellungen
////////////////////////////////////////////////////////////////

Function FixWrongPropertiesGlobal()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (GetObjProperty(char, SKBERUF) in {"Asket", "Heiler", "Zauberer", "Hexenmeister"})
            If (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_SEGNEN)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Heiler");
              SysLog("  "+char.name+" ["+accountname+"] geaendert zu "+GetObjProperty(char, SKBERUF));
            ElseIf (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_MAGIE)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Zauberer");
              SysLog("  "+char.name+" ["+accountname+"] geaendert zu "+GetObjProperty(char, SKBERUF));
            ElseIf (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_FLUCHEN)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Hexenmeister");
              SysLog("  "+char.name+" ["+accountname+"] geaendert zu "+GetObjProperty(char, SKBERUF));
            Else
              SysLog("  FEHLER: "+char.name+" ["+accountname+"] hat illegale Berufsskills.");
            EndIf
          EndIf

          If (GetObjProperty(char, SKBERUF) in {"Schreiber", "Magister", "Kleriker", "Beschwoerer", "Arkanist", "Liturgist", "Okkultist"})
            If (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_MAGISCHEGEGENST)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Arkanist");
              SysLog("  "+char.name+" ["+accountname+"] geaendert zu "+GetObjProperty(char, SKBERUF));
            ElseIf (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_GESEGNETEGEGENST)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Liturgist");
              SysLog("  WARNUNG: "+char.name+" ["+accountname+"] hatte einen illegalen Beruf. Geaendert zu "+GetObjProperty(char, SKBERUF));
            ElseIf (GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_VERFLUCHTEGEGENST)==SKILLTYP_BERUF)
              SetObjProperty(char, SKBERUF, "Okkultist");
              SysLog("  WARNUNG: "+char.name+" ["+accountname+"] hatte einen illegalen Beruf. Geaendert zu "+GetObjProperty(char, SKBERUF));
            Else
              SysLog("  FEHLER: "+char.name+" ["+accountname+"] hat illegale Berufsskills.");
            EndIf
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////
// SetAttributeCapProp - Setzt ueberall das AttributeCap
//////////////////////////////////////////////////////////

Function SetAttributeCapProp()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          Case (GetObjProperty(char, SKKLASSE))
            KLASSE_HANDWERKER: SetObjProperty(char, "AttributeCap", ATTRIBUTEID_INTELLIGENCE);
            KLASSE_KRIEGER:    SetObjProperty(char, "AttributeCap", ATTRIBUTEID_INTELLIGENCE);
            KLASSE_MAGIER:     SetObjProperty(char, "AttributeCap", ATTRIBUTEID_STRENGTH);
          EndCase
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////
// UnfreezePlayer - Taut Spieler wieder auf
/////////////////////////////////////////////

Function UnfreezePlayer()
  ForEach accountname in ListAccounts()
    If (accountname in {"rcalpha"})
      Var account:=FindAccount(accountname);
      If (account)
        SysLog("Account: "+accountname);

        Var char:=account.getcharacter(1);
        If (char)
          char.frozen:=0;
        EndIf
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////
// FixObjProperties - Korrigiert ObjProperties
////////////////////////////////////////////////

Function FixObjProperties()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          SysLog("  "+char.name);

          EraseObjProperty(char, "guardkill");
         // EraseObjProperty(char, "Proof");
         // EraseObjProperty(char, "proof");
         // SetObjProperty(char, PROP_THIRST, 10.0);
         // SetObjProperty(char, PROP_ALCOHOL, ALC_SOBER);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////////
// DoListBerufe - Erstellt eine Liste der benutzen Berufe
///////////////////////////////////////////////////////////

Function DoListBerufe()
 // SysLog("Berufstatistik");
 // SysLog("  "+ListBerufeExactly());
  ListBerufeInfos();
  ListDeathCounterInfos();
EndFunction

///////////////////////////////////////////////////////
// FixErrorsInChars - Korrigiert Fehler in Charactern
///////////////////////////////////////////////////////

Function FixErrorsInChars()
  Var account:=FindAccount("niere");
  If (account)
    Var char:=account.getcharacter(1); // Sam Again
    If (char)
      SetObjProperty(char, "logontime", 1);
    EndIf
  EndIf

  account:=FindAccount("Pacmaker");
  If (account)
    Var char:=account.getcharacter(2); // Urthok aus Minoc
    If (char)
      SetObjProperty(char, "logontime", 1);
    EndIf
  EndIf

  account:=FindAccount("bean");
  If (account)
    Var char:=account.getcharacter(1); // Rahvin Dah'vol
    If (char)
      SetObjProperty(char, SKKLASSE, KLASSE_KRIEGER);
    EndIf
  EndIf

  account:=FindAccount("Command");
  If (account)
    Var char:=account.getcharacter(1); // Bruder Xatulu
    If (char)
      SetObjProperty(char, SKBERUF, "Elementarmagier");
    EndIf
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////
// CountBankfachItems - Wieviele Gegenstaende befinden sich drin?
///////////////////////////////////////////////////////////////////

Function CountBankfachItems()
  Var items;

  ForEach accountname in ListAccounts()
    If (accountname=="Iwan")
      Var account:=FindAccount(accountname);
      If (account)
        SysLog("Account: "+accountname);

        Var char:=account.getcharacter(1);
        If (char)
          items:=EnumerateItemsInContainer(OpenBankBox(char));
          SysLog("  "+char.name+" "+char.weight+" "+items.size());

          Var cont:=CreateItemAtLocationPergon(5472, 1146, 0, 0xe7c, 1);
          If (cont)
            ForEach item in items
              MoveItemToContainer(item, cont);
            EndForEach

            DestroyBankBox(char);
          EndIf
        EndIf
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////
// CheckArmorZeux - Zeigt Eigenschaften des Items an
//////////////////////////////////////////////////////

Function CheckArmorZeux(who)
  SendSysMessagePergon(who, "Bitte ein Item auswaehlen!", "");

  Var item:=Target(who);
  If ((item.isa(POLCLASS_ARMOR)) Or (item.isa(POLCLASS_WEAPON)))
    Var itemdesc:=ReadConfigFile(":combat:itemdesc");
    itemdesc:=itemdesc[item.objtype];

    If (item.isa(POLCLASS_ARMOR))
      SendSysMessagePergon(who, "Ruestung "+item.desc, "", _DEFAULT_TEXT_FONT, 38);
      SendSysMessagePergon(who, "  Armor = "+item.ar+" ("+itemdesc.ar+")", "", _DEFAULT_TEXT_FONT, 68);
    Else
      SendSysMessagePergon(who, "Waffe "+item.desc, "", _DEFAULT_TEXT_FONT, 38);
    EndIf

    SendSysMessagePergon(who, "  HP = "+item.hp+" ("+itemdesc.maxhp+")", "", _DEFAULT_TEXT_FONT, 68);
    SendSysMessagePergon(who, "  MaxHP = "+item.maxhp+" ("+itemdesc.maxhp+")", "", _DEFAULT_TEXT_FONT, 68);
    If (!itemdesc.quality)
      SendSysMessagePergon(who, "  Quality = "+item.quality+" (1)", "", _DEFAULT_TEXT_FONT, 68);
    Else
      SendSysMessagePergon(who, "  Quality = "+item.quality+" ("+itemdesc.quality+")", "", _DEFAULT_TEXT_FONT, 68);
    EndIf

    If (item.vendorsellsfor)
      SendSysMessagePergon(who, "  VendorSellsFor = "+item.vendorsellsfor, "", _DEFAULT_TEXT_FONT, 68);
    EndIf
    If (item.vendorbuysfor)
      SendSysMessagePergon(who, "  VendorBuysFor = "+item.vendorbuysfor, "", _DEFAULT_TEXT_FONT, 68);
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

/////////////////////////////////////////////////////
// ExchangeSkills - Vertauscht 2 Skills miteinander
/////////////////////////////////////////////////////

Function ExchangeSkills()
  Var oldSk15;
  Var oldSk2;
  Var oldV15;
  Var oldV2;
  Var i;

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          oldSk2:=GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_ABRICHTEN);
          oldSk15:=GetObjProperty(char, SKILLTYPKENNUNG+SKILLID_TIERKUNDE);
          oldV2:=GetRawSkillPergon(char, 2);
          oldV15:=GetRawSkillPergon(char, 15);

          If (oldSk2)
            If (!oldSk15)
              EraseObjProperty(char, SKILLTYPKENNUNG+SKILLID_TIERKUNDE);
              SetRawSkillPergon(char, 2, 0);
            EndIf

            SetObjProperty(char, SKILLTYPKENNUNG+SKILLID_ABRICHTEN, oldSk2);
            SetRawSkillPergon(char, 15, oldV2);
          EndIf

          If (oldSk15)
            If (!oldSk2)
              EraseObjProperty(char, SKILLTYPKENNUNG+SKILLID_ABRICHTEN);
              SetRawSkillPergon(char, 15, 0);
            EndIf

            SetObjProperty(char, SKILLTYPKENNUNG+SKILLID_TIERKUNDE, oldSk15);
            SetRawSkillPergon(char, 2, oldV15);
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////
// TestFontColor - Testet die Farben
//////////////////////////////////////

Function TestFontColor(who)
  Var i;
  For (i:=85; i<95; i:=i+1)
    SendSysMessagePergon(who, "A "+i, "", _DEFAULT_TEXT_FONT, i);
  EndFor
EndFunction

////////////////////////////////////////////////////////////////
// TestFindParentContainer - Ermittelt den Container des Items
////////////////////////////////////////////////////////////////

Function TestFindParentContainer(who)
  SendSysMessagePergon(who, "Bitte ein Item auswaehlen!", "");

  Var item:=Target(who);
  If (item.isa(POLCLASS_ITEM))
    SysLog("1 "+FindObjtypeInContainer(who.backpack, item.objtype).desc);
    SysLog("2 "+SystemFindObjectBySerial(item.serial).desc);
    SysLog("3 "+EnumerateItemsInContainer(who.backpack));
    SysLog("4 "+item.container.desc);

  EndIf
EndFunction

/////////////////////////////////////////////////
// TestGetObjProperty - Testet ein bisschen rum
/////////////////////////////////////////////////

Function TestGetObjProperty(who)
  For skillid:=0 To MAX_SKILLS
    SysLog("  Skill "+skillid+" "+GetSkillPergon(who, skillid));
    // GetObjProperty(who, i)+" "+
  EndFor

  SysLog(GetObjProperty(who, 73));
  SysLog(GetObjProperty(who, "73"));
EndFunction

/////////////////////////////////////////////////////////////////////
// FixUnmovableNPCSellItems - Fixt unmovable Items in NPC Backpacks
/////////////////////////////////////////////////////////////////////

Function FixUnmovableNPCSellItems(who)
  Var count:=0;

  Var storage:=FindStorageArea(STORAGE_MERCHANT);
  If (storage)
    ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (npc.isa(POLCLASS_NPC))
        Var container:=FindRootItemInStorageArea(storage, npc.serial+" FS");
        If (container)
          ForEach item in EnumerateItemsInContainer(container)
            item.movable:=1;
          EndForEach
        EndIf

        count:=count+1;
      EndIf
    EndForEach
  EndIf

  SendSysMessagePergon(who, "Es wurden "+count+" NPCs ggf. gefixt.", "");
EndFunction

/////////////////////////////////////////////////////////////
// ActivateNewSkillsMore - Fuehrt globale Aenderungen durch
/////////////////////////////////////////////////////////////

Function ActivateNewSkillsMore()
  InitSkillsMore();
EndFunction

///////////////////////////////////////////////////
// SpellBookPergon - Stellt eigenes SpellBook dar
///////////////////////////////////////////////////

Function SpellBookPergon(who)
  SendSysMessagePergon(who, "Bitte das Spellbook anklickern!", "");

  Var spellbook:=Target(who);
  If (spellbook.isa(POLCLASS_ITEM) And (spellbook.graphic=UOBJ_SPELLBOOK))
    Var spells:=EnumerateItemsInContainer(spellbook);

    Var packet:="24"+DoubleWordPacket(spellbook.serial)+"FFFF";
    packet:=packet+"3C"+WordPacket(spells.size()*19+5)+WordPacket(spells.size());

    Var spellid;
    ForEach spell in spells
      spellid:=spell.objtype-0x1f2c;
      If (spellid<8)
        If (spellid=1)
          spellid:=7;
        Else
          spellid:=spellid-1;
        EndIf
      EndIf

      packet:=packet+DoubleWordPacket(spell.serial)+"1F2D0000"+BytePacket(spellid)+"0048007D"+
        DoubleWordPacket(spellbook.serial)+"0000";
    EndForEach

    SysLog(packet);
    SendPacket(who, packet);
  EndIf
EndFunction

///////////////////////////////////////////
// TestPolCore - Testet PolCore ausgiebig
///////////////////////////////////////////

Function TestPolCore(who)
  SysLog("PolCore - ALL_SCRIPTS");

  ForEach script in (polcore().all_scripts)
    SysLog("Name          "+script.name);
    SysLog("Call_Depth    "+script.call_depth);
    SysLog("Consec_Cycles "+script.consec_cycles);
    SysLog("Globals       "+script.globals);
    SysLog("Instr_Cycles  "+script.instr_cycles);
    SysLog("Num_Globals   "+script.num_globals);
    SysLog("PC            "+script.pc);
    SysLog("PID           "+script.pid);
    SysLog("Sleep_Cycles  "+script.sleep_cycles);
    SysLog("State         "+script.state);
    SysLog("Var_Size      "+script.var_size);
  EndForEach
EndFunction

////////////////////////////////////////////////////
// ListScriptCycles - Listet die Script Cycles auf
////////////////////////////////////////////////////

Function ListScriptCycles(who)
  Var min_consec_cycles:=0x7fffffff;
  Var min_instr_cycles:=0x7fffffff;
  Var min_sleep_cycles:=0x7fffffff;
  Var max_consec_cycles:=0;
  Var max_instr_cycles:=0;
  Var max_sleep_cycles:=0;

  SysLog("  X Y Z Consec Instr Sleep Serial Template Script Place");

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC))
      Var script:=npc.process;

      If (script.name)
        If (min_consec_cycles>script.consec_cycles)
          min_consec_cycles:=script.consec_cycles;
        EndIf
        If (max_consec_cycles<script.consec_cycles)
          max_consec_cycles:=script.consec_cycles;
        EndIf

        If (min_instr_cycles>script.instr_cycles)
          min_instr_cycles:=script.instr_cycles;
        EndIf
        If (max_instr_cycles<script.instr_cycles)
          max_instr_cycles:=script.instr_cycles;
        EndIf

        If (min_sleep_cycles>script.sleep_cycles)
          min_sleep_cycles:=script.sleep_cycles;
        EndIf
        If (max_sleep_cycles<script.sleep_cycles)
          max_sleep_cycles:=script.sleep_cycles;
        EndIf

        SysLog("  "+npc.x+" "+npc.y+" "+npc.z+" "+script.consec_cycles+" "+script.instr_cycles+" "+
          script.sleep_cycles+" "+Lower(Hex(npc.serial))+" "+npc.npctemplate+" "+script.name+" "+PlaceName(npc));
      EndIf
    EndIf
  EndForEach

  SysLog("  Consec_Cycles ["+min_consec_cycles+"] ["+max_consec_cycles+"]");
  SysLog("  Instr_Cycles  ["+min_instr_cycles +"] ["+max_instr_cycles +"]");
  SysLog("  Sleep_Cycles  ["+min_sleep_cycles +"] ["+max_sleep_cycles +"]");
EndFunction

/////////////////////////////////////////////////////////////
// LogRunAwayProblems - Ueberwacht RunAway-Scripts bei NPCs
/////////////////////////////////////////////////////////////

Function LogRunAwayProblems()
  Var script;

  While (1)
    ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (npc.isa(POLCLASS_NPC))
        script:=npc.process;
        If (script.name=="enticedanimal")
          SysLog("NPC "+npc.name+" ("+Lower(Hex(npc.serial))+" / "+npc.x+", "+npc.y+") = "+
            script.instr_cycles+", "+script.consec_cycles+", "+script.sleep_cycles);
        EndIf
      EndIf

      SleepMS(2);
    EndForEach

    Sleep(300);
  EndWhile
EndFunction

/////////////////////////////////////////////////////////
// TestCheckSkill - Ueberprueft die Funktion CheckSkill
/////////////////////////////////////////////////////////
//
// skillid initvalue points mindifficulty maxdifficulty

Function TestCheckSkill(who, params)
  params:=SplitWords(params);

  Var difficulty;
  For (difficulty:=CInt(params[4]); difficulty<=CInt(params[5]); difficulty:=difficulty+1)

    Var diffcounter:=0;
    Var alt;
    Var neu;

    Var index;
    For (index:=1; index<=10; index:=index+1);
     // SetSkillPergon(who, CInt(params[1]), CInt(params[2]));
      SetSkillPergon(who, CInt(params[1]), difficulty);

      Var counter:=0;
      alt:=GetRawSkillPergon(who, CInt(params[1]));

     // While ((CheckSkillPergon(who, CInt(params[1]), difficulty, CInt(params[3]))=0) And (counter<100))
      While ((CheckSkillPergon(who, CInt(params[1]), CInt(params[2]), CInt(params[3]))=0) And (counter<100))
        counter:=counter+1;diffcounter:=diffcounter+1;
      EndWhile
      neu:=GetRawSkillPergon(who, CInt(params[1]));
    EndFor

    SysLog("["+difficulty+" "+(diffcounter/10)+"] = "+neu+" "+alt+" "+
      (((neu-alt)*8.0)/CInt(params[3]))+" "+CInt(params[3]));
  EndFor
EndFunction

    // Doku zu polcore {{{
    // + polcore().all_scripts                   ro (Array) <appobj>
    // +   globals, var_size, num_globals, call_depth, PC, consec_cycles, sleep_cycles, instr_cycles, state, pid
    // +   name
    // # polcore().bytes_received                ro
    // # polcore().bytes_sent                    ro
    // # polcore().combat_operations_per_min     ro
    // # polcore().compiledate                   ro (String)
    // # polcore().compiletime                   ro (String)
    // + polcore().events_per_min                ro
    // + polcore().instr_percent
    // + polcore().instr_per_invoc
    // + polcore().instr
    // + polcore().instr_per_min                 ro
    // ? polcore().invocations
    // + polcore().iostats                       ro (Array)
    // # polcore().itemcount                     ro
    // #   log_profile( clear )
    // # polcore().mobilecount                   ro
    // # polcore().packages                      ro (Array)
    // # polcore().priority_divide               ro
    // + polcore().queued_iostats                ro (Array)
    // # polcore().running_scripts               ro (Array) <appobj>
    // #   returns an array of structures { name, instr_cycles, consec_cycles, PC, call_depth, num_globals },
    // #   one element per running script.  See scripts/www/running_scripts.src
    // # polcore().script_profiles               ro (Array)
    // #   returns array of { name, instr, invocations, instr_per_invoc, instr_percent }
    // #   - same data as output by .log_profile
    // # polcore().skill_checks_per_min          ro
    // # polcore().sysload                       ro
    // #   sysload: system load, 0-100
    // + polcore().sysload_severity              ro
    // + polcore().systime                       ro
    // # polcore().uptime                        ro
    // #   uptime:  system uptime in seconds
    // # polcore().version                       ro
    // # polcore().verstr                        ro (String)
    //
    // # polcore().clear_script_profile_counters    -> Methode
    // # polcore().log_profile                      -> Methode
    // # polcore().set_priority_divide              -> Methode

    // gonzo's backpack... unmovable zeux }}}

///////////////////////////////////////////////////////////////////
// SellableItemCleanUp - Verkaufbares Item aus der Welt entfernen
///////////////////////////////////////////////////////////////////
//
// Items in der Welt / Items.txt -> 0x40000000..
//   ListObjectsInBox(x1, y1, z1, x2, y2, z2);   -> Items
//
// NPC-Equipment
//   ListAccounts();                             -> Player-Account
//   FindAccount(acctname);                      -> Player
//   ListEquippedItems(who);                       -> Klamotten
//   FindObjtypeInContainer(container, objtype);   -> Backpack durchsuchen
//   FindStorageArea(areaname);                    -> Bankbox
//   ListObjectsInBox(x1, y1, z1, x2, y2, z2);   -> NPC
//   ListEquippedItems(who);                       -> Klamotten
//   FindObjtypeInContainer(container, objtype);   -> Backpack durchsuchen
//   FindStorageArea(areaname);                    -> Bankbox
//
// Storage
//   STORAGE_MERCHANT
//     serial+" FS"
//     serial+" PB"
//     serial+" 1C"
//   STORAGE_KEYRINGS
//     ST_PREF_KEYRINGS+Hex(0x58CC1)
//   STORAGE_BANK
//     ST_PREF_BANK+serial

Function SellableItemCleanUp()
  Var count:=0;

  SysLog("SellableItemCleanUp gestartet...");
  ForEach objtype in {0x7030}
    SysLog("  ObjType "+Hex(objtype));

  EndForEach
EndFunction

////////////////////////////////////////////////////
// ListNPCTemplates - Listet alle NPCTemplates auf
////////////////////////////////////////////////////

Function ListNPCTemplates()
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    Var datafile:=CreateDataFile("NPCTemplates", DF_KEYTYPE_STRING);
    If (datafile)
      Var template;
      Var elem;

      ForEach templatename in GetConfigStringKeys(npcdesc)
        template:=npcdesc[templatename];

        If (!(template.objtype in {0x190, 0x191}))
          elem:=datafile.createelement(templatename);
          elem.setprop("Name", template.name);
          elem.setprop("Script", template.script);
          elem.setprop("ObjType", template.objtype);
          elem.setprop("Color", template.color);
          elem.setprop("ZaehmSkill", template.zaehmskill);
          elem.setprop("AbrichtSkill", template.abrichtskill);
        EndIf
      EndForEach

      UnloadDataFile("NPCTemplates");
    EndIf

    datafile:=CreateDataFile("NPCTemplatesHuman", DF_KEYTYPE_STRING);
    If (datafile)
      Var template;
      Var elem;

      ForEach templatename in GetConfigStringKeys(npcdesc)
        template:=npcdesc[templatename];

        If (template.objtype in {0x190, 0x191})
          elem:=datafile.createelement(templatename);
          elem.setprop("Name", template.name);
          elem.setprop("Script", template.script);
          elem.setprop("ObjType", template.objtype);
          elem.setprop("Color", template.color);
          elem.setprop("ZaehmSkill", template.zaehmskill);
          elem.setprop("AbrichtSkill", template.abrichtskill);
        EndIf
      EndForEach

      UnloadDataFile("NPCTemplatesHuman");
    EndIf
  EndIf
EndFunction

/////////////////////////////////////////////////////////
// ListNPCTemplatesExcel - Listet alle NPCTemplates auf
/////////////////////////////////////////////////////////

Function ListNPCTemplatesExcel()
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    LogToFile("log/npctemplates.log", "Name;NPCTemplate;ObjType;Color;TrueColor;Str;Int;Dex;Hits;Mana;Stam;Speed;Damage;AttackSkill;"+
      "Tactics;Anatomy;AttackAttribute;MaxHP;AR;HitSound;MissSound;Magery;MagicRes;PoisonRes;FireRes;WaterRes;EarthRes;AirRes;Alignment");

    ForEach templatename in GetConfigStringKeys(npcdesc)
      Var template:=npcdesc[templatename];

      Var magicresistance:="";
      If (template.magicresistance)
        magicresistance:=template.magicresistance;
      EndIf
      Var poisonresistance:="";
      If (template.poisonresistance)
        poisonresistance:=template.poisonresistance;
      EndIf
      Var fireresistance:="";
      If (template.fireresistance)
        fireresistance:=template.fireresistance;
      EndIf
      Var waterresistance:="";
      If (template.waterresistance)
        waterresistance:=template.waterresistance;
      EndIf
      Var earthresistance:="";
      If (template.earthresistance)
        earthresistance:=template.earthresistance;
      EndIf
      Var airresistance:="";
      If (template.airresistance)
        airresistance:=template.airresistance;
      EndIf

      Var attackhitsound:="";
      If (template.attackhitsound)
        attackhitsound:=Lower(Hex(template.attackhitsound));
      EndIf
      Var attackmisssound:="";
      If (template.attackmisssound)
        attackmisssound:=Lower(Hex(template.attackmisssound));
      EndIf

      Var alignment:="neutral";
      If (template.alignment)
        alignment:=template.alignment;
      EndIf

      Var anatomy:=0;
      If (template.anatomy)
        anatomy:=template.anatomy;
      EndIf
      Var tactics:=0;
      If (template.tactics)
        tactics:=template.tactics;
      EndIf
      Var magery:="";
      If (template.magery)
        magery:=template.magery;
      EndIf

      LogToFile("log/npctemplates.log", template.name+";"+templatename+";"+Lower(Hex(template.objtype))+";"+template.color+";"+
        template.truecolor+";"+template.str+";"+template.int+";"+template.dex+";"+template.hits+";"+template.mana+";"+template.stam+";"+
        template.attackspeed+";"+template.attackdamage+";"+GetConfigInt(template, template.attackattribute)+";"+tactics+";"+anatomy+";"+
        template.attackattribute+";"+template.maxhp+";"+template.ar+";"+attackhitsound+";"+attackmisssound+";"+magery+";"+
        magicresistance+";"+poisonresistance+";"+fireresistance+";"+waterresistance+";"+earthresistance+";"+airresistance+";"+alignment);
    EndForEach

    LogToFile("log/npctemplates.log", "");
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////////////////
// FindWeaponLessNPCTemplates - Listet alle NPCTemplates ohne Waffeneintraege auf
///////////////////////////////////////////////////////////////////////////////////

Function FindWeaponLessNPCTemplates()
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    SysLog("NPCTemplate;Name;AttackSpeed;AttackDamage;AttackAttribute;AttackHitSound;AttackMissSound;AttackHitScript");

    ForEach templatename in GetConfigStringKeys(npcdesc)
      Var template:=npcdesc[templatename];

      SysLog(templatename+";"+template.name+";"+template.attackspeed+";"+template.attackdamage+";"+template.attackattribute+";"+
        template.attackhitsound+";"+template.attackmisssound+";"+template.attackhitscript);
    EndForEach
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////
// ListNPCEquipTemplatesExcel - Listet alle NPCTemplates inkl. Equip-Props auf
////////////////////////////////////////////////////////////////////////////////

Function ListNPCEquipTemplatesExcel()
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    LogToFile("log/npctemplates.log", "Name;NPCTemplate;ObjType;Color;Script;Equip");

    ForEach templatename in GetConfigStringKeys(npcdesc)
      Var template:=npcdesc[templatename];
      Var equipt:="";

      ForEach cprop in GetConfigStringArray(template, "cprop")
        cprop:=SplitWords(cprop);
        If (Lower(cprop[1])=="equipt")
          cprop[2][1, 1]:="";
          equipt:=cprop[2];
        EndIf
      EndForEach

      Var color:="";
      If (template.color)
        color:=template.color;
      EndIf

      LogToFile("log/npctemplates.log", template.name+";"+templatename+";"+Lower(Hex(template.objtype))+";"+color+";"+template.script+";"+equipt);
    EndForEach

    LogToFile("log/npctemplates.log", "");
  EndIf
EndFunction

//////////////////////////////////////////////////////
// EmptyMerchantStorage - Leert den Haendler-Storage
//////////////////////////////////////////////////////

Function EmptyMerchantStorage(who)
  Var storagearea:=FindStorageArea(STORAGE_MERCHANT);
  If (storagearea)
    Var items:=0;
    Var npcs:=0;

    ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (npc.isa(POLCLASS_NPC))
        If (npc.script in {"barber", "clericmerchant", "daves_healer", "magemerchant", "merchant",
                           "moonstonemerchant", "necromerchant", "stamaster", "trainer", "turkey"})
          ForEach item in EnumerateItemsInContainer(FindRootItemInStorageArea(storagearea, npc.serial+" FS"))
            DestroyItem(item);
            items:=items+1;
          EndForEach

          ForEach item in EnumerateItemsInContainer(FindRootItemInStorageArea(storagearea, npc.serial+" PB"))
            DestroyItem(item);
            items:=items+1;
          EndForEach

          ForEach item in EnumerateItemsInContainer(FindRootItemInStorageArea(storagearea, npc.serial+" 1C"))
            DestroyItem(item);
            items:=items+1;
          EndForEach

          ForEach item in EnumerateItemsInContainer(FindRootItemInStorageArea(storagearea, npc.serial+" FS Magic"))
            DestroyItem(item);
            items:=items+1;
          EndForEach

          ForEach item in EnumerateItemsInContainer(npc.backpack)
            DestroyItem(item);
            items:=items+1;
          EndForEach

          npcs:=npcs+1;
        EndIf
      EndIf
    EndForEach

    SendSysMessagePergon(who, "Es wurden "+items+" Items bei "+npcs+" NPCs geloescht.", "");
  Else
    SendSysMessagePergon(who, STORAGE_MERCHANT+" konnte nicht geoeffnet werden!", "");
  EndIf
EndFunction

//////////////////////////////////////////////////////
// DeleteAncientCharacter - Loescht antike Character
//////////////////////////////////////////////////////

Function DeleteAncientCharacter(who)
  SysLog("Accounts/Character-Statistik ('antik')");
  Var zahlen:=CountInActiveCharacters(0, ANCIENT_TIME, 1); // Findet und loescht antike Character
  SysLog("Accounts/Character-Statistik ('antik' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" antike Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" antike Character, davon "+zahlen[9]+" mit CommandLevel.");

  FindLonelyCharacterNPCs(1); // Sucht verlasse NPCs von Charactern
EndFunction

///////////////////////////////////////////////////////
// SaveRemovedBankboxes - Rettet zerstoerte Bankboxen
///////////////////////////////////////////////////////

Function SaveRemovedBankboxes(who, banktotransfer)
  Var transferarea:=FindStorageArea("Transfer Bank");
  If (!transferarea)
    transferarea:=CreateStorageArea("Transfer Bank");
  EndIf
  Var transfer2area:=FindStorageArea("Transfer2 Bank");
  If (!transfer2area)
    transfer2area:=CreateStorageArea("Transfer2 Bank");
  EndIf
  Var bankarea:=FindStorageArea(STORAGE_BANK);

  If (transferarea And transfer2area And bankarea)
    ForEach accountname in ListAccounts()
      Var account:=FindAccount(accountname);
      If (account)
        Var charnummer;
        For (charnummer:=2; charnummer<=5; charnummer:=charnummer+1)
          Var char:=account.getcharacter(charnummer);
          If (char)
            SysLog("  Account '"+accountname+"' / Player "+Hex(char.serial)+" ["+char.serial+"] "+char.name);

            If (banktotransfer)
              Var bankbox:=FindRootItemInStorageArea(bankarea, ST_PREF_BANK+char.serial);
              If (bankbox)
                Var transferbox:=FindRootItemInStorageArea(transferarea, "Bankbox of "+char.serial);
                If (!transferbox)
                  transferbox:=CreateRootItemInStorageArea(transferarea, "Bankbox of "+char.serial, UOBJ_BANKBOX);
                EndIf
                Var transfer2box:=FindRootItemInStorageArea(transfer2area, "Bankbox of "+char.serial);
                If (!transfer2box)
                  transfer2box:=CreateRootItemInStorageArea(transfer2area, "Bankbox of "+char.serial, UOBJ_BANKBOX);
                EndIf

                If (transferbox And transfer2box)
                  ForEach item in EnumerateItemsInContainer(bankbox)
                    If (!MoveItemToContainer(item, transferbox))
                      If (!MoveItemToContainer(item, transfer2box))
                        SysLog("    Der Gegenstand "+item.desc+" konnte nicht verschoben werden!");
                      EndIf
                    EndIf
                  EndForEach
                Else
                  SysLog("    Es konnte keine Transferbox angelegt werden!");
                EndIf
              Else
                SysLog("    Es wurde keine Bankbox gefunden!");
              EndIf
            Else
              Var transferbox:=FindRootItemInStorageArea(transferarea, "Bankbox of "+char.serial);
              Var transfer2box:=FindRootItemInStorageArea(transfer2area, "Bankbox of "+char.serial);
              If (transferbox And transfer2box)
                Var bankbox:=FindRootItemInStorageArea(bankarea, ST_PREF_BANK+char.serial);
                If (!bankbox)
                  bankbox:=CreateRootItemInStorageArea(bankarea, ST_PREF_BANK+char.serial, UOBJ_BANKBOX);
                EndIf

                If (bankbox)
                  ForEach item in EnumerateItemsInContainer(transferbox)
                    If (!MoveItemToContainer(item, bankbox))
                      SysLog("    Der Gegenstand "+item.desc+" konnte nicht verschoben werden!");
                    EndIf
                  EndForEach
                  ForEach item in EnumerateItemsInContainer(transfer2box)
                    If (!MoveItemToContainer(item, bankbox))
                      SysLog("    Der Gegenstand "+item.desc+" konnte nicht verschoben werden!");
                    EndIf
                  EndForEach

                 // DestroyRootItemInStorageArea(transferarea, ST_PREF_BANK+char.serial);
                Else
                  SysLog("    Es konnte keine Bankbox angelegt werden!");
                EndIf
              Else
                SysLog("    Es wurde keine Transferbox gefunden!");
              EndIf
            EndIf
          EndIf
        EndFor
      Else
        SysLog("  '"+accountname+"' gibt es nicht !");
      EndIf
    EndForEach
  Else
    SendSysMessagePergon(who, "Transfer-, Transfer2- und BankArea konnten nicht geoeffnet werden!", "");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////
// CheckContainerSetup - Ueberprueft MaxItems und MaxWeight
/////////////////////////////////////////////////////////////

Function CheckContainerSetup(who)
  SendSysMessagePergon(who, "Waehlt einen Container zum Testen aus!", "");

  Var template:=Target(who);
  If (template.isa(POLCLASS_CONTAINER))
    Var container:=CreateItemAtlocationPergon(who.x+1, who.y, who.z, template.objtype, 1);
    If (container)
      Var count:=0;
      Var item;

      container:=CreateItemInContainerPergon(container, 0x0e76, 1);
      While (container)
        count:=count+1;
        item:=CreateItemInContainerPergon(container, 0x20ff, 1);
        While (item)
          count:=count+1;
          item:=CreateItemInContainerPergon(container, 0x20ff, 1);
        EndWhile

        DestroyItem(item);
        container:=CreateItemInContainerPergon(container, 0x0e76, 1);
      EndWhile

      SendSysMessagePergon(who, "Es wurden "+count+" Items erzeugt!", "");
     // DestroyItem(container);
    Else
      SendSysMessagePergon(who, "Der Container fuer den MaxItem-Test konnte nicht erzeugt werden!", "");
    EndIf

    container:=CreateItemAtlocationPergon(who.x-1, who.y, who.z, template.objtype, 1);
    If (container)
      Var count:=0;
      Var item;

      container:=CreateItemInContainerPergon(container, 0x0e76, 1);
      While (container)
        count:=count+1;
        item:=CreateItemInContainerPergon(container, 0x352f, 1);
        While (item)
          count:=count+1;
          item:=CreateItemInContainerPergon(container, 0x352f, 1);
        EndWhile

        DestroyItem(item);
        container:=CreateItemInContainerPergon(container, 0x0e76, 1);
      EndWhile

      SendSysMessagePergon(who, "Es wurden "+count+" Items erzeugt!", "");
     // DestroyItem(container);
    Else
      SendSysMessagePergon(who, "Der Container fuer den MaxWeight-Test konnte nicht erzeugt werden!", "");
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

//////////////////////////////////////////////////////////
// TestPol094Functionality - Neue Funktionen durchtesten
//////////////////////////////////////////////////////////
//
// Vitals und Stats sind komplett getrennt, d.h. beide, auf den ersten
// Blick zusammengehörende, Werte bewegen sich ausschließlich innerhalb
// ihrer eigenen Grenzen. Somit kann jeweils das eine oder auch das andere
// groesser sein... ergo: die Forderung aus dem Konzept ist machbar.
//
// Vitals
//  + GetVitalMaximumValue          100 .. 10000000     [0,01 Punkte]            =>    1,00..100000,00
//  + GetVitalRegenRate          -30000 .. 30000        [0,01 Punkte pro Minute] => -300,00..300,00
//  + GetVital                        0 .. MaximumValue [0,01 Punkte]            =>    1,00..100000,00
//  + SetVital                        0 .. MaximumValue [0,01 Punkte]            =>    1,00..100000,00
//   ConsumeVital                    0 .. MaximumValue [0,01 Punkte]            =>    1,00..100000,00
//  + RecalcVitals
//
// Attribute
//  + SetAttributeBaseValue           0 .. 60000        [0,1  Punkte]            =>     0,0..6000,0
//  + SetAttributeTemporaryMod   -30000 .. 30000        [0,1  Punkte]            => -3000,0..3000,0
//  + GetAttribute                    0 .. 9000         [1    Punkt]             =>       0..9000
//  - GetAttributeBaseValue           0 .. 60000        [0,1  Punkte]            =>     0,0..6000,0
//  - GetAttributeIntrinsicMod        0 .. 0            [0    Punkte]            =>       0..0
//  + GetAttributeTemporaryMod   -30000 .. 30000        [0,1  Punkte]            => -3000,0..3000,0
//
// Skills verhalten sich wie die Attribute
//   SetAttributeBaseValue           0 .. 60000        [0,1  Punkte]            =>     0,0..6000,0
//   SetAttributeTemporaryMod   -30000 .. 30000        [0,1  Punkte]            => -3000,0..3000,0
//   GetAttribute                    0 .. 9000         [1    Punkt]             =>       0..9000
//   GetAttributeBaseValue           0 .. 60000        [0,1  Punkte]            =>     0,0..6000,0
//   GetAttributeIntrinsicMod        0 .. 0            [0    Punkte]            =>       0..0
//   GetAttributeTemporaryMod   -30000 .. 30000        [0,1  Punkte]            => -3000,0..3000,0

Function TestPol094Functionality(who)
 // SetVital(who, VITALID_MANA,        0);    SysLog("  SetVital    (       0) = "+GetVital(who, VITALID_MANA));
 // SetVital(who, VITALID_MANA,       10);    SysLog("  SetVital    (      10) = "+GetVital(who, VITALID_MANA));
 // SetVital(who, VITALID_MANA, 10000000);    SysLog("  SetVital    (10000000) = "+GetVital(who, VITALID_MANA));
 // SetVital(who, VITALID_MANA, 10000001);    SysLog("  SetVital    (10000001) = "+GetVital(who, VITALID_MANA));
 // ConsumeVital(who, VITALID_MANA, 10000000);SysLog("  ConsumeVital(      23) = "+GetVital(who, VITALID_MANA));
 // SetVital(who, VITALID_MANA, 10000000);    SysLog("  SetVital    (10000000) = "+GetVital(who, VITALID_MANA));
 // SysLog("");

  // Stats
 // SetAttributeBaseValue(who, ATTRIBUTEID_INTELLIGENCE,    60000);                   //      0..60000 [0,1 Punkte]
 // SetAttributeTemporaryMod(who, ATTRIBUTEID_INTELLIGENCE, 30000);                   // -30000..30000 [0,1 Punkte]
 // SysLog("  SetAttributeValue");
 // SysLog("    Get     = "+            GetAttribute(who, ATTRIBUTEID_INTELLIGENCE)); //      0.. 9000 [1   Punkt]
 // SysLog("    GetBase = "+   GetAttributeBaseValue(who, ATTRIBUTEID_INTELLIGENCE)); //      0..60000 [0,1 Punkte]
 // SysLog("    GetIntr = "+GetAttributeIntrinsicMod(who, ATTRIBUTEID_INTELLIGENCE)); //      0..    0 [0   Punkte]
 // SysLog("    GetMod  = "+GetAttributeTemporaryMod(who, ATTRIBUTEID_INTELLIGENCE)); // -30000..30000 [0,1 Punkte]
 // RecalcVitals(who);
 //
 // SetVital(who, VITALID_MANA, 60000);SysLog("  SetVital    (60000) = "+GetVital(who, VITALID_MANA));
 // RecalcVitals(who);

 // Attribute (Skills)
  SetAttributeBaseValue(who, SKILLID_ALCHEMIE,    60000);                   //      0..60000 [0,1 Punkte]
  SetAttributeTemporaryMod(who, SKILLID_ALCHEMIE, 30000);                   // -30000..30000 [0,1 Punkte]
  SysLog("  SetAttributeValue");
  SysLog("    Get     = "+            GetAttribute(who, SKILLID_ALCHEMIE)); //      0.. 9000 [1   Punkt]
  SysLog("    GetBase = "+   GetAttributeBaseValue(who, SKILLID_ALCHEMIE)); //      0..60000 [0,1 Punkte]
 // SysLog("    GetIntr = "+GetAttributeIntrinsicMod(who, SKILLID_ALCHEMIE)); //      0..    0 [0   Punkte]
  SysLog("    GetMod  = "+GetAttributeTemporaryMod(who, SKILLID_ALCHEMIE)); // -30000..30000 [0,1 Punkte]

  // Vitals
 // SysLog("  Life        = "+GetVital(who, VITALID_LIFE));
 // SysLog("  Mana      = "+GetVital(who, VITALID_MANA));
 // SysLog("  Stamina     = "+GetVital(who, VITALID_STAMINA));
 // SysLog("  MaxLife     = "+GetVitalMaximumValue(who, VITALID_LIFE));
 // SysLog("  MaxMana   = "+GetVitalMaximumValue(who, VITALID_MANA));
 // SysLog("  MaxStamina  = "+GetVitalMaximumValue(who, VITALID_STAMINA));
 // SysLog("  RegeLife    = "+GetVitalRegenRate(who, VITALID_LIFE));
 // SysLog("  RegeMana  = "+GetVitalRegenRate(who, VITALID_MANA));
 // SysLog("  RegeStamina = "+GetVitalRegenRate(who, VITALID_STAMINA));
 // RecalcVitals(who);

 // SysLog("  MaxLife    = "+GetVitalMaximumValue(who, VITALID_LIFE));
 // SetVital(who, VITALID_LIFE, GetVitalMaximumValue(who, VITALID_LIFE)*5);
 // SysLog("  Life    = "+GetVital(who, VITALID_LIFE));

 // SetAttributeTemporaryMod(who, ATTRIBUTEID_STRENGTH, tempmod);
EndFunction

/////////////////////////////////////////////////////
// Check_Dmg_Mod - Ueberpruefe die Property Dmg_Mod
/////////////////////////////////////////////////////

Function Check_Dmg_Mod(who)
  SendSysMessagePergon(who, "Bitte Waffe oder Ruestung anklicken!", "");
  Var item:=Target(who);

  If (item.isa(POLCLASS_WEAPON))
    SysLog("item.desc      = "+item.desc);
    SysLog("  item.dmg_mod = "+item.dmg_mod);

    If (item.dmg_mod=0)
      item.dmg_mod:=100;
    Else
      item.dmg_mod:=0;
    EndIf

    SysLog("  item.dmg_mod = "+item.dmg_mod);
  ElseIf (item.isa(POLCLASS_ARMOR))
    SysLog("item.desc     = "+item.desc);
    SysLog("  item.ar_mod = "+item.ar_mod);

    If (item.ar_mod=0)
      item.ar_mod:=100;
    Else
      item.ar_mod:=0;
    EndIf

    SysLog("  item.ar_mod = "+item.ar_mod);
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////
// TestUsedPol094Functionality - Neue Funktionen durchtesten
//////////////////////////////////////////////////////////////

Function TestUsedPol094Functionality(who)
  SendSysMessagePergon(who, "NPC anklicken, oder abbrechen!", "");

  Var mobile:=Target(who);
  If (!mobile)
    mobile:=who;
  EndIf

  SysLog("Getestet wird "+mobile.name);

 // Var mod:=3000;
 // TestUsedPol094FunctionalityStat(mobile,    0, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,    1, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,   -1, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,   58, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,  100, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,  208, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,  209, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,  210, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 6000, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 5999, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 6001, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 9000, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 8999, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 9001, mod, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,     0, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,    -1, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0, -3001, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0, -3000, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,     2, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,  2999, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,  3001, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile, 0,  3000, ATTRIBUTEID_DEXTERITY);
 // TestUsedPol094FunctionalityStat(mobile,   2, 0, ATTRIBUTEID_DEXTERITY,         204);
 // TestUsedPol094FunctionalityStat(mobile,   0, 0, ATTRIBUTEID_DEXTERITY,         205);
 // TestUsedPol094FunctionalityStat(mobile, 200, 0, ATTRIBUTEID_DEXTERITY,     -700000);
 // TestUsedPol094FunctionalityStat(mobile,   0, 0, ATTRIBUTEID_DEXTERITY,  0x7fffffff);
 // TestUsedPol094FunctionalityStat(mobile,   2, 0, ATTRIBUTEID_DEXTERITY, -0x7fffffff);
 //
 // TestUsedPol094FunctionalityStat(mobile,    0,    1);
 // TestUsedPol094FunctionalityStat(mobile,   -1, 9001);
 // TestUsedPol094FunctionalityStat(mobile,    1, 9001);
 // TestUsedPol094FunctionalityStat(mobile, 9001, 9001);
 // TestUsedPol094FunctionalityStat(mobile,  210, 9001);
 // TestUsedPol094FunctionalityStat(mobile,  209, 9001);
 //
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,   10);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,   -1);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,    0);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,  210);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE, 6000);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE, 6001);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE, 9000);
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,  20.9);
 //
 // TestUsedPol094FunctionalityStat(mobile, SKILLID_WILDNISKUNDE,  1, 613, 2);
EndFunction

Function TestUsedPol094FunctionalityStat(mobile, skillid, value, value2, points)
 // Var result:=1;
 //
 // SysLog(mod);SetDexModPergon(mobile, mod);GetDexModPergon(mobile);
 // SysLog(value);SetDexPergon(mobile, value);GetDexPergon(mobile);
 // SysLog(GetObjProperty(mobile, ATTRIBUTEWERTKENNUNG+statid));
 //
 // SetStrModPergon(mobile, mod);SetIntModPergon(mobile, mod);
 // If ((GetDexModPergon(mobile)<>GetStrModPergon(mobile)) Or (GetDexModPergon(mobile)<>GetIntModPergon(mobile)))
 //   result:=0;
 // EndIf
 // SetStrPergon(mobile, value);SetIntPergon(mobile, value);
 // If ((GetDexPergon(mobile)<>GetStrPergon(mobile)) Or (GetDexPergon(mobile)<>GetIntPergon(mobile)))
 //   result:=0;
 // EndIf
 //
 // If (result)
 //   SysLog("Ok");
 // Else
 //   SysLog("FEHLER");
 // EndIf
 //
 // SysLog(value);SetDexModPergon(mobile, mod);SetDexPergon(mobile, value);
 // SysLog("Raw vorher  = "+GetObjProperty(mobile, ATTRIBUTEWERTKENNUNG+statid)+" / Base vorher  = "+GetDexPergon(mobile));
 // SysLog("result = "+AwardRawDexPergon(mobile, points));
 // SysLog("Raw nachher = "+GetObjProperty(mobile, ATTRIBUTEWERTKENNUNG+statid)+" / Base nachher = "+GetDexPergon(mobile));
 //
 // SetDexPergon(mobile, stat);SetStaminaPergon(mobile, value);
 // GetStaminaPergon(mobile);GetMaxStaminaPergon(mobile);GetStaminaRegenRatePergon(mobile);
 //
 // SetSkillPergon(mobile, skillid, value);
 // GetSkillPergon(mobile, skillid);
 // GetSkillFloatPergon(mobile, skillid);
 // GetRawSkillPergon(mobile, skillid);
 // SysLog(GetObjProperty(mobile, SKILLWERTKENNUNG+skillid));
 //
 // SysLog(CDbl(GetAttributeBaseValue(mobile, skillid)+GetAttributeTemporaryMod(mobile, skillid))/10);
 // SysLog(GetAttributeBaseValue(mobile, skillid));
 // SysLog(GetAttributeTemporaryMod(mobile, skillid));
 //
 // SetSkillPergon(mobile, skillid, value);
 // SetRawSkillPergon(mobile, skillid, value2);
 // GetSkillPergon(mobile, skillid);
 // AwardRawPointsPergon(mobile, skillid, points);
 // GetRawSkillPergon(mobile, skillid);
 // GetSkillPergon(mobile, skillid);
EndFunction

//////////////////////////////////////////////////
// TestGetObjPropertyNames - Testet die Funktion
//////////////////////////////////////////////////

Function TestGetObjPropertyNames(who)
  ForEach propertyname in GetObjPropertyNames(who)
    If (propertyname[1, 6]=="SkOld_")
      SysLog(propertyname);
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////////
// CreateMissingSpellbook - Erzeugt verlorene Zauberbuecher
/////////////////////////////////////////////////////////////

Function CreateMissingSpellbook()
  ForEach accountname in ListAccounts()
    If (accountname in {"Dusk"})
      Var account:=FindAccount(accountname);
      If (account)
        SysLog("Account: "+accountname);

        Var value;
        Case (accountname)
          "Dusk":
            Var char:=account.getcharacter(1);
            If (char)
              Var book:=CreateItemInBackpackPergon(char, UOBJ_SPELLBOOK, 1);
              If (book)
                book.newbie:=1;

                ForEach spellobjtype in {0x1f2e, 0x1f2f, 0x1f30, 0x1f32, 0x1f33, 0x1f34, 0x1f35, 0x1f36,
                    0x1f37, 0x1f38, 0x1f39, 0x1f3a, 0x1f3b, 0x1f3c, 0x1f3d, 0x1f3e, 0x1f3f, 0x1f40, 0x1f41,
                    0x1f42, 0x1f43, 0x1f44, 0x1f45, 0x1f46, 0x1f48, 0x1f4a, 0x1f4b, 0x1f4c, 0x1f4d, 0x1f4e,
                    0x1f4f, 0x1f50, 0x1f53, 0x1f54, 0x1f59}
                  CreateItemInContainerPergon(book, spellobjtype, 1);
                EndForEach
              EndIf
            EndIf
        EndCase
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////
// MakeNewbieItem - Macht Items zu Newbie-Items
/////////////////////////////////////////////////

Function MakeNewbieItem(items)
  Var count;

  ForEach accountname in ListAccounts();
    Var account:=FindAccount(accountname);
    If (account)
      count:=0;

      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          ForEach item In EnumerateItemsInContainer(char.backpack)
            If (item.objtype in items)
              item.newbie:=1;
              count:=count+1;
            EndIf
          EndForEach

          Var worldbank:=FindStorageArea(STORAGE_BANK);
          If (worldbank)
            Var bankbox:=FindRootItemInStorageArea(worldbank, ST_PREF_BANK+char.serial);
            If (bankbox)
              ForEach item In EnumerateItemsInContainer(bankbox)
                If (item.objtype in items)
                  item.newbie:=1;
                  count:=count+1;
                EndIf
              EndForEach
            EndIf
          EndIf
        EndIf
      EndFor

      If (count)
        SysLog("  Account: '"+accountname+"' ("+count+")");
      EndIf
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////////////////////////////////
// ListWeaponArmorCloth - Listet die Eigenschaften von Waffen, Ruestungen und Kleidung auf
////////////////////////////////////////////////////////////////////////////////////////////
//
// Waffe
//   ObjType               - ObjType                                             ([Hex]Zahl)
//   Name                  - Name                                                (String)
//   Desc                  - Beschreibung                                        (String)
//   Damage                - Schadensformel                                      (DiceRoll)
//   DamageSplitted        - Schadensformel (Min, Max, Durchschnitt)             (Zahlen)
//   Speed                 - Geschwindigkeit                                     (Zahl)
//   TwoHanded             - Zweihaender                                         (1 = Ja / 0 = Nein (default))
//   Weight                - Gewicht                                             (Zahl)
//   MaxHP                 - Max. HitPoints                                      (Zahl)
//   StrRequired           - Min. Staerke                                        (Zahl (default = 0))
//   SkillRequired         - Min. Skillwert                                      (Zahl (default = 0))
//   Attribute             - Skill[name]                                         (String)
//   BlocksCastingIfInHand - Casten verboten, wenn in der Hand gehalten?         (1 = Ja (default) / 0 = Nein)
//   BlockCircle           - Nur Sprueche mit Circle < BlockCircle sind castbar. (Zahl (default = kein Block))
//
// Ruestung
//   ObjType               - ObjType                                             ([Hex]Zahl)
//   Name                  - Name                                                (String)
//   Desc                  - Beschreibung                                        (String)
//   AR                    - Ruestungsstaerke                                    (Zahl)
//   Weight                - Gewicht                                             (Zahl)
//   MaxHP                 - Max. HitPoints                                      (Zahl)
//   StrRequired           - Min. Staerke                                        (Zahl (default = 0))
//   BlocksCastingIfInHand - Casten verboten, wenn in der Hand gehalten?         (1 = Ja (default) / 0 = Nein)
//   BlockCircle           - Nur Sprueche mit Circle < BlockCircle sind castbar. (Zahl (default = kein Block))
//
// Kleidung
//   ObjType               - ObjType                                             ([Hex]Zahl)
//   Name                  - Name                                                (String)
//   Desc                  - Beschreibung                                        (String)
//   Weight                - Gewicht                                             (Zahl)
//   StrRequired           - Min. Staerke                                        (Zahl (default = 0))
//   BlocksCastingIfInHand - Casten verboten, wenn in der Hand gehalten?         (1 = Ja (default) / 0 = Nein)
//   BlockCircle           - Nur Sprueche mit Circle < BlockCircle sind castbar. (Zahl (default = kein Block))

Function ListWeaponArmorCloth(who)
  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    Var blacksmithylist:=GetWeaponArmorProductList();

    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var itemdesc:=itemdesccfg[objtype];
      Var item:=CreateItemInBackpackPergon(who, CInt(objtype), 1);
      If (itemdesc And item)
        If (item.isa(POLCLASS_WEAPON)) // Waffe?
          Var damagesplitted:=GetDiceSplitted(itemdesc.damage);

          Var twohanded:="N";
          If (itemdesc.twohanded)
            twohanded:="J";
          EndIf

          Var strrequired:=0;
          If (itemdesc.strrequiredplayer)
            strrequired:=itemdesc.strrequiredplayer;
          EndIf

          Var skillrequired:=0;
          If (itemdesc.skillrequired)
            skillrequired:=itemdesc.skillrequired;
          EndIf

          Var blockscastingifinhand:=1;
          If (itemdesc.blockscastingifinhand==0)
            blockscastingifinhand:=0;
          EndIf

          Var blockcircle:="N";
          If (itemdesc.blockcircle)
            blockcircle:=itemdesc.blockcircle;
          EndIf

          Var attribute:="???";
          Case (item.attribute)
            SKILLID_AXTKAMPF:         attribute:="Axtkampf";
            SKILLID_INFANTERIEWAFFEN: attribute:="Infanteriewaffen";
            SKILLID_BOGENSCHIESSEN:   attribute:="Bogenschiessen";
            SKILLID_SCHWERTKAMPF:     attribute:="Schwertkampf";
            SKILLID_HIEBWAFFEN:       attribute:="Hiebwaffen";
            SKILLID_FECHTKUNST:       attribute:="Fechtkunst";
            SKILLID_FAUSTKAMPF:       attribute:="Fauskampf";
          EndCase

          SysLog("Weapon;"+Lower(Hex(item.objtype))+";"+itemdesc.name+";"+EntferneA(item.desc)+";"+itemdesc.damage+";"+
            damagesplitted[1]+";"+damagesplitted[2]+";"+damagesplitted[3]+";"+itemdesc.speed+";"+twohanded+";"+
            item.weight+";"+item.maxhp+";"+strrequired+";"+skillrequired+";"+attribute+";"+blockscastingifinhand+";"+
            blockcircle+GetWeaponArmorProductLogEntry(blacksmithylist, item.objtype));
        ElseIf (item.isa(POLCLASS_ARMOR)) // Ruestung?
          Var strrequired:=0;
          If (itemdesc.strrequiredplayer)
            strrequired:=itemdesc.strrequiredplayer;
          EndIf

          Var blockscastingifinhand:=1;
          If (itemdesc.blockscastingifinhand==0)
            blockscastingifinhand:=0;
          EndIf

          Var blockcircle:="N";
          If (itemdesc.blockcircle)
            blockcircle:=itemdesc.blockcircle;
          EndIf

          SysLog("Armor;"+Lower(Hex(item.objtype))+";"+itemdesc.name+";"+EntferneA(item.desc)+";"+item.ar+";"+item.weight+";"+item.maxhp+";"+
            strrequired+";"+blockscastingifinhand+";"+blockcircle+GetWeaponArmorProductLogEntry(blacksmithylist, item.objtype));
        ElseIf (item.layer) // Kann man das Item "anziehen"?
          Var strrequired:=0;
          If (itemdesc.strrequiredplayer)
            strrequired:=itemdesc.strrequiredplayer;
          EndIf

          Var blockscastingifinhand:=1;
          If (itemdesc.blockscastingifinhand==0)
            blockscastingifinhand:=0;
          EndIf

          Var blockcircle:="N";
          If (itemdesc.blockcircle)
            blockcircle:=itemdesc.blockcircle;
          EndIf

          SysLog("Kleidung;"+Lower(Hex(item.objtype))+";"+itemdesc.name+";"+EntferneA(item.desc)+";"+
            item.weight+";"+strrequired+";"+blockscastingifinhand+";"+blockcircle);
        EndIf

        DestroyItem(item);
      EndIf
    EndForEach

    CheckWeaponArmorProductList(blacksmithylist);
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////////////////////
// GetWeaponArmorProductList - Liefert die Liste der herstellbaren Waffen und Ruesten
///////////////////////////////////////////////////////////////////////////////////////

Function GetWeaponArmorProductList()
  Var list:=Dictionary;

  Var blacksmithy:=ReadConfigFile(":blacksmithy:blacksmithy");
  If (blacksmithy)
    ForEach objtype in GetConfigStringKeys(blacksmithy)
      If (objtype<>"blacksmithy") // Den Menueeintrag ignorieren
        If (CInt(objtype))
          Var entry:=blacksmithy[objtype];
          list[CInt(objtype)]:={entry.name, entry.desc, entry.type, entry.material, entry.skill};
        Else
          SysLog("FEHLER: Eintrag '"+objtype+"' in der blacksmithy.cfg ist ungueltig!");
        EndIf
      EndIf
    EndForEach

    SysLog(list);
  EndIf

  Return (list);
EndFunction

/////////////////////////////////////////////////////////////////////////////////////////////
// GetWeaponArmorProductLogEntry - Liefert zusaetzliche Eigenschaften der Waffe oder Rueste
/////////////////////////////////////////////////////////////////////////////////////////////

Function GetWeaponArmorProductLogEntry(ByRef list, objtype)
  If (list[CInt(objtype)])
    Var entry:=list[CInt(objtype)];
    Var logentry:=";"+entry[1]+";"+entry[2]+";"+entry[3]+";"+entry[4]+";"+entry[5];
    list[CInt(objtype)]:=0;

    Return (logentry);
  Else
    Return ("");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////////////
// CheckWeaponArmorProductList - Prueft die Liste der herstellbaren Waffen und Ruesten
////////////////////////////////////////////////////////////////////////////////////////

Function CheckWeaponArmorProductList(list)
  ForEach objtype in (list.keys())
    If (list[objtype])
      SysLog("FEHLER: Eintrag '"+objtype+"' in der blacksmithy.cfg ist keinem realen Item zugeordnet!");
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////////////////////
// CheckMiningOutput - Ermittelt die durchschnittlich geschuerften Erze
/////////////////////////////////////////////////////////////////////////

Function CheckMiningOutput(who)
  Start_ScriptPergon(":mining:mining_calc", who);
EndFunction

///////////////////////////////////////////////////////////
// ListDoorsLighting - Listet alle Tueren und Lichter auf
///////////////////////////////////////////////////////////

Function ListDoorsLighting(who)
  Var doors:={};
  Var lighting:={};

 // Var itemdesccfg:=ReadConfigFile("::itemdesc");
 // If (itemdesccfg)
 //   ForEach objtype in GetConfigStringKeys(itemdesccfg)
 //     Var itemdesc:=itemdesccfg[objtype];
 //     Var item:=CreateItemInBackpackPergon(who, CInt(objtype), 1);
 //     If (itemdesc And item)
 //       If (item.isa(POLCLASS_DOOR)) // Tuer?
 //         doors.append(Lower(Hex(item.objtype)));
 //       EndIf
 //
 //       DestroyItem(item);
 //     EndIf
 //   EndForEach
 // EndIf

  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var itemdesc:=GetItemDescriptor(objtype);
      If (itemdesc)
       // If (itemdesc.script)
       //   doors.append(Lower(Hex(objtype)));
       // EndIf
        If (itemdesc.objclass=="Door")
          doors.append(Lower(Hex(objtype)));
        EndIf
      EndIf
    EndForEach

    SysLog("  Doors ["+doors.size()+"]: "+doors);

    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var itemdesc:=GetItemDescriptor(objtype);
      If (itemdesc)
        If (Lower(itemdesc.script)=="change")
          lighting.append(Lower(Hex(objtype)));
        EndIf
      EndIf
    EndForEach

    SysLog("  Lighting ["+lighting.size()+"]: "+lighting);
  EndIf
EndFunction

///////////////////////////////////////////////////////////
// ListHouses - Listet die Eigenschaften von Haeusern auf
///////////////////////////////////////////////////////////

Function ListHouses(who)
  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    SysLog("ObjType;Beschreibung;V-Preis;A-Preis;Bretter;Staemme;Sandstein;Granit;Marmor;Lehm;Stroh;Tuecher;Barren;Leder;Kristall;Verankerungen;SecureConts");

    ForEach range in {{0x6019, 0x6026}, {0x6227, 0x6260}}
      For objtype:=range[1] To range[2]
        Var housedeed:=itemdesccfg[objtype];
        If (housedeed)
          SysLog(Lower(Hex(objtype))+";"+housedeed.desc+";"+housedeed.vendorsellsfor+";"+housedeed.vendorbuysfor+";"+
            housedeed.bretter+";"+housedeed.staemme+";"+housedeed.sandstein+";"+housedeed.granit+";"+housedeed.marmor+";"+
            housedeed.lehm+";"+housedeed.stroh+";"+housedeed.tuecher+";"+housedeed.barren+";"+housedeed.leder+";"+housedeed.kristall+";"+
            housedeed.numlockdowns+";"+housedeed.numsecure);
        EndIf
      EndFor
    EndForEach
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////
// GetDiceSplitted - Zerlegt den Dice-String (Min, Max, Durchschnitt)
///////////////////////////////////////////////////////////////////////

Function GetDiceSplitted(dice)
  dice["d"]:=" ";
  dice["+"]:=" ";
  dice:=SplitWords(dice);

  Return ({CInt(dice[1])+CInt(dice[3]), CInt(dice[1])*CInt(dice[2])+CInt(dice[3]),
    ((CInt(dice[1])*CInt(dice[2])+CInt(dice[3]))+(CInt(dice[1])+CInt(dice[3])))/2});
EndFunction

////////////////////////////////////////////////////////////////////////////////
// ListEquippableHandItems - Listet Items, die man in die Hand nehmen kann auf
////////////////////////////////////////////////////////////////////////////////

Function ListEquippableHandItems(who)
  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    Var objtype;
    For (objtype:=0; objtype<0x4000; objtype:=objtype+1)
      Var item:=CreateItemAtLocationPergon(who.x, who.y, who.z, objtype, 1);
      If (item)
        EquipItem(who, item);

        If ((item.layer=LAYER_HAND1) Or (item.layer=LAYER_HAND2))
          Var itemdesc:=itemdesccfg[objtype];
          If (itemdesc)
            SysLog("Item;"+CInt(item.objtype)+";"+Lower(Hex(item.objtype))+";"+
              EntferneA(itemdesc.name)+";"+EntferneA(item.desc)+";"+item.layer);
          Else
            SysLog("Item;"+CInt(item.objtype)+";"+Lower(Hex(item.objtype))+";;"+
              EntferneA(item.desc)+";"+item.layer);
          EndIf
        EndIf

        DestroyItem(item);
      EndIf
    EndFor

    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      If (CInt(objtype)>=0x4000)
        Var item:=CreateItemAtLocationPergon(who.x, who.y, who.z, CInt(objtype), 1);
        If (item)
          EquipItem(who, item);

          If ((item.layer=LAYER_HAND1) Or (item.layer=LAYER_HAND2))
            SysLog("Item;"+CInt(item.objtype)+";"+Lower(Hex(item.objtype))+";"+
              EntferneA(itemdesccfg[objtype].name)+";"+EntferneA(item.desc)+";"+item.layer);
          EndIf

          DestroyItem(item);
        EndIf
      EndIf
    EndForEach
  EndIf
EndFunction

///////////////////////////////////////////////////////
// ListAllEquippedItems - Zeigt alle angelegten Items
///////////////////////////////////////////////////////

Function ListAllEquippedItems(who)
  ForEach item in ListEquippedItems(who)
    SysLog("  Equip: Layer "+item.layer+", "+Hex(item.objtype)+", "+item.desc);
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////
// CheckReparableItems - Prueft, ob ein bestimmtes Item reparabel ist
///////////////////////////////////////////////////////////////////////

Function CheckReparableItems(who)
  Var reparabel:={};
  Var nicht_reparabel:={};

  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var item:=CreateItemAtLocationPergon(who.x, who.y, who.z, CInt(objtype), 1);
      If (item)
        If (item.isa(POLCLASS_ARMOR))
          If (IsReparabel(item))
            reparabel.append("Armor-Repair;"+Lower(Hex(item.objtype))+";"+EntferneA(itemdesccfg[objtype].name)+";"+EntferneA(item.desc));
          Else
            nicht_reparabel.append("Armor-NON-Repair;"+Lower(Hex(item.objtype))+";"+EntferneA(itemdesccfg[objtype].name)+";"+EntferneA(item.desc));
          EndIf
        EndIf

        DestroyItem(item);
      EndIf
    EndForEach
  EndIf

  // Geordnet ausgeben
  ForEach entry in reparabel
    SysLog("  "+entry);
  EndForEach
  ForEach entry in nicht_reparabel
    SysLog("  "+entry);
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// IsReparabel - Kann der Gegenstand repariert werden (abhaengig vom zusaetzlichen Serial-Check)? (siehe :crafting:repair)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Blocken:
//   alles was keine Armor ist (Waffen + Werkzeuge)
//   nur Platte/Helme/Schilde/Rindmail/Chainmail/beschlagenes Leder/Sonstiges

Function IsReparabel(item)
  If (item.serial<0x4102b988) // Shinigami: Neue Quality etc.pp. Werte... (23.03.2003)
    Return (0); // quasi antik
  ElseIf (item.serial<=0x472bcb33) // Commander: neue props, qualis usw. (ct-vergleich is doof) (28.01.2005)
    If (item.isa(POLCLASS_ARMOR))
      If (item.objtype in {0x1410, 0x1411, 0x1413, 0x1414, 0x1415, 0x1416, 0x1417, 0x1418, 0x141a, 0x1c04, // Platte
          0x1408, 0x1409, 0x140a, 0x140b, 0x140c, 0x140d, 0x140e, 0x140f, 0x1412, 0x1419,                  // Helme
          0x1b72, 0x1b73, 0x1b74, 0x1b75, 0x1b76, 0x1b77, 0x1b78, 0x1b79, 0x1b7a, 0x1b7b, 0x1bc3, 0x1bc4,  // Schilde
          0x13ec, 0x13ed, 0x13ee, 0x13ef, 0x13f0, 0x13f1, 0x13f2,                                          // Ringmail
          0x13bb, 0x13be, 0x13bf, 0x13c0, 0x13c3, 0x13c4,                                                  // Chainmail
          0x13d4, 0x13d5, 0x13d6, 0x13da, 0x13db, 0x1c00, 0x1c02, 0x1c0c, 0x8060,                          // beschlagenes Leder
          0xbfbb, 0xbfbe, 0xbfbf, 0xcdab})                                                                 // Sonstiges
        Return (0);
      Else
        Return (1); // normales Leder, Knochenrüsten, normale Kleider, ...
      EndIf
    Else
      Return (0); // Waffen oder Werkzeuge
    EndIf
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////
// ShowNPCItems - Zeigt alle Items, die ein NPC so mit sich fuehrt
////////////////////////////////////////////////////////////////////

Function ShowNPCItems(who)
  SendSysMessagePergon(who, "Bitte einen NPC auswaehlen!", "");

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_NPC))
    ForEach item in ListEquippedItems(mobile)
      SysLog("  Equip: Layer "+item.layer+", "+Hex(item.objtype)+", "+item.desc);
    EndForEach

    ForEach item in EnumerateItemsInContainer(mobile.backpack)
      SysLog("  Backpack: "+Hex(item.objtype)+", "+item.desc);
    EndForEach
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

///////////////////////////////////////////////
// SaveChars - Holt die Chars nach GreenAcres
///////////////////////////////////////////////

Function SaveChars()
  ForEach accountname in {"Chaos"}
    Var account:=FindAccount(accountname);
    If (account)
      SysLog("Account: "+accountname);

      Var char:=account.getcharacter(1);
      If (char)
        MoveObjectToLocation(char, 5445, 1153, 0, REALM_BRITANNIA, MOVEOBJECT_FORCELOCATION);
       // char.graphic:=400;
      EndIf
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////
// ModifyItemsInWorld - Durchsucht die Welt nach Items
////////////////////////////////////////////////////////

Var cpropnames:={};
Var einfache_fehler:={};
Var schwere_fehler:={};

Var lavariumbarren:={0};
Var energiumbarren:={0};
Var lavarium2barren:={0};
Var energium2barren:={0};
Var lavariumfarbend:={};
Var energiumfarbend:={};
Var lavarium2farbend:={};
Var energium2farbend:={};

Var hoelzer:=Dictionary;
  hoelzer[0x1BDD]:={0};hoelzer[0x7010]:={0x5a5};hoelzer[0x7011]:={0x415};hoelzer[0x7012]:={0x0029};hoelzer[0x7013]:={0x4B9};hoelzer[0x7014]:={0x458};
  hoelzer[0x7015]:={0x21F};hoelzer[0x7016]:={0x386};hoelzer[0x7017]:={0x41};hoelzer[0x7018]:={0x33};hoelzer[0x7019]:={0x35};hoelzer[0x701a]:={1257};
  hoelzer[0x701b]:={1151};hoelzer[0x701c]:={462};hoelzer[0x701d]:={1149};hoelzer[0x701e]:={1281};hoelzer[0x701f]:={139};hoelzer[0x7020]:={1109};
  hoelzer[0x7021]:={1150};hoelzer[0x1bd7]:={348};hoelzer[0x7100]:={0x05a5};hoelzer[0x7101]:={0x415};hoelzer[0x7102]:={0x002};hoelzer[0x7103]:={0x04B9};
  hoelzer[0x7104]:={0x0458};hoelzer[0x7105]:={0x021F};hoelzer[0x7106]:={0x0386};hoelzer[0x7107]:={0x0041};hoelzer[0x7108]:={0x0033};
  hoelzer[0x7109]:={0x35};hoelzer[0x710a]:={0x4e9};hoelzer[0x710b]:={0x47f};hoelzer[0x710c]:={0x1ce};hoelzer[0x710d]:={0x47d};
  hoelzer[0x710e]:={0x501};hoelzer[0x710f]:={0x8b};hoelzer[0x7110]:={0x455};hoelzer[0x7111]:={0x47e};
var reags := {0x0f7f};
var samen := {
  0xff87, 0xda23, 0xda00, 0xda01, 0xda02, 0xda03, 0xda04, 0xda05, 0xda06,
  0xda07, 0xda08, 0xda09, 0xda0a, 0xda0b, 0xda0c, 0xda0d, 0xda0e, 0xda10,
  0xda11, 0xda12, 0xda13, 0xda14, 0xda15, 0xda16, 0xda17, 0xda18, 0xda19,
  0xda1a, 0xda1b, 0xda1c, 0xda1d, 0xda1e, 0xda1f, 0xda20, 0xda21, 0xda24,
  0xefec, 0xefed, 0xefee, 0xefef, 0xeff0, 0xeff2, 0xeff3, 0xeff4, 0xeff5,
  0xeff6, 0xeff7, 0xeff8, 0xeff9, 0xeffa, 0xeffb, 0xeffc, 0xeffd, 0xeffe,
  0xefff
};
var fische := {
  0xa368, 0xa369, 0xa36a, 0xa36b, 0xa36c, 0xa36d, 0xa36e, 0xa36f
};
var muelleimer := {0x7007};

Function ModifyItemsInWorld()

  Var count:={0, 0, 0};
  //ForEach serial in array{
  //   0x45bbf01e, 0x45bbf05a, 0x45bbf06f, 0x45bbf086, 0x45bbf09d, 0x45bbf0a0,
  //   0x45bbf0af, 0x45bbf0b1, 0x45bbf0bc, 0x45bbf0bd, 0x45bbf0c1, 0x45bbf0c8,
  //   0x45bc9151, 0x45bc8fc5, 0x45bc9061, 0x45bc9070, 0x45bc9078, 0x45bc9087,
  //   0x45bc908d, 0x45bc908e, 0x45bc9099, 0x45bc90c4, 0x45bc90d5, 0x45bc90dd,
  //   0x45bc90e3, 0x45bc90eb, 0x45bc90ee, 0x45bc9117, 0x45bc9118, 0x45b27ef8,
  //   0x45b27ef8, 0x45bc9143, 0x45d3de9a, 0x45d3de53, 0x45d3de6d, 0x45d3dea1,
  //   0x45d3def2, 0x45d3def4, 0x45d3de87, 0x43ca9163, 0x43ca9176, 0x43cc6fd1,
  //   0x446c287a, 0x446c286f, 0x446c286f, 0x46af57a6, 0x46af5781, 0x46af578a,
  //   0x46af579a, 0x46af5833, 0x46af574f, 0x46af572c, 0x46af5777, 0x46af5801,
  //   0x46af5814, 0x46af5764, 0x43e76cb4
  // }
  //   Var subitem:=SystemFindObjectBySerial(serial, SYSFIND_SEARCH_OFFLINE_MOBILES+SYSFIND_SEARCH_STORAGE_AREAS);
  //   If (subitem)
  //     ListQuestCharItem(subitem, count, 1);
  //   Else
  //     LogToFile("log/questcharitems_error.log", Lower(Hex(serial))+" nicht gefunden");
  //   EndIf
  // EndForEach
  // Return;

  Var worldbank:=FindStorageArea(STORAGE_BANK);
  Var storage:=FindStorageArea(STORAGE_MERCHANT);
  If (worldbank And storage)
    Var player_equip_count:={0, 0, 0};
    Var player_backpack_count:={0, 0, 0};
    Var player_bankbox_count:={0, 0, 0};
    Var npc_equip_count:={0, 0, 0};
    Var npc_backpack_count:={0, 0, 0};
    Var npc_bankbox_count:={0, 0, 0};
    Var npc_fs_count:={0, 0, 0};
    Var npc_pb_count:={0, 0, 0};
    Var npc_1c_count:={0, 0, 0};
    Var npc_thief_count:={0, 0, 0};
    Var container_count:={0, 0, 0};
    Var item_count:={0, 0, 0};

    // Character durchsuchen
    ForEach accountname in ListAccounts();
      Var account:=FindAccount(accountname);
      If (account)
        Var charnr;
        For (charnr:=1; charnr<=5; charnr:=charnr+1)
          Var char:=account.getcharacter(charnr);
          If (char)
            ForEach item In ListEquippedItems(char)
              ModifyItem(item, player_equip_count);
            EndForEach

            ForEach item In EnumerateItemsInContainer(char.backpack,ENUMERATE_IGNORE_LOCKED)
              ModifyItem(item, player_backpack_count);
            EndForEach

            Var bankbox:=FindRootItemInStorageArea(worldbank, ST_PREF_BANK+char.serial);
            If (bankbox)
              ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
                ModifyItem(item, player_bankbox_count);
              EndForEach
            EndIf
          EndIf
        EndFor
      EndIf
    EndForEach

    // Welt durchsuchen
    ForEach object in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (object.isa(POLCLASS_NPC)) // NPCs durchsuchen
        ForEach item In ListEquippedItems(object)
          ModifyItem(item, npc_equip_count);
        EndForEach

        ForEach item In EnumerateItemsInContainer(object.backpack,ENUMERATE_IGNORE_LOCKED)
          ModifyItem(item, npc_backpack_count);
        EndForEach

        Var bankbox:=FindRootItemInStorageArea(worldbank, ST_PREF_BANK+object.serial);
        If (bankbox)
          ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
            ModifyItem(item, npc_bankbox_count);
          EndForEach
        EndIf

        bankbox:=FindRootItemInStorageArea(storage, object.serial+" FS");
        If (bankbox)
          ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
            ModifyItem(item, npc_fs_count);
          EndForEach
        EndIf

        bankbox:=FindRootItemInStorageArea(storage, object.serial+" PB");
        If (bankbox)
          ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
            ModifyItem(item, npc_pb_count);
          EndForEach
        EndIf

        bankbox:=FindRootItemInStorageArea(storage, object.serial+" 1C");
        If (bankbox)
          ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
            ModifyItem(item, npc_1c_count);
          EndForEach
        EndIf

        bankbox:=FindRootItemInStorageArea(storage, "thief storage of "+object.serial);
        If (bankbox)
          ForEach item In EnumerateItemsInContainer(bankbox,ENUMERATE_IGNORE_LOCKED)
            ModifyItem(item, npc_thief_count);
          EndForEach
        EndIf
      ElseIf (object.isa(POLCLASS_CONTAINER)) // Container durchsuchen
        ForEach item in EnumerateItemsInContainer(object,ENUMERATE_IGNORE_LOCKED)
          ModifyItem(item, container_count);
        EndForEach
        ModifyItem(object,item_count); // Container selber auch
      ElseIf (object.isa(POLCLASS_ITEM)) // Items durchsuchen
        ModifyItem(object, item_count);
      EndIf
    EndForEach

    SysLog("  player_equip_count    = "+player_equip_count[1]+   "/"+player_equip_count[2]+   "/"+player_equip_count[3]);
    SysLog("  player_backpack_count = "+player_backpack_count[1]+"/"+player_backpack_count[2]+"/"+player_backpack_count[3]);
    SysLog("  player_bankbox_count  = "+player_bankbox_count[1]+ "/"+player_bankbox_count[2]+ "/"+player_bankbox_count[3]);
    SysLog("  npc_equip_count       = "+npc_equip_count[1]+      "/"+npc_equip_count[2]+      "/"+npc_equip_count[3]);
    SysLog("  npc_backpack_count    = "+npc_backpack_count[1]+   "/"+npc_backpack_count[2]+   "/"+npc_backpack_count[3]);
    SysLog("  npc_bankbox_count     = "+npc_bankbox_count[1]+    "/"+npc_bankbox_count[2]+    "/"+npc_bankbox_count[3]);
    SysLog("  npc_fs_count          = "+npc_fs_count[1]+         "/"+npc_fs_count[2]+         "/"+npc_fs_count[3]);
    SysLog("  npc_pb_count          = "+npc_pb_count[1]+         "/"+npc_pb_count[2]+         "/"+npc_pb_count[3]);
    SysLog("  npc_1c_count          = "+npc_1c_count[1]+         "/"+npc_1c_count[2]+         "/"+npc_1c_count[3]);
    SysLog("  npc_thief_count       = "+npc_thief_count[1]+      "/"+npc_thief_count[2]+      "/"+npc_thief_count[3]);
    SysLog("  container_count       = "+container_count[1]+      "/"+container_count[2]+      "/"+container_count[3]);
    SysLog("  item_count            = "+item_count[1]+           "/"+item_count[2]+           "/"+item_count[3]);
    SysLog("  cpropnames            = "+cpropnames);
    SysLog("  einfache_fehler       = "+einfache_fehler);
    SysLog("  schwere_fehler        = "+schwere_fehler);

    // SysLog("  lavariumbarren        = ["+lavariumbarren.size()+"] "+lavariumbarren);
    // SysLog("  energiumbarren        = ["+energiumbarren.size()+"] "+energiumbarren);
    //SysLog("  lavarium2barren       = ["+lavarium2barren.size()+"] "+lavarium2barren);
    //SysLog("  energium2barren       = ["+energium2barren.size()+"] "+energium2barren);
    //SysLog("  lavariumfarbend       = ["+lavariumfarbend.size()+"] "+lavariumfarbend);
   // SysLog("  energiumfarbend       = ["+energiumfarbend.size()+"] "+energiumfarbend);
    //SysLog("  lavarium2farbend      = ["+lavarium2farbend.size()+"] "+lavarium2farbend);
   // SysLog("  energium2farbend      = ["+energium2farbend.size()+"] "+energium2farbend);

    //SysLog("  hoelzer               = "+hoelzer);
  EndIf
EndFunction

//////////////////////////////////////
// ModifyItem - Manipuliert das Item
//////////////////////////////////////

Function ModifyItem(item, ByRef count)
 // ModifyWerkzeugItem(item, count);
 // ModifyBarrenItem(item, count);
 // ModifyHolzItem(item, count);
 // ListQuestCharItem(item, count, 0);
 ModifyColorGraphic(item, count);
 // ModifyName(item,count);
EndFunction

//////////////////////////////////////
// ModifyName - Setzt Hersteller und Material
// in CProp für Tooltips damit Name nicht
// endlos lang ist
//////////////////////////////////////
Function ModifyName(item, ByRef count)
  //inkosistente Namen wieder geradebiegen
  If (item.objtype in {0x1efd,0x1515,0x1517,0x153b,0x1c06,0x153f})
    Var name:=item.name;
    Var cfgs:=ReadConfigFile(":*:itemdesc");
    If (cfgs[item.objtype])
      If (name["Exceptional "])
        SetName(item,"Exceptional "+cfgs[item.objtype].desc);
      ElseIf (name["Meisterstueck "])
        SetName(item,"Meisterstueck "+cfgs[item.objtype].desc);
      Else
        SetName(item,cfgs[item.objtype].desc);
      EndIf
    EndIf
    count[1]+=1;
  EndIf
  count[2]+=1;
//  If (item.getprop("Werkzeug")) // was selbst gebasteltes
//    var toolinfocprop:=struct{material:=""};
//    Var name:=item.name;
//    If (name[Len(name)]=="%")
//      name[Len(name)]:="";
//    EndIf
//
//    // Namenszusaetze filtern
//    Var pos:=Find(name, "[", 1);
//    If (pos)
//      Var endpos:=Find(name, "]", pos+1);
//      If (endpos)
//        toolinfocprop.+manufacturer:=name[pos+1, endpos-pos-1];
//        name[pos-1, endpos-pos+2]:="";
//      EndIf
//    EndIf
//
//    // Material filtern
//    pos:=Find(name, " aus ", 1);
//    If (pos)
//      name[1, pos+4]:="";
//      toolinfocprop.material:=name;
//    EndIf
//    item.setprop(TOOLINFO,toolinfocprop);
//
//    // bestimmte Container nicht umbenennen
//    If (item.isa(POLCLASS_CONTAINER)
//      If (item.container)
//        // befindet sich in Kiste, man kann es bei Bedarf herausnehmen
//        // und umbenennen
//        count[2]+=1;
//        count[3]+=1;
//        return;
//      ElseIf (GetObjProperty(item, "lockeddown"))
//        // wurde von Player im Haus festgemacht, kann bei Bedarf
//        // losgemacht und umbenannt werden
//        count[2]+=1;
//        count[3]+=1;
//        return;
//      EndIf
//    EndIf
//    name:=item.name;
//    Var cfgs:=ReadConfigFile(":*:itemdesc");
//    If (cfgs[item.objtype])
//      If (name["Exceptional "])
//        SetName(item,"Exceptional "+cfgs[item.objtype].desc);
//      ElseIf (name["Meisterstueck "])
//        SetName(item,"Meisterstueck "+cfgs[item.objtype].desc);
//      Else
//        SetName(item,cfgs[item.objtype].desc);
//      EndIf
//    EndIf
//    count[1]+=1;
//  EndIf
  count[2]+=1;
EndFunction

//////////////////////////////////////
// ModifyColorGraphic - Manipuliert Farbe und Grafik des Items
//////////////////////////////////////
Function ModifyColorGraphic(item, ByRef count)
//  var daemonstuff:={0x6320,0x144f,0x1452,0x144e,0x1450,0x8074,0x1451,0x1f0b};
  If (item.objtype in reags)
    If (item.color == 0 && item.graphic == 0xf7f)
      item.color := 0x0845;
      item.graphic := 0x0F8B;
      count[1] += 1;    
    EndIf
  EndIf
  count[2] += 1;
EndFunction

//////////////////////////////////////////////
// ModifyWerkzeugItem - Manipuliert das Item
//////////////////////////////////////////////

Function ModifyWerkzeugItem(item, ByRef count)
  If (GetObjProperty(item, "type") in WERKZEUG_TYPES)
    If (GetObjProperty(item, "Hp") Or GetObjProperty(item, "Maxhp") Or
        GetObjProperty(item, "Quality") Or GetObjProperty(item, "SkilliD"))
      DoModifyWerkzeugItem(item);
      EraseObjProperty(item, "Quality");
      EraseObjProperty(item, "Hp");
      EraseObjProperty(item, "Maxhp");
      EraseObjProperty(item, "type");
      EraseObjProperty(item, "SkilliD");

      count[1]:=count[1]+1;
    Else
      EraseObjProperty(item, "type");

      count[2]:=count[2]+1;
    EndIf
  Else
    If ((!GetObjProperty(item, "type")) And GetObjProperty(item, "Hp") And
       GetObjProperty(item, "Maxhp") And GetObjProperty(item, "Quality"))
      EraseObjProperty(item, "Hp");
      EraseObjProperty(item, "Maxhp");
      EraseObjProperty(item, "Quality");

      count[2]:=count[2]+1;
    ElseIf (IsNumeric(GetObjProperty(item, "type")) Or GetObjProperty(item, "Hp") Or GetObjProperty(item, "Maxhp") Or
           GetObjProperty(item, "Quality") Or GetObjProperty(item, "SkilliD"))
      EraseObjProperty(item, "Hp");
      EraseObjProperty(item, "Maxhp");
      EraseObjProperty(item, "Quality");
      EraseObjProperty(item, "SkilliD");

      count[2]:=count[2]+1;
    EndIf
  EndIf

  count[3]:=count[3]+1;
EndFunction

///////////////////////////////////////////////////////////////
// DoModifyWerkzeugItem - Manipulation des Items durchfuehren
///////////////////////////////////////////////////////////////

Function DoModifyWerkzeugItem(item)
  If (!GetObjProperty(item, "Werkzeug"))
    Var props:=GetPropertyItem(item);
    If (props)
      Var fehlerfrei:=1;

      Var value:=GetObjProperty(item, "Quality");
      If (value)
        If (IsNumericDbl(value))
          props.quality:=CDbl(value);
        Else
          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltige Quality ["+value+"] !");
          fehlerfrei:=0;
        EndIf
      EndIf
      value:=GetObjProperty(item, "Hp");
      If (value)
        If (IsNumericDbl(value))
          If (CInt(value)<>CDbl(value))
            SysLog("WARNUNG: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hatte Gleitkomma HP!");
          EndIf

          props.hp:=CInt(value);
        Else
          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltige HP ["+value+"] !");
          fehlerfrei:=0;
        EndIf
      EndIf
      value:=GetObjProperty(item, "Maxhp");
      If (value)
        If (IsNumericDbl(value))
          If (CInt(value)<>CDbl(value))
            SysLog("WARNUNG: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hatte Gleitkomma MaxHP!");
          EndIf

          props.maxhp:=CInt(value);
        Else
          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltige MaxHP ["+value+"] !");
          fehlerfrei:=0;
        EndIf
      EndIf
      value:=GetObjProperty(item, "type");
      If (value)
        If (value in WERKZEUG_TYPES)
          props.type:=value;
        Else
          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltigen Type ["+value+"] !");
          fehlerfrei:=0;
        EndIf
      EndIf
      value:=GetObjProperty(item, "SkilliD");
      If (value)
        value:=GetSkillName(value);
        If (value)
          props.skillid:=value;
        Else
          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltige SkillID ["+value+"] !");
          fehlerfrei:=0;
        EndIf
      EndIf

      If (fehlerfrei)
        SetPropertyItem(item, props.quality, props.hp, props.maxhp, props.qualityorig,
          props.maxhporig, props.type, props.skillid, props.skillrepair, props.price);
      Else
        If (!(Hex(item.objtype) in einfache_fehler))
          einfache_fehler.append(Hex(item.objtype));

          SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat ungueltige Eigenschaften!");
        EndIf
      EndIf
    Else
      If (!(Hex(item.objtype) in schwere_fehler))
        schwere_fehler.append(Hex(item.objtype));

        SysLog("FEHLER: Item "+item.desc+" ("+Hex(item.objtype)+"/"+Hex(item.serial)+") hat keine Eigenschaften!");
      EndIf
    EndIf
  EndIf
EndFunction

////////////////////////////////////////////
// ModifyBarrenItem - Manipuliert das Item
////////////////////////////////////////////

Function ModifyBarrenItem(item, ByRef count)
  If (item.objtype in {0x6324,0x6325,0x6326,0x6330,0x6331})
//    If (item.color==0x24)
      If (item.container)
        lavariumbarren.append({item.amount, Lower(Hex(item.color)), Lower(Hex(item.container.serial))});
      Else
        lavariumbarren.append({item.amount, Lower(Hex(item.color)), item.x, item.y, item.z});
      EndIf

      item.graphic:=0x26B5;
//    Else
//      If (item.container)
//        lavarium2barren.append({item.amount, Lower(Hex(item.color)), Lower(Hex(item.container.serial))});
//      Else
//        lavarium2barren.append({item.amount, Lower(Hex(item.color)), item.x, item.y, item.z});
//      EndIf
//    EndIf

    lavariumbarren[1]+=item.amount;
    count[1]+=1;
  ElseIf (item.objtype in {0x6323,0x6327,0x6332})
//    If (item.color==0x480)
      If (item.container)
        energiumbarren.append({item.amount, Lower(Hex(item.color)), Lower(Hex(item.container.serial))});
      Else
        energiumbarren.append({item.amount, Lower(Hex(item.color)), item.x, item.y, item.z});
      EndIf

      item.graphic:=0x26B4;
//    Else
//      If (!(item.objtype in {0xA155, 0xA158, 0xC003, 0xC004}))
//        If (item.container)
//          energium2barren.append({item.amount, Lower(Hex(item.color)), Lower(Hex(item.container.serial))});
//        Else
//          energium2barren.append({item.amount, Lower(Hex(item.color)), item.x, item.y, item.z});
//        EndIf
//      EndIf
//    EndIf
//
    energiumbarren[1]+=item.amount;
    count[1]+=1;
//  ElseIf (item.objtype in {0x6323,0x6327,0x6332})
//    If (GetObjProperty(item, "Werkzeug"))
//      If (item.container)
//        lavariumfarbend.append({item.desc, Lower(Hex(item.objtype)), Lower(Hex(item.container.serial))});
//      Else
//        lavariumfarbend.append({item.desc, Lower(Hex(item.objtype)), item.x, item.y, item.z});
//      EndIf
//
//      item.color:=0x6C2;
//    Else
////      If (item.objtype<>0x6320)
//        If (item.container)
//          lavarium2farbend.append({item.desc, Lower(Hex(item.objtype)), Lower(Hex(item.container.serial))});
//        Else
//          lavarium2farbend.append({item.desc, Lower(Hex(item.objtype)), item.x, item.y, item.z});
//        EndIf
////      EndIf
//item.color:=0x6C2;
    EndIf

//    count[2]:=count[2]+1;
//  ElseIf (item.color==0x480)
//    If (GetObjProperty(item, "Werkzeug"))
//      If (item.container)
//        energiumfarbend.append({item.desc, Lower(Hex(item.objtype)), Lower(Hex(item.container.serial))});
//      Else
//        energiumfarbend.append({item.desc, Lower(Hex(item.objtype)), item.x, item.y, item.z});
//      EndIf
//
//      item.color:=0x48d;
//    Else
//      If (item.container)
//        energium2farbend.append({item.desc, Lower(Hex(item.objtype)), Lower(Hex(item.container.serial))});
//      Else
//        energium2farbend.append({item.desc, Lower(Hex(item.objtype)), item.x, item.y, item.z});
//      EndIf
//    EndIf

//    count[2]:=count[2]+1;
//  EndIf

  count[3]+=1;
EndFunction

//////////////////////////////////////////
// ModifyHolzItem - Manipuliert das Item
//////////////////////////////////////////

Function ModifyHolzItem(item, ByRef count)
  If (hoelzer.exists(item.objtype))
    If (item.color<>hoelzer[item.objtype][1])
      If (item.container)
        hoelzer[item.objtype].append({item.amount, Lower(Hex(item.color)), Lower(Hex(item.container.serial))});
      Else
        hoelzer[item.objtype].append({item.amount, Lower(Hex(item.color)), item.x, item.y, item.z});
      EndIf

      item.color:=hoelzer[item.objtype][1];
      count[1]:=count[1]+1;
    Else
      count[2]:=count[2]+1;
    EndIf
  EndIf

  count[3]:=count[3]+1;
EndFunction

///////////////////////////////////////////
// ListQuestCharItem - Erzeugt eine Liste
///////////////////////////////////////////

Function ListQuestCharItem(item, ByRef count, DONT_CHECK)
  If (GetObjProperty(item, TYPQUESTCHAR) Or DONT_CHECK)
    Var text_add:="";
    Var text_add2:="";
    Var coorditem:=item;

    If (item.container)
      Var container:=item;
      While (container.container)
        container:=container.container;
      EndWhile

      text_add:=";"+Lower(Hex(container.serial))+";"+container.desc;

      Var desc:=container.desc;
      If (desc[ST_PREF_BANK])
        desc[ST_PREF_BANK]:="";

        Var owner:=SystemFindObjectBySerial(CInt(desc), SYSFIND_SEARCH_OFFLINE_MOBILES);
        If (owner)
          text_add2:=";"+Lower(Hex(owner.serial))+";"+owner.acctname+";"+owner.name+";"+owner.cmdlevel;
        EndIf
      EndIf

      coorditem:=container;
    Else
      text_add:=";;";
    EndIf

    If (coorditem.multi)
      Var house:=coorditem.multi;

      Var owneracct:=GetObjProperty(house, "owneracct");
      If (!owneracct)
        owneracct:="nix";
      EndIf

      Var ownerserial:=GetObjProperty(house, "ownerserial");
      If (ownerserial)
        ownerserial:=Lower(Hex(ownerserial));
      Else
        ownerserial:="nix";
      EndIf

      Var owner:=SystemFindObjectBySerial(CInt(ownerserial), SYSFIND_SEARCH_OFFLINE_MOBILES);
      If (!owner)
        owner:={};
        owner.+name:="nix";
      EndIf

      text_add:=text_add+";"+ownerserial+";"+owneracct+";"+owner.name;
    EndIf

    Var logfilename_add:="";
    If (item.amount>=10000)
      logfilename_add:="10000";
    ElseIf (item.amount>=1000)
      logfilename_add:="1000";
    ElseIf (item.amount>=10)
      logfilename_add:="10";
    EndIf

    LogToFile("log/questcharitems"+logfilename_add+".log", Lower(Hex(item.objtype))+";"+item.amount+";"+item.desc+";"+
      Lower(Hex(item.serial))+";"+coorditem.x+";"+coorditem.y+";"+coorditem.z+text_add+text_add2);

    count[1]:=count[1]+1;
  Else
    count[2]:=count[2]+1;
  EndIf

  count[3]:=count[3]+1;
EndFunction

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ListPotentielleSchmuggleWare - Erstellt eine Liste potentieller Schmuggleware, d.h. in "statischen" Containern
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Function ListPotentielleSchmuggleWare()
  ForEach object in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (object.isa(POLCLASS_CONTAINER))
      If (!GetObjProperty(object, "spawnnet")) // Gespawnte Kisten ignorieren...
        If (!object.multi) // In Spielerhaeusern erlaubt...
          If (!CheckIfIsInGuildHouse(object)) // In Gildenhaeusern auch...
            If (!((5378<=object.x) And (object.x<=5408) And (1141<=object.y) And (object.y<=1150))) // Gesicherte Haus-Inhalte ignorieren...
              Var inhalt:=EnumerateItemsInContainer(object, ENUMERATE_IGNORE_LOCKED);
              If (inhalt.size()) // Is da was drinne?
                ForEach item in inhalt
                  If (!(((object.objtype in {0xa97, 0xa98, 0xa99, 0xa9a, 0xa9b, 0xa9c}) And
                         (item.objtype in {0xff85, 0xfef, 0xff0, 0xff1, 0xff2, 0xff3, 0xff4})) Or // Regale mit Buechern
                        ((object.objtype in {0x6670, 0xfad, 0xfa6}) And (item.objtype==0x669b)) Or // Spielbrette mit -steinen
                        ((object.objtype==0xa320) And (item.object==0xa321)))) // Stadtstein mit Wahlrune
                    LogToFile("log/schmuggleitems.log", Lower(Hex(item.objtype))+";"+item.amount+";"+item.desc+";"+
                      Lower(Hex(item.serial))+";"+object.x+";"+object.y+";"+object.z+";"+Lower(Hex(object.objtype)));
                  EndIf
                EndForEach
              EndIf
            EndIf
          EndIf
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////////////////
// CheckIfIsInGuildHouse - Befindet sich der Gegenstand in einem GildenHaus?
//////////////////////////////////////////////////////////////////////////////

Function CheckIfIsInGuildHouse(object)
  ForEach ranges in {{1774, 793, -20, 1799, 818, 100}, {2782, 683, -20, 2793, 695, 20}, {2521, 591, -62, 2546, 616, 45},
                     {1893, 395, 0, 1917, 434, 110}, {583, 907, -61, 608, 933, 80}, {2560, 413, -10, 2584, 438, 110}}
    If ((ranges[1]<=object.x) And (object.x<=ranges[4]) And (ranges[2]<=object.y) And
        (object.y<=ranges[5]) And (ranges[3]<=object.z) And (object.z<=ranges[6]))
      Return (1);
    EndIf
  EndForEach

  Return (0);
EndFunction

///////////////////////////////////////////////////////////
// DistroTestAllItemsAndNPCs - Testet alle Items und NPCs
///////////////////////////////////////////////////////////

Function DistroTestAllItemsAndNPCs(who)
  Var system:=PolCore();

  SendSysMessagePergon(who, "Test running...", "", _DEFAULT_TEXT_FONT, 38);
  SysLog("Test running... ("+system.itemcount+" Items / "+system.mobilecount+" Mobiles)");

  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var item:=CreateItemAtLocationPergon(0, 0, 0, CInt(objtype), 1);
      If (item)
        Var syslogtext:="  Item - "+objtype+" = '"+item.desc+"'";
        If (itemdesccfg[objtype].walkon)
          syslogtext:=syslogtext+" / WalkOn = "+itemdesccfg[objtype].walkon;
        EndIf
        If (GetObjProperty(item, "WalkOn"))
          syslogtext:=syslogtext+" / OnHit = "+GetObjProperty(item, "WalkOn");
        EndIf
        SysLog(syslogtext);

        DestroyItem(item);
      EndIf
    EndForEach
  EndIf

  Var npcdesccfg:=ReadConfigFile("npcdesc");
  If (npcdesccfg)
    ForEach template in GetConfigStringKeys(npcdesccfg)
      Var npc:=CreateNpcFromTemplate(template, 2477, 416, 15);
      If (!npc)
        npc:=CreateNpcFromTemplate(template, 0, 0, 0);
      EndIf

      If (npc)
        SysLog("  NPC - '"+template+"' = '"+npc.name+"'");

        Sleep(8);
        RevokePrivilege(npc, "invul");
        SetObjProperty(npc, "guardkill", 1);
        Damage(npc, 6000);
        Sleep(2);
      Else
        SysLog("  NPC - '"+template+"' - ERROR");
      EndIf
    EndForEach
  EndIf

  SysLog("Test finished. ("+system.itemcount+" Items / "+system.mobilecount+" Mobiles)");
  SendSysMessagePergon(who, "Test finished.", "", _DEFAULT_TEXT_FONT, 38);
EndFunction

/////////////////////////////////////////////////////////////////
// CheckItemProperties - Prueft Item Properties in der ItemDesc
/////////////////////////////////////////////////////////////////

Function CheckNFixItemProperties(who)
  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    ForEach objtype in GetConfigStringKeys(itemdesccfg)
      Var itemdesc:=itemdesccfg[objtype];
      If (itemdesc)
        //
      EndIf
    EndForEach
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////
// GenerateItemListForDB - Erzeugt eine Liste der Items fuer Excel
////////////////////////////////////////////////////////////////////

Const TYPE_CORE       :="C";
Const TYPE_CORE_SCRIPT:="CS";
Const TYPE_SCRIPT     :="S";

Function GenerateItemListForDB(who)
  Var klassenberufe:=KlassenBerufe_einlesen();
  Var klassenprops:=" ";
  Var berufeprops:=" ";

  ForEach klasse in (klassenberufe.keys())
    klassenprops:=klassenprops+klasse+" ";
    berufeprops:=berufeprops+klassenberufe[klasse];
  EndForEach
  klassenberufe:=Lower(klassenprops+berufeprops);

  Var ignoreprops:=Dictionary;
  Var itemprops:=Dictionary;
  Var itempropsdoppelt:={};
  Var itempropsfehler:={};
  Var cprops:=" ";
  Var cpropsdoppelt:={};
  Var objclasses:="";
  Var props:=Dictionary;
  ignoreprops["all"]:=" ";
  itemprops["all"]:=" ";
  props["props"]:=Dictionary;
  props["cprops"]:={};

 // achja die filenamen wo waas steht hauste auch mit in die tabelle ? -> geht nich über Pol... liesse sich aber über PackageObjImp::get_member realisieren
 // StrRequired is verboten, gleich mal pruefen
 // kram aus der tiledata mit aufnehmen (auch gewicht und name und so)
 // pruefen ob name und desc vorhanden sind

  Var itemdesccfg:=ReadConfigFile("::itemdesc");
  If (itemdesccfg)
    For objtype:=0x0 to 0xffff
      Var itemdesc:=GetItemDescriptor(objtype);
      If (itemdesc)
        If (!ignoreprops[itemdesc.objclass]) // Gibts schon die Liste der wichtigsten Props?
          Var ignore:=" ";
          ForEach prop in itemdesc
            ignore:=ignore+_prop_iter+" ";
            _prop_iter:=Lower(_prop_iter);

            If (!ignoreprops["all"][" "+_prop_iter+" "]) // Noch nich in der globalen Liste enthalten?
              ignoreprops["all"]:=ignoreprops["all"]+_prop_iter+" ";
              props["props"][_prop_iter]:=TYPE_CORE;
            EndIf
          EndForEach

          ignoreprops[itemdesc.objclass]:=ignore;
          ignoreprops[itemdesc.objclass+"2"]:=Lower(ignore);
          itemprops[itemdesc.objclass]:="";
          objclasses:=objclasses+itemdesc.objclass+" ";
        EndIf
      EndIf
    EndFor

    For objtype:=0x0 to 0xffff
      Var itemdesc:=GetItemDescriptor(objtype);
      If (itemdesc)
        Var itemdesc2:=itemdesccfg[objtype]; // Naja, eigentlich alle unter 0x4000 auch

        ForEach propname in ListConfigElemProps(itemdesc2)
          propname:=Lower(propname);

          If (propname<>"cprop")
            If (!(((itemdesc.objclass=="Armor") And (propname=="coverage")) Or ((itemdesc.objclass=="Boat") And (propname=="oldobjtype"))))
              If ((!ignoreprops[itemdesc.objclass+"2"][" "+propname+" "]) And (!klassenberufe[" "+propname+" "])) // Keine wichtige Prop?
                If (!itemprops[itemdesc.objclass][" "+propname+" "]) // Noch nich aufgelistet?
                  itemprops[itemdesc.objclass]:=itemprops[itemdesc.objclass]+propname+" ";

                  If (!itemprops["all"][" "+propname+" "]) // Noch nich in der globalen Liste enthalten?
                    itemprops["all"]:=itemprops["all"]+propname+" ";

                    If (props["props"][propname])
                      props["props"][propname]:=TYPE_CORE_SCRIPT;
                    Else
                      props["props"][propname]:=TYPE_SCRIPT;
                    EndIf
                  EndIf

                  If ((propname<>"maxhp") And (ignoreprops["all"][" "+propname+" "]))
                    itempropsfehler.append({Lower(Hex(objtype)), propname});
                  EndIf
                EndIf
              EndIf

              If (GetConfigStringArray(itemdesc2, propname).size()>1)
                itempropsdoppelt.append({Lower(Hex(objtype)), propname});
              EndIf
            EndIf
          Else
            Var itemcprops:=" ";

            ForEach cprop in GetConfigStringArray(itemdesc2, propname)
              cprop:=Lower(SplitWords(cprop)[1]);

              If (!cprops[" "+cprop+" "])
                cprops:=cprops+cprop+" ";
                props["cprops"].append(cprop);
              EndIf

              If (!itemcprops[" "+cprop+" "])
                itemcprops:=itemcprops+cprop+" ";
              Else
                cpropsdoppelt.append({Lower(Hex(objtype)), cprop});
              EndIf
            EndForEach
          EndIf
        EndForEach
      EndIf
    EndFor

    Var ignorepropsanzahl:=SplitWords(ignoreprops["all"]).Size();
    Var itempropsanzahl:=SplitWords(itemprops["all"]).Size();
    Var cpropsanzahl:=SplitWords(cprops).Size();
    Var ignoreitemprops:="";
    props["cprops"].sort();

    ForEach propname in SplitWords(itemprops["all"])
      If (ignoreprops["all"][" "+propname+" "])
        ignoreitemprops:=ignoreitemprops+propname+" ";
      EndIf
    EndForEach

    LogToFile("log/props.log", "ObjClasses       = "+objclasses);
    LogToFile("log/props.log", "IgnoreProps      = "+ignoreprops);
    LogToFile("log/props.log", "IgnoreProps[all] = "+ignoreprops["all"]);
    LogToFile("log/props.log", "ItemProps        = "+itemprops);
    LogToFile("log/props.log", "ItemProps[all]   = "+itemprops["all"]);
    LogToFile("log/props.log", "IgnoreItemProps  = "+ignoreitemprops);
    LogToFile("log/props.log", "ItemPropsFehler  = "+itempropsfehler);
    LogToFile("log/props.log", "ItemPropsDoppelt = "+itempropsdoppelt);
    LogToFile("log/props.log", "CProps           = "+cprops);
    LogToFile("log/props.log", "CPropsDoppelt    = "+cpropsdoppelt);
    LogToFile("log/props.log", "Props            = "+props);
    LogToFile("log/props.log", "Anzahl           = "+ignorepropsanzahl+" + "+itempropsanzahl+" + "+cpropsanzahl+" = "+(ignorepropsanzahl+itempropsanzahl+cpropsanzahl));
    LogToFile("log/props.log", "");

    Var output:="ObjType;ObjType";
    ForEach prop in (props["props"].keys())
      If (prop<>"cprops")
        output:=output+";"+props["props"][prop]+"."+prop;
      EndIf
    EndForEach

    If (props["props"]["cprops"]<>TYPE_CORE)
      LogToFile("log/props.log", "Warnung!!! 'cprops' ist irgendwie mehr als 'ne Core-Geschichte!");
      LogToFile("log/props.log", "");
    EndIf
    LogToFile("log/props.log", output);

   // For objtype:=0x13b7 to 0x13b7
    For objtype:=0x0 to 0xffff
      output:=objtype+";"+Lower(Hex(objtype));

      Var itemdesc:=GetItemDescriptor(objtype);
      If (itemdesc)
        Var itemdesc2:=itemdesccfg[objtype]; // Naja, eigentlich alle unter 0x4000 auch

        ForEach prop in (props["props"].keys())
          Case (props["props"][prop])
            TYPE_CORE:        If (prop<>"cprops")
                                If (itemdesc[prop]==error)
                                  output:=output+";";
                                Else
                                  output:=output+";"+itemdesc[prop];
                                EndIf
                              EndIf

            TYPE_CORE_SCRIPT: If (itemdesc[prop]<>error)
                                output:=output+";"+itemdesc[prop];
                              ElseIf (GetConfigString(itemdesc2, prop)<>error)
                                output:=output+";"+GetConfigString(itemdesc2, prop);
                              Else
                                output:=output+";";
                              EndIf

            TYPE_SCRIPT:      If (GetConfigString(itemdesc2, prop)<>error)
                                output:=output+";"+GetConfigString(itemdesc2, prop);
                              Else
                                output:=output+";";
                              EndIf
          EndCase
        EndForEach

        ForEach cprop in (props["cprops"])


         // cprop:=Lower(SplitWords(cprop)[1]);

          //
        EndForEach

        LogToFile("log/props.log", output);
      EndIf
    EndFor

    LogToFile("log/props.log", "");
  EndIf
EndFunction

///////////////////////////////////////////////////////////
// TestWWWOnlineWorkAround - Testet das "neue" WWW-Online
///////////////////////////////////////////////////////////

Function TestWWWOnlineWorkAround()
  Var datafile:=CreateDataFile("WWWOnline");

  Set_Script_Option(SCRIPTOPT_NO_RUNAWAY, 1);

  // Server-Uptime bestimmen
  Var uptime:=polcore().uptime;
  Var days:=CInt(uptime/86400);
  Var hours:=CInt((uptime-days*86400)/3600);
  Var minutes:=CInt((uptime-days*86400-hours*3600)/60);

  // Server-Uptime Ausgabestring zusammenbasteln
  If (hours Or days)
    If (minutes<10)
      uptime:="0"+minutes+" min.";
    Else
      uptime:=minutes+" min.";
    EndIf
  Else
    uptime:=minutes+" min.";
  EndIf
  If (hours)
    uptime:=hours+"h und "+uptime;
  EndIf
  If (days)
    uptime:=days+"d, "+uptime;
  EndIf

  Var serverelem:=datafile.createelement("Server");
  serverelem.setprop("Uhrzeit", GetPergonTimeOfDay());
  serverelem.setprop("Uptime", uptime);

  Var onlinechars:=EnumerateVisibleOnlineCharacters(developertemplate, LIST_ME); // Liste mit {char.name, char}
  If (onlinechars.size())
    Var gameclock:=ReadGameClock();
    Var playerinfo:={};
    Var cmdinfo:={};

    // Informationen ueber jeden Character ausgeben
    ForEach char in onlinechars
      // Online-Zeit ermitteln
      Var time:=GetObjProperty(char[2], "lifetime_session");
      If (time)
        time:=gameclock-time;
        hours:=CInt(time/3600);
        minutes:=CInt((time-hours*3600)/60);

        // Online-Zeit Ausgabestring zusammenbasteln
        If (hours)
          If (minutes<10)
            time:=hours+"h 0"+minutes+" min.";
          Else
            time:=hours+"h "+minutes+" min.";
          EndIf
        Else
          time:=minutes+" min.";
        EndIf

        time:="seit "+time;
      Else
        SetObjProperty(char[2], "lifetime_session", gameclock);
        time:="";
      EndIf

      // CommandoLevel ermitteln
      If (char[2].cmdlevel >= CMDLEVEL_SEER)
        cmdinfo.append({char[1], GetCMDLevelTitle(char[2].cmdlevel), KONTINENT, time});
      Else
        Var playerlevel;
        If (char[2].gender)
          playerlevel:="weibl.";
        Else
          playerlevel:="m&auml;nnl.";
        EndIf

        playerinfo.append({char[1], playerlevel, PlaceName(char[2]), time});
      EndIf
    EndForEach

    Var playerelem:=datafile.createelement("Player");
    Var index:=1;

    // CommandLevel - Character-Informationen ausgeben
    ForEach player in SortMultiArrayByIndexNotCase(cmdinfo, 1)
      playerelem.setprop("Player_"+index, player[1]+"/"+player[2]+"/"+player[3]+"/"+player[4]);
      index:=index+1;
    EndForEach

    // Character-Informationen ausgeben
    ForEach player in SortMultiArrayByIndexNotCase(playerinfo, 1)
      playerelem.setprop("Player_"+index, player[1]+"/"+player[2]+"/"+player[3]+"/"+player[4]);
      index:=index+1;
    EndForEach
  EndIf

  serverelem.setprop("Online", Len(onlinechars));

  UnloadDataFile("WWWOnline");
EndFunction

/////////////////////////////////////////////////////////////
// AnalyzeItem - Analysiert ein Item dessen Serial ich habe
/////////////////////////////////////////////////////////////

Function AnalyzeItem(who, params)
  Var item:=SystemFindObjectBySerial(CInt(params), SYSFIND_SEARCH_OFFLINE_MOBILES);
  If (item)
    Var orig_container:=item.container;
    MoveItemToContainer(item, who.backpack);

    Var layout:={"page 0", "nodispose", "resizepic 10 10 2620 50 50"};
    Var data:={};
    SendDialogGump(who, layout, data);

    If (orig_container)
      SendSysMessagePergon(who, "Container-Serial = "+Lower(Hex(orig_container.serial)), "");
      MoveItemToContainer(item, orig_container);
    EndIf
  Else
    SendSysMessagePergon(who, "Item mit der Serial '"+params+"' nicht gefunden!", "");
  EndIf
EndFunction

///////////////////////////////////////////////////////////////
// DupliziereCharacter - Exakte Kopie des Originals erstellen
///////////////////////////////////////////////////////////////

Function DupliziereCharacter(who)
  Var quellaccount:=FindAccount("Trash");
  Var zielaccount:=FindAccount("morcan");
  If (quellaccount And zielaccount)
    Var quellchar:=quellaccount.getcharacter(1);
    Var zielchar:=zielaccount.getcharacter(1);
    If (quellchar And zielchar)
      // Skill-Werte kopieren
      For skillid:=0 To MAX_SKILLS
        SetRawSkillPergon(zielchar, skillid, GetRawSkillPergon(quellchar, skillid));
      EndFor

      // Stat- und Vitalwerte kopieren
      SetDexPergon(zielchar,     GetDexPergon(quellchar));
      SetIntPergon(zielchar,     GetIntPergon(quellchar));
      SetStrPergon(zielchar,     GetStrPergon(quellchar));
      SetHPPergon(zielchar,      GetHPPergon(quellchar));
      SetManaPergon(zielchar,    GetManaPergon(quellchar));
      SetStaminaPergon(zielchar, GetStaminaPergon(quellchar));

      // Sonstige Werte kopieren
      zielchar.gender:=quellchar.gender;
      zielchar.color:=quellchar.color;
      SetObjProperty(zielchar, "MsgOfDayID", GetObjProperty(zielchar, "MsgOfDayID"));
      SetObjProperty(zielchar, PROP_ALCOHOL, GetObjProperty(zielchar, PROP_ALCOHOL));
      SetObjProperty(zielchar, PROP_THIRST,  GetObjProperty(zielchar, PROP_THIRST));
      SetObjProperty(zielchar, PROP_HUNGER,  GetObjProperty(zielchar, PROP_HUNGER));

      // Character verschieben
      MoveObjectToLocation(zielchar, quellchar.x, quellchar.y, quellchar.z, quellchar.realm, MOVEOBJECT_FORCELOCATION);

      // Backpack leeren
      ForEach item in EnumerateItemsInContainer(zielchar.backpack)
        DestroyItem(item);
      EndForEach

      // Backpack duplizieren
      ForEach item in EnumerateItemsInContainer(quellchar.backpack)

        SysLog("  Backpack = "+item.desc);

        Var newitem:=DupliziereItem(zielchar, item);
       // If (newitem)
       //   If (!MoveItemToContainer(newitem, zielchar.backpack))
       //     SysLog("  Item '"+newitem.desc+"' konnte nicht ins Backpack gepackt werden!");
       //     DestroyItem(newitem);
       //   EndIf
       // EndIf
      EndForEach

      // Bankbox leeren
      Var zielbankbox:=FindBankBox(zielchar);
      If (zielbankbox)
        ForEach item in EnumerateItemsInContainer(zielbankbox)
          DestroyItem(item);
        EndForEach
      EndIf

      // Bankbox duplizieren
      Var quellbankbox:=FindBankBox(quellchar);
      If (quellbankbox)
        ForEach item in EnumerateItemsInContainer(quellbankbox)

          SysLog("  Bankbox = "+item.desc);

          Var newitem:=DupliziereItem(zielchar, item);
         // If (newitem)
         //   If (!MoveItemToContainer(newitem, zielbankbox))
         //     SysLog("  Item '"+newitem.desc+"' konnte nicht in die Bankbox gepackt werden!");
         //     DestroyItem(newitem);
         //   EndIf
         // EndIf
        EndForEach
      EndIf

      // Character entkleiden
      ForEach equipment in ListEquippedItems(zielchar)
        DestroyItem(equipment);
      EndForEach

      // Character neu einkleiden
      ForEach equipment in ListEquippedItems(quellchar)
        Var newequipment:=DupliziereItem(zielchar, equipment);
        If (newequipment)
          If (!EquipItem(zielchar, newequipment))
           // If (!MoveItemToContainer(newequipment, zielchar.backpack))
           //   SysLog("  Item '"+newequipment.desc+"' konnte weder angelegt, noch ins Backpack gepackt werden!");
           //   DestroyItem(newequipment);
           // EndIf
          EndIf
        EndIf
      EndForEach

      // Skills abschliessend korrigieren
      FixZeroSkills();
    EndIf
  EndIf
EndFunction

//////////////////////////////////////////////////////////
// DupliziereItem - Exakte Kopie des Originals erstellen
//////////////////////////////////////////////////////////

Function DupliziereItem(who, item)
  Var newitem:=CreateItemAtLocationPergon(who.x, who.y, who.z, item.objtype, 1);
  If (newitem)
    // Item-Eigenschaften duplizieren
    newitem.amount   :=item.amount;
    newitem.color    :=item.color;
    newitem.facing   :=item.facing;
    newitem.invisible:=item.invisible;
    newitem.movable  :=item.movable;
    newitem.newbie   :=item.newbie;
    If (newitem.desc<>item.desc)
      newitem.desc:=item.desc;
    EndIf

    // Spezielle Item-Eigenschaften duplizieren
    If (item.isa(POLCLASS_WEAPON))
      newitem.dmg_mod  :=item.dmg_mod;
      newitem.maxhp_mod:=item.maxhp_mod;
      newitem.hp       :=item.hp;
      newitem.quality  :=item.quality;
    ElseIf (item.isa(POLCLASS_ARMOR))
      newitem.ar_mod   :=item.ar_mod;
      newitem.maxhp_mod:=item.maxhp_mod;
      newitem.hp       :=item.hp;
      newitem.quality  :=item.quality;
    ElseIf (item.isa(POLCLASS_MAP))
      newitem.gumpheight:=item.gumpheight;
      newitem.gumpwidth :=item.gumpwidth;
      newitem.xeast     :=item.xeast;
      newitem.xwest     :=item.xwest;
      newitem.ynorth    :=item.ynorth;
      newitem.ysouth    :=item.ysouth;
    EndIf

    // CProps duplizieren
    ForEach propname in GetObjPropertyNames(item)
      SetObjProperty(newitem, propname, GetObjProperty(newitem, propname));
    EndForEach

    Return (newitem);
  Else
    SysLog("  Item '"+item.desc+"' konnte nicht kopiert werden!");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////
// CheckStandingHeight - Probiert alles zum Thema StandingHeight aus
//////////////////////////////////////////////////////////////////////

Function CheckStandingHeight(who)
  SendSysMessagePergon(who, "Bitte einfach wohinklickern!", "");

  Var location:=TargetCoordinates(who);
  If (location)
    Var z:=GetStandingHeight(location.x, location.y, who.z).z;
    SysLog("x "+location.x+", y "+location.y+", z "+location.z+" => "+z);

    Var npc:=CreateNPCFromTemplate("horse", who.x, who.y, who.z);
    If (npc)
      SysLog("  Move = "+MoveObjectToLocation(npc, location.x, location.y, z, npc.realm));

      Sleep(2);
      KillMobile(npc, "TextCMD Test-CheckStandingHeight");
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////
// Wetter_anschalten - Fuer alle Spieler das Wetter einschalten
/////////////////////////////////////////////////////////////////

Function Wetter_anschalten()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      Var charnr;
      For (charnr:=1; charnr<=5; charnr:=charnr+1)
        Var char:=account.getcharacter(charnr);
        If (char)
          SetObjProperty(char, "Wetter", 1);
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////
// HebeTeppich - Hebt den Teppich um jeweils 1 Pixel an
/////////////////////////////////////////////////////////

Function HebeTeppich(who)
  ForEach item in ListObjectsInBox(2307, 1107, 0, 2320, 1114, 20)
    If (item.isa(POLCLASS_ITEM))
      If ((0xab3<=item.objtype) And (item.objtype<=0xabc))
        If (item.z in {0, 20})
          item.movable:=1;
          MoveObjectToLocation(item, item.x, item.y, item.z+1, item.realm, MOVEOBJECT_FORCELOCATION);
          item.movable:=0;
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////
// VersenkeItems - Versenke Items auf Bodenhoehe
//////////////////////////////////////////////////

Function VersenkeItems(who)
  ForEach item in ListObjectsInBox(4806, 602, 0, 4840, 646, 15)
    If (((0xc45<=item.objtype) And (item.objtype<=0xc4e)) Or (item.objtype in {0xd29, 0xd2b, 0xd2d, 0xd2f}))
   // If ((item.x>4827) Or (item.x<4819))
   //   If ((item.y>624) Or (item.y<619))
        item.movable:=1;
        MoveObjectToLocation(item, item.x, item.y, GetWorldHeight(item.x, item.y), item.realm, MOVEOBJECT_FORCELOCATION);
       // item.movable:=0;
   //   EndIf
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////
// ListUsableNPCTemplates - Listet alle vorhandenen NPC-Templates auf
///////////////////////////////////////////////////////////////////////

Function ListUsableNPCTemplates(who)
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    Var template;

    ForEach templatename in GetConfigStringKeys(npcdesc)
      template:=npcdesc[templatename];

      If (template.objtype in {0x190, 0x191})
        SysLog(templatename+"   -> "+template.name);
      EndIf
    EndForEach

    ForEach templatename in GetConfigStringKeys(npcdesc)
      template:=npcdesc[templatename];

      If (!(template.objtype in {0x190, 0x191}))
        SysLog(templatename+"   -> "+template.name);
      EndIf
    EndForEach
  EndIf
EndFunction

/////////////////////////////////////////////////////////////
// SpectatorTest - Testet die Funktionsweise des Spectators
/////////////////////////////////////////////////////////////

Function SpectatorTest(who)
  // Den Spectator ueber das Einloggen informieren
  Var Spectator:=GetGlobalProperty("#Spectator");
  If (Spectator)
    // Logoff
    Var spectatorev:={};
    spectatorev.+type:="logoff";
    spectatorev.+value:={who.acctname, who.name, who.name+" hat sich ausgeloggt"};

    GetProcess(Spectator).sendevent(spectatorev);

    // Logon
    spectatorev:={};
    spectatorev.+type:="logon";
    spectatorev.+value:={who.acctname, who.name, who.name+" hat sich eingeloggt"};

    GetProcess(Spectator).sendevent(spectatorev);

    // Listener
    spectatorev:={};
    spectatorev.+type:="statistik";
    spectatorev.+value:={who.x, who.y, who.name+" ["+who.x+", "+who.y+"] blubber"};

    GetProcess(Spectator).sendevent(spectatorev);

    // Msg
    spectatorev:={};
    spectatorev.+type:="msg";
    spectatorev.+value:={who.acctname, who.acctname, who.name+" -> "+who.name+": blubber"};

    GetProcess(Spectator).sendevent(spectatorev);

    // SayAbove
    spectatorev:={};
    spectatorev.+type:="sayabove";
    spectatorev.+value:={who.acctname, who.acctname, who.name+" ueber "+who.name+": blubber"};

    GetProcess(Spectator).sendevent(spectatorev);
  EndIf
EndFunction

//////////////////////////////////////////////////
// ListCMDLevelChars - Listet alle CMDLevelChars
//////////////////////////////////////////////////

Function ListCMDLevelChars()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (char.cmdlevel)
            If (char.cmdlevel>=CMDLEVEL_SEER)
              LogToFile("log/cmdlevelchars.log", char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+
                char.serial+";"+account.getprop(PLAYEREMAIL)+";"+CInt((ReadGameClock()-GetObjProperty(char, "LastLog"))/86400));
            Else
              LogToFile("log/questchars.log", char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+
                char.serial+";"+account.getprop(PLAYEREMAIL)+";"+CInt((ReadGameClock()-GetObjProperty(char, "LastLog"))/86400));
            EndIf
          EndIf
        EndIf
      EndFor
    Else
      LogToFile("log/cmdlevelchars.log", "'"+accountname+"' gibt es nicht !");
      LogToFile("log/questchars.log", "'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////
// DegradeCMDLevelChars - CMDLevel-Chars degradieren
//////////////////////////////////////////////////////

Function DegradeCMDLevelChars()
  ForEach cmdlevelchar in {{"Iwan", 0}, {"Pider21", 0}, {"Jerry", 2}, {"Crusher", 1}, {"agtmulda", 2}, {"seb02", 2}, {"lys_xy1", 0},
    {"syzygy", 0}, {"kaputt", 0}, {"susi", 3}, {"zad", 1}, {"hotny", 1}, {"Flexball", 3}, {"sunflower", 1}, {"Morgan", 1},
    {"Kalamit", 2}, {"MassivFreak", 2}, {"Patrick", 1}}
    Var account:=FindAccount(cmdlevelchar[1]);
    If (account)
      Var char:=account.getcharacter(cmdlevelchar[2]+1);
      If (char)
        LogToFile("log/degradecmdlevelchars.log", char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+cmdlevelchar[1]+";"+char.name);
        char.cmdlevel:=CMDLEVEL_PLAYER;
      Else
        LogToFile("log/degradecmdlevelchars.log", "'"+cmdlevelchar[1]+"'."+cmdlevelchar[2]+" gibt es nicht !");
      EndIf
    Else
      LogToFile("log/degradecmdlevelchars.log", "'"+cmdlevelchar[1]+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////////////
// GrantPrivsToCMDLevelChars - Vergibt bestimmte Rechte an CMDLevelChars
//////////////////////////////////////////////////////////////////////////

Function GrantPrivsToCMDLevelChars()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (char.cmdlevel>=CMDLEVEL_GM)
            GrantPrivilege(char, "seehidden");char.enable("seehidden");
            GrantPrivilege(char, "seeghosts");char.enable("seeghosts");
            GrantPrivilege(char, "hearghosts");char.enable("hearghosts");

            SysLog(char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+char.serial+";"+account.getprop(PLAYEREMAIL));
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////////////////
// DetectOnlineCMDLevelCharsSince - Welcher CMDLevel-Char war online seit...
//////////////////////////////////////////////////////////////////////////////

Function DetectOnlineCMDLevelCharsSince(who)
  Var sincegameclock:=163726929; // Kiste 0x42895d28

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (char.cmdlevel)

           // SysLog(CInt(GetObjProperty(char, "LastLog"))+" <=> "+sincegameclock+" / "+char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+char.serial+";"+account.getprop(PLAYEREMAIL));

            If (CInt(GetObjProperty(char, "LastLog"))>sincegameclock)
              SysLog(char.cmdlevel+";"+GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+char.serial+";"+account.getprop(PLAYEREMAIL));
            EndIf
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////
// ListChars - Listet alle Chars
//////////////////////////////////

Function ListChars()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          SysLog(GetCMDLevelTitle(char.cmdlevel)+";"+accountname+";"+char.name+";"+char.serial+";"+account.getprop(PLAYEREMAIL));
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////////////////
// TestCountActiveCharacters - Wieviele Character wurden in letzter Zeit benutzt?
///////////////////////////////////////////////////////////////////////////////////

Function TestCountActiveCharacters()
  Var zahlen:=CountActiveCharacters();

  SysLog("Accounts/Character-Statistik ('aktiv' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" aktive Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" aktive Character, davon "+zahlen[9]+" mit CommandLevel.");
EndFunction

//////////////////////////////////////////////////////////////////////////////
// ListInconsistentItems - Listet Items auf, die es so nicht mehr geben darf
//////////////////////////////////////////////////////////////////////////////

Function ListInconsistentItems(who, params)
 // Var lootgroup:=SendTextEntryGump(who, "Welche LootGroup soll erzeugt werden?", TE_CANCEL_ENABLE, TE_STYLE_NORMAL, 100);
 // If (lootgroup)
 //   Var bag:=CreateItemInContainerPergon(who.backpack, "bag", 1);
 //   If (bag)
 //     SendOpenSpecialContainer(who, bag);
 //     MakeLoot(bag, lootgroup);
 //   EndIf
 // EndIf

 // ForEach item in EnumerateItemsInContainer(who.backpack)
 //   DestroyItem(item);
 // EndForEach
 //
 // CreateStartingEquipment(who, {GetSkillName(params)});

 // SendPacket(who, params);

 // OpenPergonHompPage(who);
  OpenURL(who, params);

 // CreateStartingEquipment(who, {"Magery"});
  Return; // Wenn in der Funktion nichts drinsteht, dann Crasht er
EndFunction

///////////////////////////////////////////////////////////////////////////////////
// SetSpellPanelMatrix - Die Matrix des SpellPanels komplett fuellen (DemoZwecke)
///////////////////////////////////////////////////////////////////////////////////

Function SetSpellPanelMatrix(who)
  SendSysMessagePergon(who, "Bitte ein Zauberbuch anklicken", "");

  Var spellbook:=Target(who);
  If (spellbook.isa(POLCLASS_ITEM))
    If (spellbook.objtype in {UOBJ_SPELLBOOK_MAGE, UOBJ_SPELLBOOK_CLERIC, UOBJ_SPELLBOOK_NECRO})
      Var matrix:={}; // Matrix der Spells auf dem Panel (Zeile x Spalte)
      Var spellid:=1;

      // Matrix zur Demonstration fuellen
      For zeile:=1 To 8
        Var spellzeile:={}; // Eine komplette SpellZeile

        // SpellZeile fuellen
        For spalte:=1 To 8
          spellzeile.append(spellid);
          spellid:=spellid+1;
        EndFor

        matrix.append(spellzeile);
      EndFor

      // Panel anlegen
      Var spellpanel:=CreateItemInContainerPergon(spellbook, UOBJ_SPELLPANEL);
      If (spellpanel)
        SetObjProperty(spellpanel, "Data", {30, 30, 1, matrix});
      EndIf
    Else
      SendSysMessagePergon(who, "Dies ist kein Zauberbuch!", "");
    EndIf
  Else
    SendSysMessagePergon(who, "Dies ist kein Gegenstand!", "");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////////////////
// ConvertSendPacketLine - Konvertiert eine SendPacket-Anweisung zurueck in was lesbares
//////////////////////////////////////////////////////////////////////////////////////////

Function ConvertSendPacketLine(who)
  Var LinePart01:="b0 0651 0134ef05 000001cd 0000000f 0000000f 0188";
  Var LinePart02:="7b20706167652030207d7b206e6f636c6f7365207d7b20726573697a6570696320333020323020323632302032323020333830207d7b20636865636b65727472616e732033352032372032313020333636207d7b20786d6668746d6c67756d702034352033302031393020313030203130343633303120302030207d7b20786d6668746d6c67756d70203435203133352031393020313630203130343633303220302030207d7b20786d6668746d6c67756d702038352033313620313430203330203130343633303320302030207d7b20627574746f6e2035302033313520343030352034303037203120302031207d7b20786d6668746d6c67756d702038352033343720313430203435203130343633303420302030207d7b20627574746f6e2035302033353220343030352034303037203120302032207d7b20726573697a6570696320302034302032363230203430203830207d7b20636865636b65727472616e732035203437203330203636207d7b2074696c6570696320302035332038343534207d00";
  Var LinePart03:="0004 00bc";
  Var LinePart04:="003c0042004f00440059003e003c00420041005300450046004f004e005400200043004f004c004f0052003d0023004600460030003000300030003e0055006d002e002e002e002000650072002e002e002e0020006700720065006500740069006e00670073002e00200049002e002e002e00200075006d002e002e002e002000680061006400200073006f006d006500200067006f006c00640020007400680061007400200049002000770061007300200073007500700070006f00730065006400200074006f0020006700690076006500200079006f0075002e002e002e00200067006f006c006400200063006f0075007200740065007300790020006f006600200055007a0065007200610061006e002c002000770068006f00270073002000610020006d00610067006500200079006f00750027006c006c0020006d0065006500740020006c0061007400650072002e003c002f00420041005300450046004f004e0054003e003c002f0042004f00440059003e";
  Var LinePart05:="0109";
  Var LinePart06:="003c0042004f00440059003e003c00420041005300450046004f004e005400200043004f004c004f0052003d0023004600460030003000300030003e004200750074002c0020007900610020007300650065002c0020006f006e00650020006f0066002000740068006f007300650020006d006f006e006700620061007400730020006f00760065007200200074006800650072006500200074006f006f006b002000740068006500200067006f006c0064002000660072006f006d0020006d00650020006a0075007300740020006200650066006f0072006500200079006f007500200061007200720069007600650064002e002000490020007400680069006e006b00200079006f00750027006c006c002000620065002000610062006c006500200074006f0020006700650074002000740068006500200067006f006c00640020006200610063006b002000660072006f006d0020007400680065002000630072006500610074007500720065002e00200044006f006e0027007400200077006f007200720079002c00200049002000630061006e00200074006500610063006800200079006f007500200073006f006d00650020007400680069006e0067007300200079006f00750027006c006c0020006e00650065006400200074006f0020006b006e006f0077002e003c002f00420041005300450046004f004e0054003e003c002f0042004f00440059003e";
  Var LinePart07:="0041";
  Var LinePart08:="003c0042004f00440059003e003c00420041005300450046004f004e005400200043004f004c004f0052003d0023004400460044004600430030003e00410063006300650070007400200074006800690073002000510075006500730074003c002f00420041005300450046004f004e0054003e003c002f0042004f00440059003e";
  Var LinePart09:="004f";
  Var LinePart10:="003c0042004f00440059003e003c00420041005300450046004f004e005400200043004f004c004f0052003d0023004400460044004600430030003e0053006b006900700020007400680069007300200051007500650073007400200061006e006400200067006f00200074006f00200048006100760065006e003c002f00420041005300450046004f004e0054003e003c002f0042004f00440059003e";

  Var LayoutLine:=LinePart02;
  Var DataLines:={LinePart04, LinePart06, LinePart08, LinePart10};



EndFunction

////////////////////////////////////////////////////////////////
// NPCDeathNameTest - Tests bezueglich der Namen toter Viecher
////////////////////////////////////////////////////////////////

Function NPCDeathNameTest(who)
  SendSysMessagePergon(who, "Wessen Vitals sollen neu berechnet werden?", "");

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_MOBILE))
    RecalcVitals(mobile);
  EndIf

 // SendSysMessagePergon(who, "Wessen Namen wollen sie analysieren?", "");
 //
 // Var object:=Target(who);
 // If (object)
 //   SendSysMessagePergon(who, "Das heisst >>>"+object.name+"<<< / >>>"+object.desc+"<<<", "");
 // EndIf
EndFunction

/////////////////////////////////////////////////////////////////////////
// CheckSkillGainFunctions - Ermittelt die zugrundeliegenden Funktionen
/////////////////////////////////////////////////////////////////////////

Function CheckSkillGainFunctions(who)
  For basevalue:=700 To 900
    SysLog("  "+basevalue+" = "+BaseSkillToRawSkillPergon(basevalue)+" - "+BaseSkillToRawSkillPergonTest(basevalue)+" = "+
      (BaseSkillToRawSkillPergon(basevalue)-BaseSkillToRawSkillPergonTest(basevalue)));
  EndFor
EndFunction

////////////////////////////////////////////////////////////////
// BaseSkillToRawSkillPergonOld - Nachbau der Originalfunktion
////////////////////////////////////////////////////////////////
//
// Bis auf einen kleinen Fehler... perfekt
// ...viel zu kompliziert - mal nach was Ähnlichem suchen

Function BaseSkillToRawSkillPergonOld(origbasevalue)
  origbasevalue:=CInt(origbasevalue);
  Var basevalue:=CDbl(origbasevalue)/10;
  Var basediv10value:=CInt(origbasevalue/100);
  Var lowexpvalue:=Pow(2, basediv10value+10);

  Var rawvalue;
  If (origbasevalue<200)
    rawvalue:=CInt(origbasevalue*20.48); // +basediv10value*20.48
  Else
    If (basevalue=basediv10value*10)
      rawvalue:=lowexpvalue;
    Else
      If (CDbl(origbasevalue)/25=origbasevalue/25)
        If (CDbl(origbasevalue)/100=origbasevalue/100)
          rawvalue:=CInt(lowexpvalue*(1+(CDbl(basevalue)-(basediv10value*10))/10))+CInt(CDbl(lowexpvalue)/100);
        Else
          rawvalue:=CInt(lowexpvalue*(1+(CDbl(basevalue)-(basediv10value*10))/10));                             // Alle 25er, die keine 100er sind
        EndIf
      Else
        rawvalue:=CInt(lowexpvalue*(1+(CDbl(basevalue)-(basediv10value*10))/10))+CInt(CDbl(lowexpvalue)/100);
      EndIf
    EndIf
  EndIf

  Return (rawvalue);
EndFunction

/////////////////////////////////////////////////////////////
// BaseSkillToRawSkillPergon - Nachbau der Originalfunktion
/////////////////////////////////////////////////////////////

Function BaseSkillToRawSkillPergonTest(basevalue)
  basevalue:=Ceil(basevalue); // Nachkommastellen abschnippeln

  Var rawvalue;
  If (basevalue<200)
    rawvalue:=CInt(basevalue*20.48);
  ElseIf (basevalue<700)
    rawvalue:=CInt(Pow(2, basevalue/100+10));
  Else // Abflachung
    rawvalue:=CInt(Pow(2, basevalue/100+10));
  EndIf

  Return (rawvalue);
EndFunction

///////////////////////////////////////////////////////////////////////////
// SetMissingWerkzeugMaxHP - Ergaenzt die MaxHP-Werte zur Preisbestimmung
///////////////////////////////////////////////////////////////////////////

Function SetMissingWerkzeugMaxHP(who)
  SendSysMessagePergon(who, "Bitte den Beutel mit den enthaltenen Dietrichen auswaehlen!", "");

  Var beutel:=Target(who);
  If (beutel.isa(POLCLASS_CONTAINER))
    ForEach item in EnumerateItemsInContainer(beutel)
      If (item.objtype=0x14fb)
        Var werkzeug:=GetObjProperty(item, "Werkzeug");
        If (werkzeug)
          werkzeug[2]:=10;werkzeug[3]:=10;werkzeug[5]:=10;
          SetObjProperty(item, "Werkzeug", werkzeug);
        EndIf
      EndIf
    EndForEach
  Else
    SysLog("Abbruch");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////
// FixWerkzeugRepairSkill - Korrigiert fehlerhaften RepairSkill
/////////////////////////////////////////////////////////////////

Function FixWerkzeugRepairSkill(who, params)
  SendSysMessagePergon(who, "Bitte den Gegenstand auswaehlen!", "");

  Var item:=Target(who);
  If (item.isa(POLCLASS_ITEM))
    Var werkzeug:=GetObjProperty(item, "Werkzeug");
    If (werkzeug)
      werkzeug[werkzeug.size()-1]:=CInt(params);
      SetObjProperty(item, "Werkzeug", werkzeug);
    EndIf
  Else
    SysLog("Abbruch");
  EndIf
EndFunction

/////////////////////////////////////////
// TestReserveRelease - Etwas rumtesten
/////////////////////////////////////////

Function TestReserveRelease(who)
  SendSysMessagePergon(who, "Bitte ein Item auswaehlen!", "");

  Var item:=Target(who);
  If (item.isa(POLCLASS_ITEM))
    SysLog("ReserveItem1 = "+ReserveItem(item));
    SysLog("ReleaseItem1 = "+ReleaseItem(item));

    SysLog("ReserveItem1 = "+ReserveItem(item));
    SysLog("ReserveItem2 = "+ReserveItem(item));
    SysLog("ReleaseItem2 = "+ReleaseItem(item));
    SysLog("ReleaseItem1 = "+ReleaseItem(item));
  Else
    SysLog("Abbruch");
  EndIf
EndFunction

///////////////////////////////////////////////////
// DupliziereBackpackItems - Kopiert das Backpack
///////////////////////////////////////////////////

Function DupliziereBackpackItems(who)
  Var opfer:=who;
  Var opferitems:=EnumerateItemsInContainer(who.backpack);
  Var thiefbackpack:=Target(who);

  ForEach item in EnumerateItemsInContainer(thiefbackpack) // Items im versteckten Backpack entfernen (nur Sicherheitshalber, eigentlich isses leer)
    If (item.container.serial=thiefbackpack.serial) // Nur die Top-Level-Items, da sich der Rest rekursiv mitloescht
      DestroyItem(item);
    EndIf
  EndForEach

  Var newcontainer:={thiefbackpack}; // Liste der neuen Container, verschachtelungstechnisch
  Var oldcontainer:={who.backpack};  // Liste der neuen Container, verschachtelungstechnisch

  Var itemkopie;
  ForEach item in opferitems // Alle Items des Backpacks
    While (item.container.serial<>oldcontainer[1].serial) // Erstmal den Container in der Liste suche
      oldcontainer.erase(1);                              // Noe, eine Ebene hoeher gehen
      newcontainer.erase(1);
    EndWhile

    If ((0x1f2d<=item.objtype) And (item.objtype<=0x1f6c))                                      // Die alten Spruchrollen (nur noch von NPCs genutzt)
      itemkopie:=CreateItemInContainerPergon(newcontainer[1], 0xe35+RandomInt(6), item.amount); //   -> "unechte" Kopien erzeugen
    ElseIf ((0x14eb<=item.graphic) And (item.graphic<=0x14f2))                                  // Alles was nach Karte/Berechtigungsschein "aussieht"
      itemkopie:=CreateItemInContainerPergon(newcontainer[1], item.graphic, item.amount);       //   -> "unechte" Kopien erzeugen
    Else
      itemkopie:=CreateItemInContainerPergon(newcontainer[1], item.objtype, item.amount);       // Alle anderen Items duplizieren
    EndIf

    If (itemkopie)
      itemkopie.movable:=0;          // Sonstige Eigenschaften uebernehmen
      itemkopie.newbie:=item.newbie;
      itemkopie.color:=item.color;
      itemkopie.desc:=item.desc;

      SetObjProperty(itemkopie, "realitem", item.serial);  // Welches OriginalItem ist damit verknuepft?
      SetObjProperty(itemkopie, "markinfo", opfer.serial); // Wem gehoert dieses Item?

      If (item.isa(POLCLASS_CONTAINER))    // 'n neuer Container, also eine Rekursionsebene dazubasteln
        oldcontainer.insert(1, item);      // Listen ergaenzen
        newcontainer.insert(1, itemkopie);
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////
// CheckPol095Bugs - Testet bestimmte Bugs in Pol095
//////////////////////////////////////////////////////

Function CheckPol095Bugs(who)
  EraseObjProperty(who, "blubb");
  ForEach blubb in GetObjProperty(who, "blubb")
    SysLog(blubb);
  EndForEach
  If (GetObjProperty(who, "blubb"))
    SysLog("1");
  Else
    SysLog("2");
  EndIf
  If (GetObjProperty(who, "blubb")==Error)
    SysLog("3");
  Else
    SysLog("4");
  EndIf

  // Verschiedenste Tests
  Var speechconfig:=ReadConfigFile("speech/messageoftheday");
  If (speechconfig)
    SysLog("GetConfigIntKeys             -> "+GetConfigIntKeys(speechconfig));                   // keine IntKeys    -> { }
  Else
    SysLog("GetConfigIntKeys...          ConfigFile nicht gefunden");
  EndIf

  Var container:=CreateItemAtLocationPergon(5273+RandomInt(17), 1181+RandomInt(9), 0, 0xe75, 1);
  If (container)
    SysLog("EnumerateItemsInContainer    -> "+EnumerateItemsInContainer(container));             // leerer Container -> { }
    DestroyItem(container);
  Else
    SysLog("EnumerateItemsInContainer... konnte den Container nicht erzeugen");
  EndIf

  container:=CreateItemAtLocationPergon(5273+RandomInt(17), 1181+RandomInt(9), 0, 0xf13, 1);
  If (container)
    SysLog("EnumerateItemsInContainer    -> "+EnumerateItemsInContainer(container));             // kein Container   -> <uninitialized object>
  Else
    SysLog("EnumerateItemsInContainer... konnte den NICHT-Container nicht erzeugen");
  EndIf

  SysLog("EnumerateOnlineCharacters    -> "+EnumerateOnlineCharacters());                        // keine Chars      -> { }

  Var mobile:=CreateNpcFromTemplate("dog", 5273+RandomInt(17), 1181+RandomInt(9), 0);
  If (mobile)
    SysLog("ListEquippedItems            -> "+ListEquippedItems(mobile));                        // kein Item        -> { }
  Else
    SysLog("ListEquippedItems...         konnte keinen NPC erzeugen");
  EndIf
  SysLog("ListEquippedItems            -> "+ListEquippedItems(container));                       // falscher ObjTyp  -> error{ errortext = "Invalid parameter" }

  SysLog("ListItemsNearLocation        -> "+ListItemsNearLocation(0, 0, 0, 0));                  // kein Item        -> { }
  SysLog("ListItemsNearLocationOfType  -> "+ListItemsNearLocationOfType(0, 0, 0, 0, 0xf13));     // kein Item        -> { }
  SysLog("ListMobilesInLineOfSight     -> "+ListMobilesInLineOfSight(mobile, 0));                // kein Mobile      -> { }
  SysLog("ListMobilesInLineOfSight     -> "+ListMobilesInLineOfSight(container, 0));             // kein Mobile      -> { }
  SysLog("ListObjectsInBox             -> "+ListObjectsInBox(0, 0, 0, 0, 0, 0));                 // kein Item        -> { }
  SysLog("GetObjProperty               -> "+GetObjProperty(container, "blubba"));                // keine CProp      -> error{ errortext = "Property not found" }
  SysLog("GetObjPropertyNames          -> "+GetObjPropertyNames(container));                     // keine CProps     -> { }
  SysLog("GetGlobalProperty            -> "+GetGlobalProperty("blubba"));                        // keine GlobalProp -> error{ errortext = "Property not found" }
  DestroyItem(container);

  SysLog("SplitWords                   -> "+SplitWords(""));                                     // Leerstring       -> { }
  SysLog("SplitWords                   -> "+SplitWords(0));                                      // Zahl             -> { 0 }
  SysLog("ListItemsAtLocation          -> "+ListItemsAtLocation(0, 0, 0));                       // kein Item        -> { }

  Var elem:=speechconfig["Begruessung"];
  If (elem)
    SysLog("GetConfigStringArray         -> "+GetConfigStringArray(elem, "Blubba"));             // kein Element     -> { }
  Else
    SysLog("GetConfigStringArray...      konnte das Element nicht finden");
  EndIf

  Var itemconfig:=ReadConfigFile("itemdesc");
  If (itemconfig)
    SysLog("GetConfigStringKeys          -> "+GetConfigIntKeys(itemconfig));                     // keine StringKeys -> { }
  Else
    SysLog("GetConfigStringKeys...       ConfigFile nicht gefunden");
  EndIf

  SysLog("ListMobilesNearLocation        -> "+ListMobilesNearLocation(0, 0, 0, 0));              // kein Mobile      -> { }
  SysLog("ListMobilesNearLocationEx      -> "+ListMobilesNearLocationEx(0, 0, 0, 0, 0));         // kein Mobile      -> { }
  SysLog("ListHostiles                   -> "+ListHostiles(mobile));                             // kein Mobile      -> { }
  SysLog("ListAccounts                   -> "+ListAccounts());                                   // kein Account     -> { }
  SysLog("ListGhostsNearLocation         -> "+ListGhostsNearLocation(0, 0, 0, 0));               // kein Mobile      -> { }

  SysLog("<ForEach>");
  Var huhu:="huhu";
  ForEach blubb in huhu
    SysLog("  blubb");                                                                           // kein Array       -> nix
  EndForEach
  SysLog("<EndForEach>");

// EnumerateItemsInContainer   -> leerer Container -> { }
// EnumerateItemsInContainer   -> kein Container   -> <uninitialized object>
// EnumerateOnlineCharacters   -> keine Chars      -> { }
// GetConfigIntKeys            -> keine Int-Keys   -> { }
// GetConfigStringArray        -> kein Element     -> { }
// GetConfigStringKeys         -> keine StringKeys -> { }
// GetGlobalProperty           -> keine GlobalProp -> error{ errortext = "Property not found" }
// GetObjProperty              -> keine CProp      -> error{ errortext = "Property not found" }
// GetObjPropertyNames         -> keine CProps     -> { }
// ListAccounts                -> kein Account     -> { }
// ListEquippedItems           -> kein Item        -> { }
// ListEquippedItems           -> falscher ObjTyp  -> error{ errortext = "Invalid parameter" }
// ListGhostsNearLocation      -> kein Mobile      -> { }
// ListHostiles                -> kein Mobile      -> { }
// ListItemsAtLocation         -> kein Item        -> { }
// ListItemsNearLocation       -> kein Item        -> { }
// ListItemsNearLocationOfType -> kein Item        -> { }
// ListMobilesInLineOfSight    -> kein Mobile      -> { }
// ListMobilesInLineOfSight    -> kein Mobile      -> { }
// ListMobilesNearLocation     -> kein Mobile      -> { }
// ListMobilesNearLocationEx   -> kein Mobile      -> { }
// ListObjectsInBox            -> kein Item        -> { }
// SplitWords                  -> Leerstring       -> { }
// SplitWords                  -> Zahl             -> { 0 }
// ForEach                     -> kein Array       -> nix

EndFunction

///////////////////////////////////////////////////////
// CheckPol095Bugs2 - Testet bestimmte Bugs in Pol095
///////////////////////////////////////////////////////

Function CheckPol095Bugs2(who)
  // SendSysMessagePergon(who, CInt((3*1.01*0)/(1.01*0))+" ", "");

  Var mana:=CInt(35);

  SysLog(CInt(GetSkillPergon(who, SKILLID_SPRUCHZAUBEREI) / 80 * SAVE_MANA_AMNT * mana));
  SysLog(CInt(GetSkillPergon(who, SKILLID_SPRUCHZAUBEREI) / 80.0 * SAVE_MANA_AMNT * mana));
  SysLog(CInt(SAVE_MANA_AMNT * mana * GetSkillPergon(who, SKILLID_SPRUCHZAUBEREI) / 80));
  SysLog(CInt(CDbl(GetSkillPergon(who, SKILLID_SPRUCHZAUBEREI)) / 80 * SAVE_MANA_AMNT * mana));
  SysLog(CInt(GetSkillPergon(who, SKILLID_SPRUCHZAUBEREI) / 80 * SAVE_MANA_AMNT * CDbl(mana)));

  // Linux: -2147483648
  // Win:   0

 // Var item:=Target(who);
 // item.buyprice:=CInt((3*1.01*0)/(1.01*0));
 // SendSysMessagePergon(who, CInt((3*1.01*0)/(1.01*0))+" "+item.buyprice, "");

  Return;
EndFunction

//////////////////////////////////////////////////////////////
// CheckPol095Features - Testet bestimmte Features in Pol095
//////////////////////////////////////////////////////////////

Function CheckPol095Features(who, text)
  text:=CInt(text);
  If (text)
    SendSysMessagePergon(who, "Bei welchem Mobile soll die RunSpeed auf "+text+" gesetzt werden?", "");

    Var mobile:=Target(who);
    If (mobile)
      SetObjProperty(mobile, "OverrideHits", text);
      RecalcVitals(mobile);
    Else
      SendSysMessagePergon(who, "Abbruch", "Abort");
    EndIf
  Else
    SendSysMessagePergon(who, "Bitte eine Geschwindigkeit angeben!", "");
  EndIf
EndFunction

/////////////////////////////////////////////////////////
// LogActivePlayerGM - Namen der aktiven Leutz ausgeben
/////////////////////////////////////////////////////////

Function LogActivePlayerGM()
  CountActiveCharacters(1);
EndFunction

/////////////////////////////////////////////////////////////////////////
// CountBackpackItems - Wieviele Items traegt der Spieler mit sich rum?
/////////////////////////////////////////////////////////////////////////

Function CountBackpackItems(who)
  SendSysMessagePergon(who, "Waehlt bitte den Spieler aus!", "");

  Var player:=Target(who);
  If (player.isa(POLCLASS_MOBILE) And (!player.isa(POLCLASS_NPC)))
    SendSysMessagePergon(who, "Im Backpack ("+Lower(Hex(player.backpack.objtype))+
      ") befinden sich "+EnumerateItemsInContainer(player.backpack).size()+" Items.", "");
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

//////////////////////////////////////////////////////
// LogInterestingStuff - Gibt interessante Infos aus
//////////////////////////////////////////////////////

Function LogInterestingStuff(who)
 // LogContainerMaxProperties();

  // Wieviele Character wurden in letzter Zeit benutzt?
  SysLog("Accounts/Character-Statistik ('aktiv')");
  Var zahlen:=CountActiveCharacters(1);
  SysLog("Accounts/Character-Statistik ('aktiv' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" aktive Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" aktive Character, davon "+zahlen[9]+" mit CommandLevel.");

  // Wieviele Character wurden in letzter Zeit nicht benutzt?
  SysLog("Accounts/Character-Statistik ('inaktiv')");
  zahlen:=CountInActiveCharacters(1);
  SysLog("Accounts/Character-Statistik ('inaktiv' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" inaktive Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" inaktive Character, davon "+zahlen[9]+" mit CommandLevel.");

  // Wieviele Character wurden sehr lange nicht benutzt?
  SysLog("Accounts/Character-Statistik ('antik')");
  zahlen:=CountInActiveCharacters(1, ANCIENT_TIME);
  SysLog("Accounts/Character-Statistik ('antik' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" antike Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" antike Character, davon "+zahlen[9]+" mit CommandLevel.");

  // Wieviele ungenutze Accounts gibt es?
  SysLog("Accounts-Statistik (ungenutzt)");
  zahlen:=CountUnusedAccounts();
  SysLog("Accounts-Statistik");
  SysLog("  "+zahlen[1]+" Accounts, davon "+zahlen[2]+" ungenutzt");

  // Wieviele Character wurden in letzter Zeit benutzt?
  zahlen:=CountActiveCharacters();
  SysLog("Accounts/Character-Statistik ('aktiv' -> in "+Format_Time(zahlen[1])+" benutzt)");
  SysLog("  "+zahlen[2]+" Accounts, davon "+zahlen[3]+" mit CommandLevel-Character - "+zahlen[4]+" aktive Accounts, davon "+zahlen[5]+" mit CommandLevel-Character,");
  SysLog("  "+zahlen[6]+" Character, davon "+zahlen[7]+" mit CommandLevel - "+zahlen[8]+" aktive Character, davon "+zahlen[9]+" mit CommandLevel.");

  // Erstellt eine Liste der CMDLevel-Character
  SysLog("CMDLevel-Character");
  ListCMDLevelCharacterInfo();

  // Alle eMail-Adressen auflisten
  SysLog("eMail-Adressen");
  ListeMailAddresses();

  // Sucht verlasse NPCs von Charactern
  FindLonelyCharacterNPCs();
EndFunction

/////////////////////////////////////////////////////////////
// ListNPCTemplateNames - Listet alle NPCTemplate-Namen auf
/////////////////////////////////////////////////////////////

Function ListNPCTemplateNames()
  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    ForEach templatename in GetConfigStringKeys(npcdesc)
      SysLog("  "+templatename+";"+npcdesc[templatename].name);
    EndForEach
  EndIf
EndFunction

///////////////////////////////////////////////
// ListNPCs - Listet alle NPCs eines Typs auf
///////////////////////////////////////////////

Function ListNPCs()
  ForEach mobile in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (mobile.isa(POLCLASS_NPC))
      If Lower((mobile.npctemplate)=="playervendor")
        SysLog("  "+mobile.name+" "+mobile.x+" "+mobile.y+" "+mobile.z);
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////
// ChangeNPCScript - Aendert das Script bestimmter NPCs
/////////////////////////////////////////////////////////

Function ChangeNPCScript()
  ForEach mobile in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (mobile.isa(POLCLASS_NPC))
      If (Lower(mobile.script)=="grazer")
        mobile.script:="grazer_new";
        RestartScript(mobile);

        SysLog("  "+mobile.name+" "+mobile.npctemplate+" "+mobile.x+" "+mobile.y+" "+mobile.z);
      EndIf
    EndIf
  EndForEach

//  ForEach mobile in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
//    If (mobile.isa(POLCLASS_NPC))
//      If (((Lower(mobile.npctemplate) in {"horse", "horse2", "horse3", "horse4", "horse_m", "horse_m2", "sheep", "sheep_m"}) And
//         (Lower(mobile.script)=="heaven") And (Lower(GetObjProperty(mobile, "script"))=="grazer")) Or ((Lower(mobile.npctemplate)=="wolf") And
//         (Lower(mobile.script)=="heaven") And (Lower(GetObjProperty(mobile, "script"))=="predator")))
//        SetObjProperty(mobile, "script", "main_ai");
//
//        SysLog("  "+mobile.name+" "+mobile.npctemplate+" heaven");
//      EndIf
//    EndIf
//  EndForEach
EndFunction

///////////////////////////////////////////
// RemoveAnchorProp - Entfernt alle Anker
///////////////////////////////////////////

Function RemoveAnchorProp()
  ForEach mobile in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (mobile.isa(POLCLASS_NPC))
      If (Lower(mobile.script)=="main_ai")
        EraseObjProperty(mobile, PROP_ANCHOR);
        RestartScript(mobile);

        SysLog("  "+mobile.name+" "+mobile.npctemplate+" "+mobile.x+" "+mobile.y+" "+mobile.z);
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////
// CheckItemProps - Prueft bestimmte Item-Props
/////////////////////////////////////////////////

Function CheckItemProps(who)
  SendSysMessagePergon(who, "Bitte eine Waffe oder Ruestung auswaehlen!", "");

  Var item:=Target(who);
  If (item.isa(POLCLASS_WEAPON) Or item.isa(POLCLASS_ARMOR))
    SysLog("  maxhp = "+item.maxhp);
    item.maxhp:=CInt(item.maxhp*1.7);
    SysLog("  maxhp = "+item.maxhp);
    item.maxhp:=item.maxhp*1.7;
    SysLog("  maxhp = "+item.maxhp);
    item.maxhp_mod:=CInt(item.maxhp*0.7);
    SysLog("  maxhp = "+item.maxhp);

    SysLog("  quality = "+item.quality);
    item.quality:=CInt(item.quality*1.7);
    SysLog("  quality = "+item.quality);
    item.quality:=item.quality*1.7;
    SysLog("  quality = "+item.quality);
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

///////////////////////////////////////////////////////
// DeleteWholeCharacter - Character komplett loeschen
///////////////////////////////////////////////////////

Function DeleteWholeCharacter()
  DeleteCharacterInAccount("DasThiel", "Cerbera");                     // Character finden und loeschen
  DeleteCharacterInAccount("Ephraim", "Scyleia");
  DeleteCharacterInAccount("Feanor", "Turambar");
  DeleteCharacterInAccount("Ioscha", "Ioscha");
  DeleteCharacterInAccount("jor", "Jormundgand");
  DeleteCharacterInAccount("Locus", "Der rote Anatom");
  DeleteCharacterInAccount("Thagor", "Thagor aus Minoc");
  DeleteCharacterInAccount("Trash", "Tjander");
  DeleteCharacterInAccount("veimol", "Kress aus Minoc");
  DeleteCharacterInAccount("Alcor", "Alcor");
  DeleteCharacterInAccount("Barney", "Barney");
  DeleteCharacterInAccount("bean", "Druss");
  DeleteCharacterInAccount("bean", "Logain");
 // DeleteCharacterInAccount("bier", "Nihilith");
  DeleteCharacterInAccount("Blackbird", "Blackbird");
  DeleteCharacterInAccount("blacki", "Polux");
  DeleteCharacterInAccount("blackmage", "Fenris N'hagost");
  DeleteCharacterInAccount("Bleio", "Serendorh");
  DeleteCharacterInAccount("darkwing", "Soltan Gris");
  DeleteCharacterInAccount("Dave", "Karlos aus Minoc");
  DeleteCharacterInAccount("Decan", "Decan");
  DeleteCharacterInAccount("Decan", "Morpheus");
  DeleteCharacterInAccount("demohn", "Osis Grymraev");
  DeleteCharacterInAccount("Der Guru", "Der Guru");
  DeleteCharacterInAccount("Der_Guru", "Guruglous");
  DeleteCharacterInAccount("Der_Guru", "Siddartha");
  DeleteCharacterInAccount("Dshihad", "Seraph Benegott");
  DeleteCharacterInAccount("Dusk", "Traugott Waldfried aus Vesper");
  DeleteCharacterInAccount("Ediskrad", "Ediskrad Revudyr");
  DeleteCharacterInAccount("fiat", "Mother");
  DeleteCharacterInAccount("fistklaus", "FistMaster Klaus");
  DeleteCharacterInAccount("fraggle", "GM Ba-naar");
  DeleteCharacterInAccount("GandoR", "Anthor");
  DeleteCharacterInAccount("geist", "Poltergeist");
  DeleteCharacterInAccount("goddog", "Oink");
  DeleteCharacterInAccount("hoosiak", "Istenius");
  DeleteCharacterInAccount("Kasimal", "Peraine");
  DeleteCharacterInAccount("Kuno", "Kuno");
  DeleteCharacterInAccount("Lothar-jr", "Janosch aus Minoc");
  DeleteCharacterInAccount("Lothar-jr", "Sakrisdor");
  DeleteCharacterInAccount("Marian", "Marian");
  DeleteCharacterInAccount("morbus", "morbus");
  DeleteCharacterInAccount("muck", "Igor Haudruf");
  DeleteCharacterInAccount("Naginata", "Morten Lynrev");
  DeleteCharacterInAccount("Pacmaker", "Thorapak");
  DeleteCharacterInAccount("Pacmaker", "Urthok aus Minoc");
  DeleteCharacterInAccount("Pauker", "Heinrich der Guetige aus Cove");
  DeleteCharacterInAccount("Pauker", "Paukusholzwurmus");
  DeleteCharacterInAccount("Phyrion", "Phyrion");
  DeleteCharacterInAccount("Pider21", "Werphor");
  DeleteCharacterInAccount("rcalpha", "Yggdrasil");
  DeleteCharacterInAccount("Roffo", "jfjj");
  DeleteCharacterInAccount("Roffo", "isaak");
  DeleteCharacterInAccount("roffomorph", "hfsh");
  DeleteCharacterInAccount("SacroBirius", "SacroBirius aus Minoc");
  DeleteCharacterInAccount("SacroBirius", "Galmorg");
  DeleteCharacterInAccount("Sethrik", "Sethrik");
  DeleteCharacterInAccount("Shinigami", "Testie");
  DeleteCharacterInAccount("Spika", "Megtanul");
  DeleteCharacterInAccount("steve", "Urza");
  DeleteCharacterInAccount("sting", "Bruder Bacchus");
  DeleteCharacterInAccount("Sufur", "Sufur aus Vesper");
  DeleteCharacterInAccount("Tenic", "Tenic aus Vesper");
  DeleteCharacterInAccount("tobik", "Arcturus");
  DeleteCharacterInAccount("tobik", "arcurus II");
  DeleteCharacterInAccount("tobir79", "Rossi");
  DeleteCharacterInAccount("Trachemys", "Schwarzer Ritter");
  DeleteCharacterInAccount("Unforgiven", "The Unforgiven aus Vesper");
  DeleteCharacterInAccount("Verdeloth", "Verdeloth");
  DeleteCharacterInAccount("VNation", "Sven der Metzger");
  DeleteCharacterInAccount("wabu", "Bolullu");
  DeleteCharacterInAccount("weiss", "Der weisse Ritter");
  DeleteCharacterInAccount("Whiskey", "General Carolinus Verhoeven");
  DeleteCharacterInAccount("Whiskey", "Kasterupps");
  DeleteCharacterInAccount("Whiskey", "xxx");
  DeleteCharacterInAccount("zampalo", "Palmstroem");
  DeleteCharacterInAccount("zordiak", "Zordiak");
  DeleteCharacterInAccount("Cordula", "Lerdina");
  DeleteCharacterInAccount("Cordula", "Gondor");
  DeleteCharacterInAccount("Cordula", "Vorsitzende des Stadtrates");
  DeleteCharacterInAccount("Firefox", "Manus");
  DeleteCharacterInAccount("Firefox", "AN.NU.NA.KI.");

  FindLonelyCharacterNPCs(1);                                          // Sucht verlasse NPCs von Charactern

  SysLog("Accounts-Statistik (ungenutzt)");                            // Wieviele ungenutze Accounts gibt es?
  Var zahlen:=CountUnusedAccounts();
  SysLog("Accounts-Statistik");
  SysLog("  "+zahlen[1]+" Accounts, davon "+zahlen[2]+" ungenutzt");
EndFunction

/////////////////////////////////////////////////////////////
// DeleteCharacterInAccount - Character finden und loeschen
/////////////////////////////////////////////////////////////

Function DeleteCharacterInAccount(accountname, charname)
  Var account:=FindAccount(accountname);
  If (account)
    Var gefunden:=0;

    For charnr:=1 To 5
      Var char:=account.getcharacter(charnr);
      If (char)
        If (char.name==charname)
          DeleteCharacterPergon(account, charnr);
          gefunden:=1;

          Sleep(2); // Damit das Logging in der accounts.txt auch funzt...
        EndIf
      EndIf
    EndFor

    If (!gefunden)
      SysLog("  [nicht gefunden] "+accountname+" - "+charname);
    EndIf
  Else
    SysLog("  [nicht gefunden] "+accountname);
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////
// FindLonelyCharacterNPCs - Sucht verlasse NPCs von Charactern
/////////////////////////////////////////////////////////////////

Function FindLonelyCharacterNPCs(kill:=0)
  Var anzahl:=0;

  ForEach mobile in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (mobile.isa(POLCLASS_NPC))
      Var masterserial:=GetObjProperty(mobile, "master");
      If (masterserial)
        If (!SystemFindObjectBySerial(masterserial, SYSFIND_SEARCH_OFFLINE_MOBILES))
          If (kill)
            SysLog("  Kill ["+masterserial+"] - NPC "+mobile.name+" ["+mobile.npctemplate+"] bei "+mobile.x+" "+mobile.y+" "+mobile.z);

            // klappt sonst nicht mit dem Kill
            RevokePrivilege(mob, "invul");
            IncRevision(mobile);

            KillMobile(mobile, "TextCMD Test-FindLonelyCharacterNPCs");
          EndIf

          anzahl:=anzahl+1;
        EndIf
      EndIf
    EndIf
  EndForEach

  If (kill)
    SysLog("Es wurden "+anzahl+" verlassene Tierchen entfernt.");
  Else
    SysLog("Es wurden "+anzahl+" verlassene Tierchen gezaehlt.");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////////
// FindTownMemberChip - Sucht den Player in einem Stadtstein und entfernt ihn dort
////////////////////////////////////////////////////////////////////////////////////

Function FindTownMemberChip(char)
  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_ITEM))
      If (item.objtype==0xa320)



      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////
// EmptyAllHouses - Alle Haueser komplett ausraeumen
//////////////////////////////////////////////////////

Function EmptyAllHouses(who)
  Var globalanzcontainer;
  Var wasgefunden;
  Var durchlauf:=0;

  Repeat
    globalanzcontainer:=0;wasgefunden:=0;

    ForEach houseserial in GetGlobalProperty("#houselist")
      Var house:=SystemFindObjectBySerial(houseserial);
      If (house)
        Var owner;
        Var ownerserial:=GetObjProperty(house, "ownerserial");
        If (ownerserial)
          owner:=SystemFindObjectBySerial(ownerserial, SYSFIND_SEARCH_OFFLINE_MOBILES);
        EndIf

        If (owner)
          SysLog("  ["+owner.acctname+"] "+owner.name+" ("+Lower(Hex(owner.serial))+") - "+
            house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
        Else
          If (ownerserial)
            SysLog("  geloeschter Besitzer - "+house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
          Else
            SysLog("  fehlender Besitzer - "+house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
          EndIf
        EndIf

        globalanzcontainer:=globalanzcontainer+1;

        If (house.items.size()) // Gibts was zum verpacken?
          Var itemlist:=house.items; // Die Liste kopieren... sicherheitshalber
          Var anzcontainer:=0;
          wasgefunden:=1;

          Var container:=CreateItemAtLocationPergon(5379+globalanzcontainer*2, 1184+anzcontainer, durchlauf*10, 0xe7c, 1);
          If (container)
            anzcontainer:=anzcontainer+1;
            SetName(container, "Haus "+house.x+" "+house.y+" "+house.z+" "+Lower(Hex(house.objtype))+" - "+owner.name+" - "+anzcontainer);
            container.movable:=0;container.color:=durchlauf*10;

            ForEach item in itemlist
              SetObjProperty(item, "HausAustausch", 1);
              item.movable:=1;

              Var verschoben:=0;
              Repeat
                If (!MoveItemToContainer(item, container)) // Konnte nicht verschoben werden...
                  If (!EnumerateItemsInContainer(container).size()) // weil, passt generell nich rein
                    DestroyItem(container);

                    MoveObjectToLocation(item, 5379+globalanzcontainer*2, 1184+(anzcontainer-1), durchlauf*10, REALM_BRITANNIA, MOVEOBJECT_FORCELOCATION);
                    item.movable:=0;
                    EraseObjProperty(item, "lockeddown");

                    SysLog("  WARNUNG: Irgendwie passt das Item "+Lower(Hex(item.serial))+" nicht in einen Container!");
                    verschoben:=1; // aber, es wurde verschoben
                  EndIf

                  ForEach item in EnumerateItemsInContainer(container)
                    EraseObjProperty(item, "lockeddown");
                  EndForEach

                  container:=CreateItemAtLocationPergon(5379+globalanzcontainer*2, 1184+anzcontainer, durchlauf*10, 0xe7c, 1);
                  If (container)
                    anzcontainer:=anzcontainer+1;
                    SetName(container, "Haus "+house.x+" "+house.y+" "+house.z+" "+Lower(Hex(house.objtype))+" - "+owner.name+" - "+anzcontainer);
                    container.movable:=0;container.color:=durchlauf*10;
                  Else
                    SysLog("  FEHLER: Es konnte kein Container bei "+house.x+" "+house.y+" "+(house.z+10+anzcontainer)+" erzeugt werden!");
                    Break;
                  EndIf
                Else
                  verschoben:=1;
                EndIf
              Until (verschoben);
            EndForEach

            If ((anzcontainer>1) And (!EnumerateItemsInContainer(container).size())) // Der letzte, aber nicht erste, Container ist leer
              DestroyItem(container);
            EndIf
          Else
            SysLog("  FEHLER: Es konnte kein Container bei "+house.x+" "+house.y+" "+(house.z+10+anzcontainer)+" erzeugt werden!");
            Break;
          EndIf

          If (house.items.size()<>anzcontainer)
            SysLog("  FEHLER: Es konnten nicht alle Gegenstaende verschoben werden!");
          EndIf
        EndIf
      EndIf
    EndForEach

    durchlauf:=durchlauf+1;
  Until (!wasgefunden);

  SendSysMessagePergon(who, "Anzahl Durchlaeufe = "+(durchlauf-1), "");
  SendSysMessagePergon(who, "Bei 5379 1184 0 werdet ihr die Gegenstaende finden.", "");

  // Nach weiteren, verankerten Items suchen
  Var lockeddown:=0;

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_ITEM) And IsLockedDown(item))
      SysLog("  LockedDown "+item.x+" "+item.y+" "+item.z+" "+Lower(Hex(item.objtype))+" '"+item.desc+"' "+item.amount);
      lockeddown:=lockeddown+1;
    EndIf
  EndForEach

  SendSysMessagePergon(who, "Es wurden "+lockeddown+" uebriggebliebene Items gefunden.", "");
EndFunction

////////////////////////////////////////////////////////////////////
// SearchForMissedItems - Nach bestimmten, vermissten Items suchen
////////////////////////////////////////////////////////////////////

Function SearchForMissedItems(who)
  Var vermisst:=0;

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_CONTAINER))
      ForEach subitem in EnumerateItemsInContainer(item)
        If (subitem.isa(POLCLASS_ITEM) And (subitem.objtype in {0x6317, 0x630c, 0x630e}))
          SysLog("  Vermisst (Cont) "+item.x+" "+item.y+" "+item.z+" "+Lower(Hex(subitem.objtype))+" '"+subitem.desc+"' "+subitem.amount);
          vermisst:=vermisst+1;
        EndIf
      EndForEach
    ElseIf (item.isa(POLCLASS_ITEM) And (item.objtype in {0x6317, 0x630c, 0x630e}))
      SysLog("  Vermisst "+item.x+" "+item.y+" "+item.z+" "+Lower(Hex(item.objtype))+" '"+item.desc+"' "+item.amount+" "+GetObjProperty(item, "HausAustausch"));
      vermisst:=vermisst+1;
    EndIf
  EndForEach

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_CONTAINER))
      ForEach subitem in EnumerateItemsInContainer(item)
        If (subitem.isa(POLCLASS_ITEM) And (subitem.objtype in {0x6317, 0x630c, 0x630e}))
          SysLog(Lower(Hex(subitem.serial))+";"+Lower(Hex(subitem.objtype))+";"+subitem.amount);
        EndIf
      EndForEach
    ElseIf (item.isa(POLCLASS_ITEM) And (item.objtype in {0x6317, 0x630c, 0x630e}))
      SysLog(Lower(Hex(item.serial))+";"+Lower(Hex(item.objtype))+";"+item.amount);
    EndIf
  EndForEach

  SendSysMessagePergon(who, "Es wurden "+vermisst+" vermisste Items gefunden.", "");
EndFunction

////////////////////////////////////////////////////////
// DestroyAllHouses - Alle Haueser komplett zerstoeren
////////////////////////////////////////////////////////

Function DestroyAllHouses(who)
  ForEach houseserial in GetGlobalProperty("#houselist")
    Var house:=SystemFindObjectBySerial(houseserial);
    If (house)
      Var owner;
      Var ownerserial:=GetObjProperty(house, "ownerserial");
      If (ownerserial)
        owner:=SystemFindObjectBySerial(ownerserial, SYSFIND_SEARCH_OFFLINE_MOBILES);
      EndIf

      If (owner)
        SysLog("  ["+owner.acctname+"] "+owner.name+" ("+Lower(Hex(owner.serial))+") - "+
          house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
      Else
        If (ownerserial)
          SysLog("  geloeschter Besitzer - "+house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
        Else
          SysLog("  fehlender Besitzer - "+house.x+" "+house.y+" "+house.z+" ["+Lower(Hex(house.objtype))+" - "+house.items.size()+" Items]");
        EndIf
      EndIf

      SysLog(Lower(Hex(house.serial))+" "+DestroyMulti(house));
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////////////
// DestroyEverythingButLeaveHousesXYZ - Zerstoere alles, bis auf das Haus XYZ
///////////////////////////////////////////////////////////////////////////////

Function DestroyEverythingButLeaveHousesXYZ(who)
  Var houseserial:=0x41c455e3; // 0x412ffbf1;
  Var count:=0;

  Var house:=SystemFindObjectBySerial(houseserial);
  If (house)
    ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (item.multi.serial<>houseserial)
        count:=count+1;
        DestroyItem(item);
      EndIf
    EndForEach

    SendSysMessagePergon(who, count+" Items zerstoert!");
  Else
    SendSysMessagePergon(who, "Haus "+Lower(Hex(houseserial))+" nicht gefunden!");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////////////////
// UnLockOldSecureContainer - Alte, nicht mehr verknuepfte, SecureContainer freischalten
//////////////////////////////////////////////////////////////////////////////////////////

Function UnLockOldSecureContainer(who)
  Var houses:=GetGlobalProperty("#houselist");
  Var oldcontainer:={};
  Var container:={};

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_ITEM))
      If (item.objtype in {0xe40, 0xe41})
        If (GetObjProperty(item, "houseserial"))
          If (!(GetObjProperty(item, "houseserial") in houses))
            EraseObjProperty(item, "boxserial");
            EraseObjProperty(item, "houseserial");
            item.usescript:="";

            oldcontainer.append({Lower(Hex(item.serial)), item.x, item.y, item.z});
          Else
            container.append({Lower(Hex(item.serial)), item.x, item.y, item.z});
          EndIf
        EndIf
      EndIf

      If (item.isa(POLCLASS_CONTAINER))
        ForEach subitem in EnumerateItemsInContainer(item)
          If (subitem.objtype in {0xe40, 0xe41})
            If (GetObjProperty(subitem, "houseserial"))
              If (!(GetObjProperty(subitem, "houseserial") in houses))
                EraseObjProperty(subitem, "boxserial");
                EraseObjProperty(subitem, "houseserial");
                subitem.usescript:="";

                oldcontainer.append({Lower(Hex(subitem.serial)), subitem.x, subitem.y, subitem.z});
              Else
                container.append({Lower(Hex(subitem.serial)), subitem.x, subitem.y, subitem.z});
              EndIf
            EndIf
          EndIf
        EndForEach
      EndIf
    EndIf
  EndForEach

  SysLog("oldcontainer = "+oldcontainer);
  SysLog("container = "+container);
EndFunction

////////////////////////////////////////////////////////
// FindPlayerHouses - Sucht die Haeuser eines Spielers
////////////////////////////////////////////////////////

Function FindPlayerHouses(owner) // Funtz nich   :o(
  ForEach house in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (house.isa(POLCLASS_HOUSE))
      If (GetObjProperty(house, "ownerserial")==owner.serial)
        SysLog("  ["+owner.acctname+"] "+owner.name+" ("+Lower(Hex(owner.serial))+") - "+house.x+" "+house.y+" "+house.z+" "+house.desc);
      EndIf
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////////////
// UnlockBlockedAccount - Hebt die DAU-Falle eines Accounts wieder auf
////////////////////////////////////////////////////////////////////////

Function UnlockBlockedAccount()
  ForEach accountname in {"lineover"}
    Var account:=FindAccount(accountname);
    If (account)
      account.eraseprop(ACCT_NEWCHAR_BLOCK);
    Else
      SysLog("  "+accountname+" ...nicht gefunden");
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////////////////////
// ResetOnlineCounter - Alle Onlinezaehler zuruecksetzen, neue Zaehlung
/////////////////////////////////////////////////////////////////////////

Function ResetOnlineCounter()
  Const datestamp:="old20030201";

  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
         // SetObjProperty(char, "lifetime"+datestamp, GetObjProperty(char, "lifetime"));
         // SetObjProperty(char, "lifetime", 0);
         // SetObjProperty(char, "onlinetimer"+datestamp, GetObjProperty(char, "onlinetimer"));
         // SetObjProperty(char, "onlinetimer", 0);
          EraseObjProperty(char, "livetime");
          EraseObjProperty(char, "livetime_counter");
        EndIf
      EndFor

     // account.setprop("lifetime"+datestamp, account.getprop("lifetime"));
     // account.setprop("lifetime", 0);
      account.eraseprop("livetime");
    Else
      SysLog("  "+accountname+" ...nicht gefunden");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////////////////
// EraseUnusedCharCProps - Entfernt mittlerweile ungenutze CProps in Chars
////////////////////////////////////////////////////////////////////////////

Function EraseUnusedCharCProps()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          EraseObjProperty(char, "TestLogGoldItems");
          EraseObjProperty(char, "TestLogGoldPrice");
        EndIf
      EndFor
    EndIf
  EndForEach
EndFunction

////////////////////////

Function ResetSpawnRunes(who)
  ForEach rune in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (rune.isa(POLCLASS_ITEM))
      If (rune.objtype==UOBJ_SPAWNRUNE)
        If (GetObjProperty(rune, "spawnnet"))
          If (GetObjProperty(rune, "mintime")==1000)
            SetObjProperty(rune, "mintime", 14);
          EndIf
          If (GetObjProperty(rune, "maxtime")==1000)
            SetObjProperty(rune, "maxtime", 24);
          EndIf

          AddRefresh(rune.serial);
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////////////////////
// GenerateActSkillConfigData - Erstellt die akt. Skillkonfiguration der Chars
////////////////////////////////////////////////////////////////////////////////

Function GenerateActSkillConfigData(who)
  CheckBerufeConfig();
EndFunction

///////////////////////////////////////////
// RenameWeapons - Benennt alte Waffen um
///////////////////////////////////////////

Function RenameWeapons()

  Return;
EndFunction

///////////////////////////////////////////////////
// RemoveCorpses - Entfernt herumliegende Leichen
///////////////////////////////////////////////////

Function RemoveCorpses(who)
  Var count:=0;

  ForEach corpse in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (corpse.isa(POLCLASS_CORPSE))
      DestroyItem(corpse);
      count:=count+1;
    EndIf
  EndForEach

  SendSysMessagePergon(who, count+" Corpses zerstoert.", "");
EndFunction

///////////////////////////////////////////////////////////////////////////////
// TestOnlineSearch - Tested verschiedene Funktionen der OnlineSearch-Include
///////////////////////////////////////////////////////////////////////////////

Function TestOnlineSearch(who)
  SysLog(EnumerateVisibleOnlineCharacters(developertemplate, LIST_ME));
  SysLog(EnumerateVisibleOnlineCharactersSorted(developertemplate, LIST_ME));
  SysLog(SearchForOnlineCharacter(developertemplate, "Jason"));
EndFunction

/////////////////////////////////////////////////////////////////////////////////////////////
// AddMailAddress - Ergaenzst die bisher nicht eingetragenen eMail-Adressen in den Accounts
/////////////////////////////////////////////////////////////////////////////////////////////

Function AddMailAddress(accountname, emailaddress)
  Var account:=FindAccount(accountname);
  If (account)
    account.setprop(PLAYEREMAIL, emailaddress);
    SysLog("  Im Account '"+accountname+"' wurde '"+emailaddress+"' als eMail-Adresse gesetzt.");
  Else
    SysLog("  FEHLER: '"+accountname+"' gibt es nicht !");
  EndIf
EndFunction

///////////////////////////////////////////
// CheckStackability - Einfach mal testen
///////////////////////////////////////////

Function CheckStackability(who, params)
  params:=SplitWords(params);

 // Case (CInt(params[1]))
 //   1: CreateItemInBackpackPergon(who, CInt(params[2]));
 //   2: CreateItemInContainerPergon(who.backpack, CInt(params[2]));
 //   3: CreateItemInInventoryPergon(who.backpack, CInt(params[2]));
 // EndCase

 // Var itemdesc:=GetItemDescriptor(CInt(params[1]));
 // If (itemdesc)
 //   itemdesc.cprops.insert("#forcesingleitem", 1);
 //   Var item:=CreateItemInBackpackPergon(who, itemdesc);
 //   EraseObjProperty(item, "#forcesingleitem");
 // EndIf

  CreateSingleItemInBackpackPergon(who, CInt(params[2]));
EndFunction

/////////////////////////////////////////////////////////////////////////////
// TransformStaticHouses - Wandelt diverse Sachen in Statischen Haeusern um
/////////////////////////////////////////////////////////////////////////////

Function TransformStaticHouses(who)
  ForEach houseserial in GetGlobalProperty("#houselist")
    Var house:=SystemFindObjectBySerial(houseserial);
    If (house)
      If (!house.isa(POLCLASS_HOUSE)) // Gildenhaus
        Var houseinfo:=GetObjProperty(house, "houseinfo");
        If (houseinfo)
          Var anzahl1:=0;
          Var anzahl2:=0;

          ForEach item in ListObjectsInBox(houseinfo[1], houseinfo[2], houseinfo[3], houseinfo[4], houseinfo[5], houseinfo[6])
            If (item.isa(POLCLASS_ITEM))                      // Jedes Item,
              If (!item.movable)                              // das bereits fest ist,
                If (!item.multi)                              // sich nicht in einem Multi befindet,
                  If (!IsLockedDown(item))                    // noch nicht festgemacht wurde (Hausfunktion)
                    If (!GetObjProperty(item, "houseserial")) // und auch kein Hauscontainer ist...
                     // SetObjProperty(house, "numlockdowns", GetObjProperty(house, "numlockdowns")-1);
                     // SetObjProperty(item, "lockeddown", 1);
                      anzahl2:=anzahl2+1;
                    EndIf

                    anzahl1:=anzahl1+1;
                  EndIf
                EndIf
              EndIf
            EndIf
          EndForEach

          SysLog("  "+house.desc+" - "+anzahl1+" - "+anzahl2);
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////
// ManuallyAddHouseFriend - Einen Hausfreund manuell hinzufuegen
//////////////////////////////////////////////////////////////////

Function ManuallyAddHouseFriend(who)
  SendSysMessagePergon(who, "Waehlt das Spielerhaus, bzw. das Hausschild!", "");

  Var sign:=Target(who);
  If (sign.isa(POLCLASS_ITEM))
    Var houseserial:=GetObjProperty(sign, "house_serial");
    If (houseserial)
      Var house:=SystemFindObjectBySerial(houseserial); // Das Haus suchen...
      If (house.isa(POLCLASS_HOUSE))
        SendSysMessagePergon(who, "Waehlt den neuen Freund fuer das Haus!", "");

        Var friend:=Target(who);
        If ((friend.isa(POLCLASS_MOBILE)) And (!friend.isa(POLCLASS_NPC)))
          If (friend.serial<>who.serial)
            HausFreundAufnehmen(who, house, friend);
          Else
            SendSysMessagePergon(who, "Seid ihr schizophren?", "");
          EndIf
        Else
          SendSysMessagePergon(who, "Abbruch", "Abort");
        EndIf
      Else
        SysLog("WARNUNG: Das Haus "+Lower(Hex(houseserial))+" zum Schild "+Lower(Hex(sign.serial))+" existiert nicht mehr!");
        SendSysMessagePergon(who, "Das Haus zum Schild existiert nicht mehr!", "");
      EndIf
    Else
      SendSysMessagePergon(who, "Dies ist kein Hausschild!", "");
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////////////////
// ManuallyAddGuildHouseFriend - Einen Gildenhausfreund manuell hinzufuegen
/////////////////////////////////////////////////////////////////////////////

Function ManuallyAddGuildHouseFriend(who)
  SendSysMessagePergon(who, "Waehlt das Spielerhaus, bzw. das Hausschild!", "");

  Var sign:=Target(who);
  If (sign.isa(POLCLASS_ITEM))
    SendSysMessagePergon(who, "Waehlt den neuen Freund fuer das Haus!", "");

    Var friend:=Target(who);
    If ((friend.isa(POLCLASS_MOBILE)) And (!friend.isa(POLCLASS_NPC)))
      If (friend.serial<>who.serial)
        HausFreundAufnehmen(who, sign, friend);
      Else
        SendSysMessagePergon(who, "Seid ihr schizophren?", "");
      EndIf
    Else
      SendSysMessagePergon(who, "Abbruch", "Abort");
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////
// DestroySpecialItemsFromWorld - Zerstoert bestimmte Gegenstaende in der Welt
////////////////////////////////////////////////////////////////////////////////

Var datafile;
Var datacounter;

Function DestroySpecialItemsFromWorld(who)
  Var delete:=0; // Sollen die Items wirklich geloescht werden, oder doch nur ein Testlauf?

  Var storagearea:=FindStorageArea(STORAGE_MERCHANT);
  Var keyarea:=FindStorageArea(STORAGE_KEYRINGS);
  Var bankarea:=FindStorageArea(STORAGE_BANK);
  datafile:=ReadConfigFile("statics/destroyed");
  If (storagearea And keyarea And bankarea And datafile)
    // Naechsten moeglichen Eintrag bestimmen
    Var counter:=GetConfigStringKeys(datafile);
    If (Len(counter))
      datacounter:=Len(counter);
    Else
      datacounter:=0;
    EndIf

    // Erstmal die Welt selber abgrasen... nach Containern, Items und NPCs
    Var realmsvar:=Realms();
    ForEach realm in (realmsvar.keys())
      Var realmname:=realm;
      realmname[1]:=Upper(realmname[1]);
      LogToFile("log/destroy.log", "Realm "+realmname+": 0 0 -128 "+(realmsvar[realm].width-1)+" "+(realmsvar[realm].height-1)+" 127");

      ForEach object in ListObjectsInBox(0, 0, -128, realmsvar[realm].width-1, realmsvar[realm].height-1, 127, realm)
        If (object.isa(POLCLASS_CONTAINER)) // Container
          DestroySpecialItemsInContainer(object, delete);
        ElseIf (object.isa(POLCLASS_ITEM)) // Item
          DestroySpecialItem(object, delete, 1); // Von GMs, ausserhalb von Multis festgetackerte Gegenstaende ignorieren
        ElseIf (object.isa(POLCLASS_NPC)) // NPC
          DestroySpecialItemsInContainer(object, delete);
          DestroySpecialItemsInContainer(object.backpack, delete);
          DestroySpecialItemsInContainer(FindRootItemInStorageArea(storagearea, object.serial+" FS"), delete);
          DestroySpecialItemsInContainer(FindRootItemInStorageArea(storagearea, object.serial+" PB"), delete);
          DestroySpecialItemsInContainer(FindRootItemInStorageArea(storagearea, object.serial+" 1C"), delete);
          DestroySpecialItemsInContainer(FindRootItemInStorageArea(keyarea, ST_PREF_KEYRINGS+Hex(object.serial)), delete);
        EndIf
      EndForEach
    EndForEach

    ForEach houseinfo in GetStaticHouses()
      LogToFile("log/destroy.log", "Gildenhaus "+houseinfo[1][1]+" "+houseinfo[1][2]+" "+
        houseinfo[1][3]+" "+houseinfo[1][4]+" "+houseinfo[1][5]+" "+houseinfo[1][6]+" "+houseinfo[2]);

      ForEach object in ListObjectsInBox(houseinfo[1][1], houseinfo[1][2], houseinfo[1][3], houseinfo[1][4], houseinfo[1][5], houseinfo[1][6], houseinfo[2])
        If (object.isa(POLCLASS_ITEM)) // Item
          DestroySpecialItem(object, delete, 0); // Gegenstaende in Gildenhaeusern pruefen
        EndIf
      EndForEach
    EndForEach

    // ...und dann noch die Spieler, was sie anhaben, ihre Backpacks und Bankfaecher
    ForEach accountname in ListAccounts()
      Var account:=FindAccount(accountname);
      If (account)
        For charnr:=1 To 5
          Var char:=account.getcharacter(charnr);
          If (char)
            ForEach item in ListEquippedItems(char)
              DestroySpecialItem(item, delete);
            EndForEach
            DestroySpecialItemsInContainer(char.backpack, delete);
            DestroySpecialItemsInContainer(FindRootItemInStorageArea(bankarea, ST_PREF_BANK+char.serial), delete);
          EndIf
        EndFor
      Else
        SysLog("  Account '"+accountname+"' gibt es nicht!");
      EndIf
    EndForEach

    LogToFile("log/destroy.log", "Geloescht = "+geloescht+" von "+summe+" von insgesamt "+gesamtsumme);
    LogToFile("log/destroy.log", "Bargeld = "+bargeld+" + "+bargeldmrd+" Mrd. in "+geldhaufen+" Geldhaufen");
    LogToFile("log/destroy.log", "Warenwert = "+warenwertkauf+" + "+warenwertkaufmrd+" Mrd. [Kauf] / "+warenwertverkauf+" + "+warenwertverkaufmrd+" Mrd. [Verkauf]");
    LogToFile("log/destroy.log", "RestItems = "+restitemsamount+" in "+restitems+" Haufen");

    UnloadConfigFile("statics/destroyed");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////////////////////////
// DestroySpecialItemsInContainer - Behandelt alle Items im Container, selbst wenn abgeschlossen
//////////////////////////////////////////////////////////////////////////////////////////////////

Function DestroySpecialItemsInContainer(container, delete)
  Var unlocked:={}; // Welche SubContainer wurden aufgeschlossen?
  Var locked;       // Gabs noch was zum Aufschliessen?

  // Erstmal alles aufschliessen
  If (container.locked)
    container.locked:=0;
    unlocked.append(container);
  EndIf

  Repeat
    locked:=0;

    ForEach item in EnumerateItemsInContainer(container)
      If (item.isa(POLCLASS_CONTAINER))
        If (item.locked)
          item.locked:=0;
          locked:=1;
          unlocked.append(item);
          LogToFile("log/destroylocked.log", Lower(Hex(item.serial))+";"+item.desc+";Cont_"+Lower(Hex(container.serial)));
        EndIf
      EndIf
    EndForEach
  Until (!locked);

  // Jetzt alles abarbeiten
  ForEach item in EnumerateItemsInContainer(container)
    DestroySpecialItem(item, delete);
  EndForEach

  // Und wieder alles abschliessen, was aufgeschlossen wurde
  ForEach item in unlocked
    item.locked:=1;
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////////
// DestroySpecialItem - Zerstoert Gegenstand nach diversen Kriterien
//////////////////////////////////////////////////////////////////////

Var weapon_dont_delete:={0xff94, 0xff9a, 0xff9b, 0xff9c};
Var armor_do_delete:={0x1410, 0x1411, 0x1413, 0x1414, 0x1415, 0x1416, 0x1417, 0x1418, 0x141a, 0x1c04, // Platte
  0x1408, 0x1409, 0x140a, 0x140b, 0x140c, 0x140d, 0x140e, 0x140f, 0x1412, 0x1419,                     // Helme
  0x1b72, 0x1b73, 0x1b74, 0x1b75, 0x1b76, 0x1b77, 0x1b78, 0x1b79, 0x1b7a, 0x1b7b, 0x1bc3, 0x1bc4,     // Schilde
  0x13ec, 0x13ed, 0x13ee, 0x13ef, 0x13f0, 0x13f1, 0x13f2,                                             // Ringmail
  0x13bb, 0x13be, 0x13bf, 0x13c0, 0x13c3, 0x13c4,                                                     // Chainmail
  0x13d4, 0x13d5, 0x13d6, 0x13da, 0x13db, 0x1c00, 0x1c02, 0x1c06, 0x1c0c, 0x8060,                     // beschlagenes Leder
  0xbfbb, 0xbfbe, 0xbfbf, 0xcdab};                                                                    // Sonstiges
Var werkzeug_do_delete:={0x1028, 0x102a, 0x102c, 0x1030, 0x1031, 0x1032, 0x1035, 0x1055, 0x10e4, 0x10e5, 0x10e6, 0x10e7,
  0x12b3, 0x1421, 0x14fb, 0x1876, 0x1eba, 0x1ebc, 0x6697, 0x7050, 0x7051, 0x7701, 0x8004, 0x9e2, 0xb01e, 0xdbf, 0xdc0,
  0xe9b, 0xf39, 0x70e1, 0xf9d, 0xf9e, 0xfbb, 0xf124, 0x6111, 0xeb2, 0xeb3, 0xe9c, 0xe9d, 0xe9e, 0xEB1, 0x6600, 0x102e};
Var objtypelist:={};
Var gesamtsumme:=0;
Var geldhaufen:=0;
Var bargeld:=0;
Var bargeldmrd:=0;
Var warenwertkauf:=0;
Var warenwertkaufmrd:=0;
Var warenwertverkauf:=0;
Var warenwertverkaufmrd:=0;
Var restitems:=0;
Var restitemsamount:=0;
Var geloescht:=0;
Var summe:=0;
Var fehler:=0;

Function DestroySpecialItem(item, delete, outsidecont:=0)
  If ((item.buyprice>0) And (item.buyprice<>2147483647))
    warenwertkauf:=warenwertkauf+(item.buyprice*item.amount);
    While (warenwertkauf>1000000000)
      warenwertkauf:=warenwertkauf-1000000000;
      warenwertkaufmrd:=warenwertkaufmrd+1;
    EndWhile
  EndIf
  If ((item.sellprice>0) And (item.sellprice<>2147483647))
    warenwertverkauf:=warenwertverkauf+(item.sellprice*item.amount);
    While (warenwertverkauf>1000000000)
      warenwertverkauf:=warenwertverkauf-1000000000;
      warenwertverkaufmrd:=warenwertverkaufmrd+1;
    EndWhile
  EndIf

  Var exportedserial:=GetObjProperty(item, "ExportedSerial"); // Container-/Equipmentexport
  If (!exportedserial)
    exportedserial:=item.serial;
    If (delete)
      EraseObjProperty(item, "ExportedSerial");
    EndIf
  EndIf

  If ((item.serial<=0x472bcb33) Or (exportedserial<=0x472bcb33)) // Commander: neue props, qualis usw. (ct-vergleich is doof) (28.01.2005)
    If ((!outsidecont) Or (item.multi) Or (item.movable)) // Items, ausserhalb eines Containers, nur, wenn beweglich oder in einem Spielerhaus
//      If (item.isa(POLCLASS_WEAPON) Or item.isa(POLCLASS_ARMOR) Or GetObjProperty(item, "Werkzeug"))
      If ((item.isa(POLCLASS_WEAPON) Or item.isa(POLCLASS_ARMOR)) And (!GetObjProperty(item, "Werkzeug"))) // Nur die NPC-Teile extrahieren
        // ObjType-Liste aller potentiell betroffenen Items aufbauen
        If (!(item.objtype in objtypelist))
          objtypelist.append(item.objtype);

          If (item.isa(POLCLASS_WEAPON))
            If (item.objtype in weapon_dont_delete)
              LogToFile("log/destroyweapon.log", "weapon;"+Lower(Hex(item.objtype))+";"+item.desc);
            Else
              LogToFile("log/destroyweapon_del.log", "weapon;"+Lower(Hex(item.objtype))+";"+item.desc);
            EndIf
          ElseIf (item.isa(POLCLASS_ARMOR))
            If (item.objtype in armor_do_delete)
              LogToFile("log/destroyarmor_del.log", "armor;"+Lower(Hex(item.objtype))+";"+item.desc);
            Else
              LogToFile("log/destroyarmor.log", "armor;"+Lower(Hex(item.objtype))+";"+item.desc);
            EndIf
          Else
            If (item.objtype in werkzeug_do_delete)
              LogToFile("log/destroywerkzeug_del.log", "werkzeug;"+Lower(Hex(item.objtype))+";"+item.desc);
            Else
              LogToFile("log/destroywerkzeug.log", "werkzeug;"+Lower(Hex(item.objtype))+";"+item.desc);
            EndIf
          EndIf
        EndIf

        Var npc_item:=0;
        Var npc_text:="";
        If (!GetObjProperty(item, "Werkzeug"))
          npc_item:=1;npc_text:="[NPC] ";
        EndIf

        If (item.isa(POLCLASS_WEAPON))
          If (!(item.objtype in weapon_dont_delete))
            LogToFile("log/destroyed.log", GetUnmovableText(item)+npc_text+"weapon;"+Lower(Hex(item.objtype))+";"+
              item.desc+";"+item.x+" "+item.y+" "+item.z+";"+Lower(Hex(item.serial))+GetContainerSerial(item));

            If (delete)
              FinallyDestroySpecialItem(item);
            EndIf
            geloescht:=geloescht+1;
          EndIf
        ElseIf (item.isa(POLCLASS_ARMOR))
          If (item.objtype in armor_do_delete)
            LogToFile("log/destroyed.log", GetUnmovableText(item)+npc_text+"armor;"+Lower(Hex(item.objtype))+";"+
              item.desc+";"+item.x+" "+item.y+" "+item.z+";"+Lower(Hex(item.serial))+GetContainerSerial(item));

            If (delete)
              FinallyDestroySpecialItem(item);
            EndIf
            geloescht:=geloescht+1;
          EndIf
        Else
          If (item.objtype in werkzeug_do_delete)
            LogToFile("log/destroyed.log", GetUnmovableText(item)+npc_text+"werkzeug;"+Lower(Hex(item.objtype))+";"+
              item.desc+";"+item.x+" "+item.y+" "+item.z+";"+Lower(Hex(item.serial))+GetContainerSerial(item));

            If (delete)
              If (item.isa(POLCLASS_CONTAINER)) // Mist... d.h. Umschichten... *grummel*
                Var newcontainer;

                If (item.container) // Is irgendwo Bestandteil
                  newcontainer:=CreateItemInContainerPergon(item.container, item.objtype);
                Else
                  newcontainer:=CreateItemAtLocationPergon(item.x, item.y, item.z, item.objtype, 1);
                EndIf

                If (newcontainer) // Umschichten
                  ForEach subitem in EnumerateItemsInContainer(item)
                    If (subitem.container.serial==item.serial) // Nur Top-Layer-Items...
                      MoveItemToContainer(subitem, newcontainer);
                    EndIf
                  EndForEach
                EndIf
              EndIf

              FinallyDestroySpecialItem(item);
            EndIf
            geloescht:=geloescht+1;
          EndIf
        EndIf

        summe:=summe+1;
      EndIf
    EndIf
  EndIf

  gesamtsumme:=gesamtsumme+1;
  If (item.objtype==0xeed)
    geldhaufen:=geldhaufen+1;
    bargeld:=bargeld+item.amount;
    While (bargeld>1000000000)
      bargeld:=bargeld-1000000000;
      bargeldmrd:=bargeldmrd+1;
    EndWhile
  Else
    restitems:=restitems+1;
    restitemsamount:=restitemsamount+item.amount;
  EndIf
EndFunction

Function FinallyDestroySpecialItem(item)
  Var destroy:=0;
  If (destroy) // 1 -> Zerstoeren / 0 -> Exportieren
    DestroyItem(item);
  Else
    Var elem:={};
    If (item.isa(POLCLASS_WEAPON))
      elem.append({"TYPE", "Weapon"});
    ElseIf (item.isa(POLCLASS_ARMOR))
      elem.append({"TYPE", "Armor"});
    Else
      elem.append({"TYPE", "Undefiniert"});
    EndIf

    elem.append({"NAME",          EntferneA(item.desc)});              // UObject
    elem.append({"SERIAL",        Lower(Hex(item.serial))});
    elem.append({"OBJTYPE",       Lower(Hex(item.objtype))});
    elem.append({"GRAPHIC",       Lower(Hex(item.graphic))});
    elem.append({"COLOR",         item.color});
    elem.append({"X",             item.x});
    elem.append({"Y",             item.y});
    elem.append({"Z",             item.z});
    elem.append({"FACING",        item.facing});

    elem.append({"AMOUNT",        item.amount});                       // Item
    elem.append({"LAYER",         item.layer});
    elem.append({"MOVABLE",       item.movable});
    elem.append({"INVISIBLE",     item.invisible});

    Var owner:=item;
    If (owner.container.isa(POLCLASS_MOBILE))
      elem.append({"EQUIPPED",    Lower(Hex(owner.container.serial))});
    EndIf
    While (owner.container)
      elem.append({"CONTAINER",   Lower(Hex(owner.container.serial))});
      owner:=owner.container;
    EndWhile
    If (owner.multi)
      elem.append({"MULTI",       {GetObjProperty(owner.multi, "ownerserial"), GetObjProperty(owner.multi, "owneracct")}});
    EndIf

    elem.append({"ONUSESCRIPT",   item.onusescript});
    elem.append({"EQUIPSCRIPT",   item.equipscript});
    elem.append({"UNEQUIPSCRIPT", item.unequipscript});
    elem.append({"DECAYAT",       item.decayat});
    elem.append({"SELLPRICE",     item.sellprice});
    elem.append({"BUYPRICE",      item.buyprice});
    elem.append({"NEWBIE",        item.newbie});

    elem.append({"QUALITY",       item.quality});                      // Equipment
    elem.append({"HP",            item.hp});
    elem.append({"MAXHP_MOD",     item.maxhp_mod});

    If (item.isa(POLCLASS_WEAPON))
      elem.append({"DMG_MOD",     item.dmg_mod});                      // Weapon
      elem.append({"HITSCRIPT",   item.hitscript});
    ElseIf (item.isa(POLCLASS_ARMOR))
      elem.append({"AR_MOD",      item.ar_mod});                       // Armor
      elem.append({"ONHITSCRIPT", item.onhitscript});
    EndIf

    ForEach propname in GetObjPropertyNames(item)
      elem.append({"CPROP", propname+" "+Pack(GetObjProperty(item, propname))});
    EndForEach
    elem.append({"CPROP", "RestoreSerial "+Pack(item.serial)});

    AppendConfigFileElem("statics/destroyed", "SECTION", "WORLDITEM "+datacounter, elem);

    datacounter:=datacounter+1;
  EndIf
EndFunction

Function GetContainerSerial(item)
  Var container:=item.container;
  While (container.container)
    container:=container.container;
  EndWhile

  If (container)
    Return (";Cont_"+Lower(Hex(container.serial)));
  Else
    Return ("");
  EndIf
EndFunction

Function GetUnmovableText(item)
  If (item.movable)
    Return ("");
  Else
    Return ("[Fest] ");
  EndIf
EndFunction

Function DestroySpecialItem_Test(item, outsidecont:=0)
  If ((0x413dba34<=item.serial) And (item.serial<=0x413ddb6a))
    If (item.amount>10)
   // If (item.amount<=10)
      SysLog("  VIEL "+Lower(Hex(item.objtype))+" "+Lower(Hex(item.serial))+" "+item.amount+" "+item.desc);
   // Else
   //   SysLog("  "+Lower(Hex(item.objtype))+" "+Lower(Hex(item.serial))+" "+item.amount+" "+item.desc);
    EndIf
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////
// RestoreSpecialItemsIntoWorld - Stellt bestimmte Gegenstaende wieder her
////////////////////////////////////////////////////////////////////////////

Function RestoreSpecialItemsIntoWorld(who)
  Var datafile:=ReadConfigFile("statics/destroyed");
  If (datafile)
    ForEach name in GetConfigStringKeys(datafile)
      Var itemdesc:=datafile[name];
      If (itemdesc)
        Var mobile:=0;
        Var container:=0;
        Var item:=0;

        If (itemdesc.equipped)
          mobile:=SystemFindObjectBySerial(CInt(itemdesc.equipped), SYSFIND_SEARCH_OFFLINE_MOBILES);
          If (mobile)
            If (mobile.isa(POLCLASS_NPC) And GetObjProperty(mobile, "master"))
              Var master:=SystemFindObjectBySerial(CInt(GetObjProperty(mobile, "master")), SYSFIND_SEARCH_OFFLINE_MOBILES);
              If (master)
                item:=CreateItemAtLocationPergon(mobile.x, mobile.y, mobile.z, CInt(itemdesc.objtype), 1);
                SetObjProperty(item, "abcdefg", RandomInt(123456)); // Nur, damit der den Kram nich stacked
                If (!EquipItem(mobile, item))
                  If (!MoveItemToContainer(item, master.backpack))
                    LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] konnte weder equipped, noch dem Master gegeben werden!");
                    DestroyItem(item);
                    item:=0;
                  EndIf
                EndIf
              Else
                LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] Finde den Master "+Lower(Hex(GetObjProperty(mobile, "master")))+" nimmer!");
              EndIf
            ElseIf (!mobile.isa(POLCLASS_NPC)) // Spieler
              item:=CreateItemAtLocationPergon(mobile.x, mobile.y, mobile.z, CInt(itemdesc.objtype), 1);
              SetObjProperty(item, "abcdefg", RandomInt(123456)); // Nur, damit der den Kram nich stacked
              If (!EquipItem(mobile, item))
                If (!MoveItemToContainer(item, mobile.backpack))
                  LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] konnte weder equipped, noch ins Backpack gepackt werden!");
                  DestroyItem(item);
                  item:=0;
                EndIf
              EndIf
            Else
              LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] ist zu unwichtig!");
            EndIf
          Else
            LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] Finde das Mobile "+Lower(Hex(itemdesc.equipped))+" nimmer!");
          EndIf
        Else
          Var containers:=GetConfigStringArray(itemdesc, "CONTAINER");
          If (containers.size())
            Var index:=1;

            Repeat
              container:=SystemFindObjectBySerial(CInt(containers[index]), SYSFIND_SEARCH_OFFLINE_MOBILES);
              index:=index+1;
            Until (container Or (index>containers.size()));

            If (container)
              item:=CreateItemAtLocationPergon(0, 0, 0, CInt(itemdesc.objtype), 1);
              SetObjProperty(item, "abcdefg", RandomInt(123456)); // Nur, damit der den Kram nich stacked

              While (container.isa(POLCLASS_CONTAINER) And (!MoveItemToContainer(item, container)))
                container:=container.container;
              EndWhile

              If (!item.container)
                LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] konnte nicht in einen Container gepackt werden!");
                DestroyItem(item);
                item:=0;
              EndIf
            Else
              LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] Finde keinen Container ("+itemdesc.name+")!");
            EndIf
          Else
            item:=CreateItemAtLocationPergon(itemdesc.x, itemdesc.y, itemdesc.z, CInt(itemdesc.objtype), 1);
            SetObjProperty(item, "abcdefg", RandomInt(123456)); // Nur, damit der den Kram nich stacked
          EndIf
        EndIf

        If (item)
          SetName(item, itemdesc.name);
          item.graphic:=CInt(itemdesc.graphic);
          item.color:=itemdesc.color;
          item.facing:=itemdesc.facing;

          If (itemdesc.amount>1)
            AddAmount(item, itemdesc.amount-1);
          EndIf
          item.movable:=itemdesc.movable;
          item.invisible:=itemdesc.invisible;

          item.decayat:=itemdesc.decayat;
          item.newbie:=itemdesc.newbie;
          item.quality:=itemdesc.quality;
          item.hp:=itemdesc.hp;
          item.maxhp_mod:=itemdesc.maxhp_mod;

          If (itemdesc.type=="Weapon")
            item.dmg_mod:=itemdesc.dmg_mod;
          ElseIf (itemdesc.type=="Armor")
            item.ar_mod:=itemdesc.ar_mod;
          EndIf

          ForEach cprop in GetConfigStringArray(itemdesc, "CPROP")
            cprop:=SplitWords(cprop);
            SetObjProperty(item, cprop[1], UnPack(cprop[2]));
          EndForEach
          EraseObjProperty(item, "abcdefg"); // Nur, damit der den Kram nich stacked
        Else
          LogToFile("log/restored.log", "[Item "+Lower(Hex(itemdesc.serial))+"] Wurde nicht wiederhergestellt ("+itemdesc.name+")!");
        EndIf
      EndIf
    EndForEach

    UnloadConfigFile("statics/destroyed");
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////
// GetStaticHouses - Liefert die Koordinaten aller statischen Haeuser
///////////////////////////////////////////////////////////////////////

Function GetStaticHouses()
  Var houseinfos:={};

  Var realmsvar:=Realms();
  ForEach realm in (realmsvar.keys())
    Var realmname:=realm;
    realmname[1]:=Upper(realmname[1]);
    LogToFile("log/destroystatic.log", "Realm "+realmname+": 0 0 -128 "+(realmsvar[realm].width-1)+" "+(realmsvar[realm].height-1)+" 127");

    ForEach object in ListObjectsInBox(0, 0, -128, realmsvar[realm].width-1, realmsvar[realm].height-1, 127, realm)
      If (object.isa(POLCLASS_ITEM))
        If ((0x7060<=object.objtype) And (object.objtype<=0x7063))
          Var houseinfo:=GetObjProperty(object, "houseinfo");
          If (houseinfo)
            If (houseinfo.size()==6)
              houseinfos.append({houseinfo, realm});
            Else
              LogToFile("log/destroystatic.log", "WARNUNG: Die Verknuepfung "+Lower(Hex(object.serial))+" zum Haus scheint fehlerhaft zu sein!");
            EndIf
          Else
            LogToFile("log/destroystatic.log", "WARNUNG: Das Schild "+Lower(Hex(object.serial))+" scheint keinem Haus zugeordnet zu sein!");
          EndIf
        EndIf
      EndIf
    EndForEach
  EndForEach

  Return (houseinfos);
EndFunction

//////////////////////////////////////////////////////////////////////////
// ListBankboxContent - Listet das auf, was sich in der Bankbox befindet
//////////////////////////////////////////////////////////////////////////

Function ListBankboxContent(who)
  Var bankarea:=FindStorageArea(STORAGE_BANK);
  If (bankarea)
    ForEach item in EnumerateItemsInContainer(FindRootItemInStorageArea(bankarea, ST_PREF_BANK+who.serial))
      SysLog("  "+Lower(Hex(item.serial))+" "+Lower(Hex(item.objtype))+" "+item.desc);
    EndForEach
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////
// CheckDateOutput - Prueft verschiedene Funktionen zu Datumsanzeige
//////////////////////////////////////////////////////////////////////

Function CheckDateOutput()
  SysLog(GetDateTimeStr());
EndFunction

////////////////////////////////////////////////////////
// Pol095BugText - Testet einen angeblichen Pol095 Bug
////////////////////////////////////////////////////////

Function Pol095BugText(who)
  SysLog("ClientVersion = "+who.clientversion);

  Var echte_umlaute:={{"&auml;", CChr(0xc3)+CChr(0xa4)}, {"&ouml;", CChr(0xc3)+CChr(0xb6)}, {"&uuml;", CChr(0xc3)+CChr(0xbc)},
                    {"&Auml;", CChr(0xc3)+CChr(0x84)}, {"&Ouml;", CChr(0xc3)+CChr(0x96)}, {"&Uuml;", CChr(0xc3)+CChr(0x9c)},
                    {"&szlig;", CChr(0xc3)+CChr(0x9f)}, {"\\\'", "'"}, {"\\\"", CChr(0x22)}};

  Var unechte_umlaute:={{"&auml;", "ae"}, {"&ouml;", "oe"}, {"&uuml;", "ue"},
                        {"&Auml;", "Ae"}, {"&Ouml;", "Oe"}, {"&Uuml;", "Ue"},
                        {"&szlig;", "ss"}, {"\\\'", "'"}};

  SysLog(echte_umlaute);
  SysLog(unechte_umlaute);
EndFunction

////////////////////////////////////////////////////////////
// DestroyMountItems - Zerstoert herumliegende Mount-Items
////////////////////////////////////////////////////////////

Function DestroyMountItems()
  Var count:=0;

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_ITEM))
      If (item.objtype==0xf021)
        SysLog("  "+GetObjProperty(item, "petname"));
        DestroyItem(item);
        count:=count+1;
      EndIf
    EndIf
  EndForEach

  SysLog("  "+count+" Mount-Items zerstoert");
EndFunction

//////////////////////////////////////////////////////
// TestBookStuff - Testet ein bissl mit Buechern rum
//////////////////////////////////////////////////////

Function TestBookStuff(who)
  Var spellbook:=Target(who);
 // SysLog(GetObjProperty(book, "contents"));

  ForEach spellpanel in EnumerateItemsInContainer(spellbook)
    If (spellpanel.objtype==UOBJ_SPELLPANEL) // Ist es ein SpellPanel?
      Var data:=GetObjProperty(spellpanel, "Data");
      If (data) // Sind die Einstellungen vorhanden?
        data[1]:=30;data[2]:=30;
        SetObjProperty(spellpanel, "Data", data);
      Else
        SysLog("FEHLER: SpellPanel "+Lower(Hex(spellpanel.serial))+" wurde nicht richtig konfiguriert!");
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////
// ResetSpellPanel - Resettet ein bestimmtest SpellPanel
//////////////////////////////////////////////////////////

Function ResetSpellPanel()
 // Var spellpanel:=SystemFindObjectBySerial(0x4250d9af);
 // If (spellpanel)
   // Var data:=GetObjProperty(spellpanel, "Data");
   // If (data) // Sind die Einstellungen vorhanden?
   //   data[1]:=30;data[2]:=30;
   //   SetObjProperty(spellpanel, "Data", data);
   // Else
   //   SysLog("FEHLER: SpellPanel "+Lower(Hex(spellpanel.serial))+" wurde nicht richtig konfiguriert!");
   // EndIf
   // SetObjProperty(spellpanel, "ownerserial", 441632);
 // EndIf

 // Var multi:=SystemFindObjectBySerial(0x41bc44ef);
 // If (multi)
 //   SetObjProperty(multi, "ownerserial", 441632);
 // EndIf

  Var mobile:=SystemFindObjectBySerial(0x1d098e, SYSFIND_SEARCH_OFFLINE_MOBILES);
  If (mobile)
    SetMobileNamePergon(mobile, "Logan San aus Cove", 0, "");
  EndIf
 // Var mobile:=SystemFindObjectBySerial(0xa6125, SYSFIND_SEARCH_OFFLINE_MOBILES);
 // If (mobile)
 //   SetMobileNamePergon(mobile, "Shee", 0, "");
 // EndIf
EndFunction

////////////////////////////////////////////////////////////////
// ListSpawnRunes - Listet alle SpawnRunen fuer den Export auf
////////////////////////////////////////////////////////////////

Const TYPE_RUNE_NPC:=1;
Const TYPE_RUNE_ITEM:=2;
Const TYPE_RUNE_CONTAINER:=3;

Function ListSpawnRunes(who)
  SysLog("Type;X;Y;Z;ID;Template;MinTime;MaxTime;Range;MaxAmount;Aux;Flags1;Flags2;Flags3;Flags4;Amount;Hinweis");

  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_ITEM))
      If (CInt(GetObjProperty(item, "spawnnet")) And (item.objtype==UOBJ_SPAWNRUNE))
        Var runeflags:=CStr(Hex(CInt(GetObjProperty(item, "flags"))));
        Var flags:=GetFlags(CInt("0x"+runeflags[4, 1]));

        Var type;
        Case (CInt("0x"+runeflags[3, 1]))
          TYPE_RUNE_NPC:       type:="NPC";

          TYPE_RUNE_ITEM:      If (flags[2]) // Ist Bit 1 gesetzt? -> InContainerSpawn
                            type:="ItemInContainer";
                          Else
                            type:="Item";
                          EndIf

          TYPE_RUNE_CONTAINER: type:="Container";
        EndCase

        SysLog(type+";"+item.x+";"+item.y+";"+item.z+";"+CInt(GetObjProperty(item, "spawnnet"))+";"+GetObjProperty(item, "template")+";"+
          GetObjProperty(item, "mintime")+";"+GetObjProperty(item, "maxtime")+";"+GetObjProperty(item, "range")+";"+
          GetObjProperty(item, "maxamount")+";"+GetObjProperty(item, "aux")+";"+flags[1]+";"+flags[2]+";"+flags[3]+";"+flags[4]+";"+
          CInt("0x"+runeflags[5, 2])+";"+GetObjProperty(item, "note"));
      EndIf
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////
// RestoreHouseSigns - Stellt Hausschilder wieder her
///////////////////////////////////////////////////////

Var OBJTYPE_BAUPLATZ:={0x6133, 0x6172}; // leere Bauplaetze

Function RestoreHouseSigns()
  ForEach house in ListMultisInBox(0, 0, -128, 6143, 4095, 127)
    If (house.isa(POLCLASS_HOUSE))
      If (house.objtype in OBJTYPE_BAUPLATZ) // Nur freie Bauplaetze...
        ForEach oldsign in ListItemsAtLocation(house.x+1, house.y+6, house.z+2)
          If ((oldsign.objtype==0xbd2) And (!GetObjProperty(oldsign, "house_serial")))
            DestroyItem(oldsign);
          EndIf
        EndForEach
        ForEach oldsign in ListItemsAtLocation(house.x+1, house.y+6, house.z+1)
          If ((oldsign.objtype==0xbd2) And (!GetObjProperty(oldsign, "house_serial")))
            DestroyItem(oldsign);
          EndIf
        EndForEach

        Var oldsign:=ListItemsAtLocation(house.x+1, house.y+6, house.z+2);
        If ((!oldsign.size()) Or (oldsign[1].objtype<>0xbd2))
          Var newsign:=CreateItemAtLocationPergon(house.x+1, house.y+6, house.z+2, 0xbd2);
          If (newsign)
            SetObjProperty(newsign, "house_serial", house.serial);
          EndIf
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////
// CheckNewAIFeatures - Testet neue AI-Script Features
////////////////////////////////////////////////////////

Function CheckNewAIFeatures(who, params)
  SendSysMessagePergon(who, "Bitte den NPC anklickern!");

  Var npc:=Target(who);
  If (npc.isa(POLCLASS_NPC))
    Case (params)
      "1": npc.cmdlevel:=CMDLEVEL_COUNSELOR;
           SendSysMessagePergon(who, "NPC ist nun auf CMDLevel 1");
      "2": npc.cmdlevel:=CMDLEVEL_PLAYER;
           SendSysMessagePergon(who, "NPC ist nun auf CMDLevel 0");
    EndCase
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////////
// CheckAndReCreateBackpacks - Falls jemand sein Backpack verloren hat...
///////////////////////////////////////////////////////////////////////////

Function CheckAndReCreateBackpacks()
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (!char.backpack)
            SysLog("  '"+char.name+"' ["+accountname+"] hat keinen Rucksack!");

            Var backpack:=CreateItemAtLocationPergon(0, 0, 0, 0xe75, 1);
            If (backpack)
              If (!EquipItem(char, backpack))
                SysLog("  '"+char.name+"' ["+accountname+"] mag wohl keinen Rucksack haben!");
                DestroyItem(backpack);
              EndIf
            EndIf
          EndIf
        EndIf
      EndFor
    Else
      SysLog("  Account '"+accountname+"' gibt es nicht!");
    EndIf
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////////////////////////
// CheckGetItemDescriptor - Fuehrt verschiedene Tests mit den neuen Item-Funktionen durch
///////////////////////////////////////////////////////////////////////////////////////////

Function CheckGetItemDescriptor(who)
 // SysLog(CreateItemInContainerPergon(who.backpack, GetItemDescriptor(0x1bd4), 1));
 // SysLog(CreateItemInContainerPergon(who.backpack, 0x1bd4, 1));

 // Var bshafts:=CreateItemInBackpackPergon(who, GetItemDescriptor(UOBJ_SHAFTS), 1, 234);
 //
 // SysLog(bshafts.name);
 // SysLog(bshafts.desc);
 //
 // If (!bshafts.name[" aus "])
 //   bshafts.name:=bshafts.desc+" aus Blubb";
 // EndIf

  Var weapondesc:=GetItemDescriptor(0x13b7);
  SysLog(weapondesc.speed);
  weapondesc.speed:=weapondesc.speed*2;
  Var weapon:=CreateItemInBackpackPergon(who, weapondesc);
  SysLog(weapon.speed);

 // bshafts.desc:=bshafts.name+" aus Blubb";
 // SysLog(bshafts.name);
 // SysLog(bshafts.desc);

 // SysLog(CreateItemInContainerPergon(who.backpack, GetItemDescriptor(0x6991)));
 // SysLog(CreateItemInContainerPergon(who.backpack, 0x6991));

 // SysLog(CreateItemInContainerPergon(who.backpack, GetItemDescriptor(0x84f), 1));
 // SysLog(CreateItemInContainerPergon(who.backpack, 0x84f, 1));
EndFunction

///////////////////////////////////////////////////////////////////
// FixSpawnnetAnchors - Fixt falsche Anker-Einstellungen bei NPCs
///////////////////////////////////////////////////////////////////

Function FixSpawnnetAnchors(who)
  Var count:=0;

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC))
      If (GetObjProperty(npc, "anchorX")) // Muss der NPC gefixt werden?
        SetObjProperty(npc, PROP_ANCHOR, {GetObjProperty(npc, "anchorX"), GetObjProperty(npc, "anchorY"),
          GetObjProperty(npc, "dstart"), GetObjProperty(npc, "psub")});

        EraseObjProperty(npc, "anchorX");
        EraseObjProperty(npc, "anchorY");
        EraseObjProperty(npc, "dstart");
        EraseObjProperty(npc, "psub");

        count:=count+1;
      EndIf
    EndIf
  EndForEach

  SendSysMessagePergon(who, "Es wurden "+count+" NPCs gefixt.", "");
EndFunction

/////////////////////////////////////////////////////////////
// ShowNPCGlobals - Zeigt die globalen Variablen eines NPCs
/////////////////////////////////////////////////////////////

Function ShowNPCGlobals(who)
  Var npc:=Target(who);
  If (npc.isa(POLCLASS_NPC))
    Var process:=npc.process;
    If (process)
      Var globals:=process.globals;

      ForEach key in (globals.keys())
        SysLog(TypeOf(globals[key])+" "+SizeOf(globals[key])+" "+globals[key]);
      EndForEach
    EndIf
  EndIf
EndFunction

//////////////////////////////////////////////////
// ChangeGuildmaster - Aendert den Gildenmeister
//////////////////////////////////////////////////

Function ChangeGuildmaster(who)
  Var guildkennung:="guild"+CInt(0x432c9992); // Gemeinde Lyrells
  Var guild:=GetGlobalProperty(guildkennung);

  SysLog(Lower(Hex(guild[1][1]))+" "+guild[1][3]+" "+guild[1][2]);
  SysLog(Lower(Hex(guild[6][1][1]))+" "+guild[6][1][3]+" "+guild[6][1][2]);
  SysLog(Lower(Hex(guild[6][guild[6].size()][1]))+" "+guild[6][guild[6].size()][3]+" "+guild[6][guild[6].size()][2]);

 // guild[1][1]:=guild[6][guild[6].size()][1];
 // guild[1][2]:=guild[6][guild[6].size()][2];
 // guild[1][3]:="Praetor";

 // Var guildmember:=guild[6][guild[6].size()];
 // guild[6][guild[6].size()][1]:=guild[6][1][1];
 // guild[6][guild[6].size()][2]:=guild[6][1][2];
 // guild[6][guild[6].size()][3]:=guild[6][1][3];
 // guild[6][1][1]:=guildmember[1];
 // guild[6][1][2]:=guildmember[2];
 // guild[6][1][3]:=guildmember[3];

 // Var perilax:=SystemFindObjectBySerial(1125859, SYSFIND_SEARCH_OFFLINE_MOBILES);
 // Var plantron:=SystemFindObjectBySerial(880613, SYSFIND_SEARCH_OFFLINE_MOBILES);
 //
 // Var guildsuffix:=perilax.title_suffix;
 // perilax.title_suffix:=plantron.title_suffix;
 // plantron.title_suffix:=guildsuffix;

 // SetGlobalProperty(guildkennung, guild);

 // Var guildstone:=SystemFindObjectBySerial(0x413902ca);
 // If (guildstone)
 //   Var friends:={};
 //
 //   ForEach friend in GetObjProperty(guildstone, "friends")
 //     If (friend==1125859)
 //       friend:=880613;
 //     EndIf
 //
 //     friends.append(friend);
 //   EndForEach
 //
 //   SetObjProperty(guildstone, "friends", friends);
 // EndIf

 // Var guildstone:=SystemFindObjectBySerial(0x40d50e69);
 // If (guildstone)
 //   DestroyItem(guildstone);
 // EndIf

 // Var guild_list:={};
 // SysLog("Gilden");
 // ForEach guildindex in GetGlobalProperty("guild_list")
 //   If (guildindex[1] in {0x4041f3ea, 0x40d50e69, 0x40734209})
 //     SysLog("  Loeschen - "+guildindex[2]+" ["+guildindex[3]+"] - "+Lower(Hex(guildindex[1]))); // Gildenliste: serial, Gildentitel, Gildenabkürzung
 //   Else
 //     SysLog("  Bleibt   - "+guildindex[2]+" ["+guildindex[3]+"] - "+Lower(Hex(guildindex[1]))); // Gildenliste: serial, Gildentitel, Gildenabkürzung
 //     guild_list.append(guildindex);
 //   EndIf
 // EndForEach
 // SetGlobalProperty("guild_list", guild_list);

 // EraseGlobalProperty("guild1078064106");
 // EraseGlobalProperty("guild1087704681");
EndFunction

///////////////////////////////////////////////////////
// LogGuildInfos - Listen haufenweise Gildeninfos auf
///////////////////////////////////////////////////////

Function LogGuildInfos(who)
  Var guildinfos:=ListGuildInfos();
  Var missingstone:=0;

  SysLog("Gilden");
  ForEach guildid in (guildinfos["Gilden"].keys())
    Var guildinfo:=guildinfos["Gilden"][guildid];
    If (guildinfo["Stein"])
      SysLog("  "+guildinfo["Gilde"][1]+" ["+guildinfo["Gilde"][2]+"] - ID "+guildid);
    Else
      missingstone:=1;
    EndIf
  EndForEach

  If (missingstone)
    SysLog("");
    SysLog("Gilden ohne Gildenstein");

    ForEach guildid in (guildinfos["Gilden"].keys())
      Var guildinfo:=guildinfos["Gilden"][guildid];
      If (!guildinfo["Stein"])
        SysLog("  "+guildinfo["Gilde"][1]+" ["+guildinfo["Gilde"][2]+"] - ID "+guildid);
      EndIf
    EndForEach
  EndIf

  SysLog("");
  SysLog("Gilde");
  ForEach guildid in (guildinfos["Gilden"].keys())
    Var guildinfo:=guildinfos["Gilden"][guildid];

    Var newsgroup:="";
    If (guildinfo["Gilde"][3])
      newsgroup:="pergon.gilde."+guildinfo["Gilde"][3]+" - ";
    EndIf
    If (guildinfo["Stein"])
      SysLog("  "+guildinfo["Gilde"][1]+" ["+guildinfo["Gilde"][2]+"] - ID "+guildid+" - "+newsgroup+"Stein ["+
        Lower(Hex(guildinfo["Stein"][1]))+"] bei "+guildinfo["Stein"][2]+", "+guildinfo["Stein"][3]+", "+guildinfo["Stein"][4]);
    Else
      SysLog("  "+guildinfo["Gilde"][1]+" ["+guildinfo["Gilde"][2]+"] - ID "+guildid+" - "+newsgroup+"(ohne Stein)");
    EndIf

    If (guildinfo["Meister"].size())
      SysLog("    Meister");
      ForEach meister in (guildinfo["Meister"])
        If (meister[2])
          SysLog("      ["+meister[2]+"] "+meister[1]);
        Else
          SysLog("      "+meister[1]);
        EndIf
      EndForEach
    Else
      SysLog("    kein Meister");
    EndIf

    If (guildinfo["Mitglieder"].size())
      SysLog("    Mitglieder");
      ForEach member in (guildinfo["Mitglieder"])
        If (member[3])
          SysLog("      ["+member[3]+"] "+member[2]+" ["+Lower(Hex(member[1]))+" / "+member[4]+"]");
        Else
          SysLog("      "+member[2]+" ["+Lower(Hex(member[1]))+" / "+member[4]+"]");
        EndIf
      EndForEach
    Else
      SysLog("    kein Mitglied");
    EndIf

    SysLog("");
  EndForEach
EndFunction

///////////////////////////////////////////////////////////////////////
// TestListNewsAccounts - Testet die Erzeugung der Newsserver Dateien
///////////////////////////////////////////////////////////////////////

Function TestListNewsAccounts()
  ListNewsAccounts();
EndFunction

////////////////////////////////////////////////////////////////
// RemoveTownStoneKandidat - Kandidat vom Stadtstein entfernen
////////////////////////////////////////////////////////////////

Function RemoveTownStoneKandidat(who)
  Var townstone:=SystemFindObjectBySerial(0x402f1984);
  If (townstone)
    Var kandidaten:=GetObjProperty(townstone, "candidatos");
    Var kandidatenneu:={};
    Var kandidatennummern:={};
    Var index;

    For (index:=1; index<=kandidaten.size(); index:=index+2)
      If (kandidaten[index] in {0x300964, 0x37f0d7})
        SysLog("  Kandidat "+kandidaten[index+1]+" ["+index+"] gefunden");

        kandidatennummern.append(index);
      Else
        kandidatenneu.append(kandidaten[index]);
        kandidatenneu.append(kandidaten[index+1]);
      EndIf
    EndFor

    SetObjProperty(townstone, "candidatos", kandidatenneu);

    ForEach rune in EnumerateItemsInContainer(townstone)
      If (rune.objtype==0xa321)
        Var kandidatennummer:=GetObjProperty(rune, "opcao");
        If (kandidatennummer in kandidatennummern) // Falls die Kandidaten schon gewaehlt wurden...
          SysLog("  Entferne Wahlrune fuer "+kandidatennummer);

          Var gewaehlte:=GetObjProperty(townstone, "votos")-1;
          SetObjProperty(townstone, "votos", gewaehlte);

          Var retval:=0.00;
          retval:=retval+CDbl(gewaehlte);
          retval:=retval/CDbl(GetObjProperty(townstone, "populacao"));
          retval:=retval*100;
          retval:=CInt(retval);

          SetObjProperty(townstone, "votepercent", retval);

          DestroyItem(rune);
        EndIf
      EndIf
    EndForEach
  Else
    SysLog("FEHLER: Stadtstein nicht gefunden!");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////////////////////////////
// CheckMultisCfgDifferences - Vergleicht und ermittelt Unterschiede in den Multi.cfg's
/////////////////////////////////////////////////////////////////////////////////////////

Function CheckMultisCfgDifferences(who)
  Var multiscfg:=ReadConfigFile("multis");
  Var multiscfgold:=ReadConfigFile("multis_old");
  If (multiscfg And multiscfgold)
    ForEach houseids in {{0x64, 0x7f}, {0x8c, 0x8d}, {0x96, 0x96}, {0x98, 0x98}, {0x9a, 0x9a}, {0x9c, 0x9c}, {0x9e, 0x9e}, {0xa0, 0xa0}, {0xa2, 0xa2}, {0xbb8, 0xbb8}, {0x1080, 0x10ae}}
      For houseid:=houseids[1] To houseids[2]
        Var house:=multiscfg[houseid];
        Var houseold:=multiscfgold[houseid];
        If (house And houseold)
          Var static:=GetConfigStringArray(house, "static");
          Var staticold:=GetConfigStringArray(houseold, "static");
          Var dynamic:=GetConfigStringArray(house, "dynamic");
          Var dynamicold:=GetConfigStringArray(houseold, "dynamic");
          Var staticindex:=1;
          Var staticoldindex:=1;
          Var deltax:=-1;
          Var deltay:=-1;
          Var deltaxsign:=-1;
          Var deltaysign:=-1;
          Var gleich:=0;
          Var ungleich:=0;

          While ((staticindex<>-1) And (staticoldindex<>-1))
            Var staticelem:=SplitWords(static[staticindex]);
            Var staticoldelem:=SplitWords(staticold[staticoldindex]);

            If (CInt(staticelem[1])==CInt(staticoldelem[1])) // Items gleich
              If (deltax==-1) // Noch nicht gesetzt
                deltax:=CInt(staticelem[2])-CInt(staticoldelem[2]); // Deltas initialisieren, auf Verdacht
                deltay:=CInt(staticelem[3])-CInt(staticoldelem[3]);
                gleich:=1;ungleich:=0;                  // Wie oft gabs eine Uebereinstimmung?
              Else // Bereits gesetzt, nur pruefen
                If ((deltax==CInt(staticelem[2])-CInt(staticoldelem[2])) And (deltay==CInt(staticelem[3])-CInt(staticoldelem[3])))
                  gleich:=gleich+1;
                Else
                  ungleich:=ungleich+1;
                EndIf
              EndIf

              If ((staticindex>=static.size()) Or (staticoldindex>=staticold.size()))
                staticindex:=-1;staticoldindex:=-1;
              Else
                staticindex:=staticindex+1;staticoldindex:=staticoldindex+1;
              EndIf
            Else
              staticindex:=-1;staticoldindex:=-1; // Naja, erstmal abbrechen
            EndIf
          EndWhile

          staticindex:=1;
          While (staticindex<>-1)
            Var staticelem:=SplitWords(dynamic[staticindex]);
            If (CInt(staticelem[1]) in {0xbd1, 0xbd2, 0xbcf, 0xbd0})
              staticoldindex:=1;
              While (staticoldindex<>-1)
                Var staticoldelem:=SplitWords(dynamicold[staticoldindex]);
                If (CInt(staticoldelem[1]) in {0xbd1, 0xbd2, 0xbcf, 0xbd0})
                  deltaxsign:=CInt(staticelem[2])-CInt(staticoldelem[2]);
                  deltaysign:=CInt(staticelem[3])-CInt(staticoldelem[3]);

                  staticoldindex:=-1;
                Else
                  If (staticoldindex>=dynamicold.size())
                    staticoldindex:=-1;
                  Else
                    staticoldindex:=staticoldindex+1;
                  EndIf
                EndIf
              EndWhile

              staticindex:=-1;
            Else
              If (staticindex>=dynamic.size())
                staticindex:=-1;
              Else
                staticindex:=staticindex+1;
              EndIf
            EndIf
          EndWhile

          If ((deltax==-1) Or (!((deltax==0) And (deltay==0) And (ungleich==0) And (gleich==static.size()) And (gleich==staticold.size()))))
            SysLog("  House;"+Lower(Hex(houseid))+";"+deltax+";"+deltay+";"+deltaxsign+";"+deltaysign+";"+(gleich+ungleich)+";"+gleich+";"+static.size()+";"+staticold.size());
          EndIf
        EndIf
      EndFor
    EndForEach

    UnloadConfigFile(multiscfgold);
    UnloadConfigFile(multiscfg);
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////////////////
// CheckMultisCfgDifferences2 - Vergleicht und ermittelt Unterschiede in den Multi.cfg's
//////////////////////////////////////////////////////////////////////////////////////////

Function CheckMultisCfgDifferences2(who)
 // Var multiscfgold:=ReadConfigFile("multis_old");
 // Var multiscfgold:=ReadConfigFile("multis");
  Var multiscfgold:=ReadConfigFile("multis_neu");
  If (multiscfgold)
    Var dynamicitems:={};

   // ForEach houseids in {{0x64, 0x7f}, {0x8c, 0x8d}, {0x96, 0x96}, {0x98, 0x98}, {0x9a, 0x9a}, {0x9c, 0x9c}, {0x9e, 0x9e}, {0xa0, 0xa0}, {0xa2, 0xa2}, {0xbb8, 0xbb8}, {0x1080, 0x10ae}}
   // ForEach houseids in {{0x108b, 0x108b}, {0x10af, 0x10af}, {0x10b1, 0x10b2}}
    ForEach houseids in {{0x18, 0x1b}}
      For houseid:=houseids[1] To houseids[2]
        Var houseold:=multiscfgold[houseid];
        If (houseold)
          Var dynamicold:=GetConfigStringArray(houseold, "dynamic");

          SysLog("  Haus "+Lower(Hex(houseid)));

          For staticoldindex:=1 To (dynamicold.size())
            Var staticoldelem:=SplitWords(dynamicold[staticoldindex]);
            staticoldelem[1]:=CInt(staticoldelem[1]);

            Var itemdesc:=GetItemDescriptor(staticoldelem[1]);
            If (itemdesc)
              If (itemdesc.objclass=="Door")
                SysLog("    Tuer "+staticoldelem);
              EndIf

              If (!((staticoldelem[1] in {0xbd1, 0xbd2, 0xbcf, 0xbd0}) Or (itemdesc.objclass=="Door")))
                If (!(staticoldelem[1] in dynamicitems))
                  dynamicitems.append(staticoldelem[1]);
                  SysLog("  "+dynamicold[staticoldindex]);
                  SysLog("    "+itemdesc.script);
                EndIf
              EndIf
            EndIf
          EndFor
        EndIf
      EndFor
    EndForEach

    SysLog("  DynamicItems = "+dynamicitems);

    UnloadConfigFile(multiscfgold);
  EndIf
EndFunction

//////////////////////////////////////////////////////////
// TestDifferentRealms - Testet einiges zum Thema Realms
//////////////////////////////////////////////////////////

Function TestDifferentRealms(who)
  who.acct.set_uo_expansion("SE");
EndFunction

///////////////////////////////////
// FindHorses - Sucht alle Pferde
///////////////////////////////////

Function FindHorses(who)
  Var count:=0;

  ForEach object in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (object.isa(POLCLASS_NPC)) // NPCs durchsuchen
      If (Lower(object.npctemplate) in {"horse", "horse2", "horse3", "horse4", "horse_m"})
        Var fehler:="";
        If (!(((!object.gender) And (Lower(object.npctemplate)=="horse_m") And (object.name in {"Hengst", "Hengst domestiziert"})) Or
           ((object.gender) And (Lower(object.npctemplate) in {"horse", "horse2", "horse3", "horse4"}) And (object.name in {"Stute", "Stute domestiziert"})) Or
           (!(object.name in {"Hengst", "Hengst domestiziert", "Stute", "Stute domestiziert"}))))
          fehler:=" STUTE_FEHLER_HENGST";
        EndIf
        If (!(((!object.gender) And (Lower(object.npctemplate)=="horse_m")) Or
           ((object.gender) And (Lower(object.npctemplate) in {"horse", "horse2", "horse3", "horse4"}))))
          fehler:=fehler+" GESCHLECHT_FEHLER";
        EndIf

       // If ((object.script in {":tierzucht:m_domest", ":tierzucht:w_domest"}) And
       //    (!(((!object.gender) And (object.script==":tierzucht:m_domest")) Or
       //    ((object.gender) And (object.scripte==":tierzucht:w_domest")))))
       //   fehler:=" ZUCHT_FEHLER";
       // EndIf

        If (fehler<>"")
          SysLog(object.npctemplate+" "+object.name+" "+object.script+" "+object.gender+" "+object.x+" "+object.y+" "+object.z+fehler);
          count:=count+1;
        EndIf
      EndIf
    EndIf
  EndForEach

  SysLog("Anzahl = "+count);
EndFunction

//////////////////////////////////////////////////////////
// FindTierzuchtTiere - Alle zuechtbaren Tiere auflisten
//////////////////////////////////////////////////////////

Function FindTierzuchtTiere(who)
  Var viecher:={};
  Var count:=0;

  Var npcdesc:=ReadConfigFile("npcdesc");
  If (npcdesc)
    ForEach templatename in GetConfigStringKeys(npcdesc)
      Var template:=npcdesc[templatename];

      If (template.scriptdomest==":tierzucht:w_domest")
        Var template_m:=npcdesc[template.nachwuchs_m];
        viecher.append({Lower(templatename), template.name, template_m.name, template.script, template.gender});
        viecher.append({Lower(template.nachwuchs_m), template_m.name, template.name, template_m.script, template_m.gender});
      EndIf
    EndForEach
  EndIf

  ForEach viech in viecher
   // If (viech[1]=="rabbit")
      ForEach object in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
        If (object.isa(POLCLASS_NPC)) // NPCs durchsuchen
          If (Lower(object.npctemplate)==viech[1])
            Var fehler:="";
            If (object.gender<>viech[5])
              object.gender:=viech[5];
              fehler:=" GESCHLECHT";
            EndIf

            If ((!object.name[viech[2]]) And (object.name[viech[3]]))
              Var tempname:=object.name;
              tempname[viech[3]]:=viech[2];
              object.name:=tempname;
              fehler:=fehler+" NAME ["+tempname+"]";
            EndIf

            If ((object.script in {":tierzucht:m_domest", ":tierzucht:w_domest"}) And
               (!(((!object.gender) And (object.script==":tierzucht:m_domest")) Or
               ((object.gender) And (object.scripte==":tierzucht:w_domest")))))
              fehler:=fehler+" ZUCHT";
            EndIf

            If (fehler<>"")
              SysLog(object.npctemplate+" "+object.name+" "+object.script+" "+object.gender+" "+object.x+" "+object.y+" "+object.z+fehler);
              count:=count+1;
            EndIf
          EndIf
        EndIf
      EndForEach
   // EndIf
  EndForEach

  SysLog("Anzahl = "+count);
EndFunction

////////////////////////////////////////////////////////
// TestWeather - Probiert ein bissl mit dem Wetter rum
////////////////////////////////////////////////////////

Function TestWeather(who, params)
  If (Len(params)==6)
    SendSysMessagePergon(who, "65"+params);
    SendPacket(who, "65"+params);
  EndIf

  If (Len(params)==4)
    SendSysMessagePergon(who, "BC"+params);
    SendPacket(who, "BC"+params);
  EndIf
EndFunction

/////////////////////////////////////////////////////
// TestLight - Probiert ein bissl mit dem Licht rum
/////////////////////////////////////////////////////

Function TestLight(who, params)
 // params:=SplitWords(params);
 //
 // SendSysMessagePergon(who, "Hintergrundlicht setzen");
 // SetDayLightLevel(CInt(params[1]));
 //
 // Sleep(1);
 // SendSysMessagePergon(who, "Los gehts...");
 // SetLightLevelPergon(who, CInt(params[2]), CInt(params[3]));
 // SetLightLevelPergon(who, 20, 20);
 // Sleep(1);
 // SetLightLevelPergon(who, 15, 20);
 // Sleep(1);
 // SetLightLevelPergon(who, 10, 20);
 // Sleep(1);
 // SetLightLevelPergon(who, 5, 20);

 // Sleep(CInt(params[4]));
 // SendSysMessagePergon(who, "...mal zwischenfunken...");
 // SetLightLevelPergon(who, CInt(params[5]), CInt(params[6]));

  SysLog(PlaceNames(who.realm));
  SysLog(PlaceInfos(who));
  SysLog(PlaceRanges(who));

  SysLog(LightInfos(who));
  SysLog(DayLightZones());

EndFunction

//////////////////////////////////////////////////////////
// TestRegions - Probiert ein bissl mit den Regionen rum
//////////////////////////////////////////////////////////

Function TestRegions(who)
  SysLog(PlaceRanges(who));
EndFunction

///////////////////////////////////////////////////////////////////
// TestCreationTime - Probiert ein bissl mit der CreationTime rum
///////////////////////////////////////////////////////////////////

Function TestCreationTime(who, params)
  If (params)
    Case (CInt(params))
      1: CreateItemInBackpackPergon(who, 0xeed, 300);
      2: CreateItemInContainerPergon(who.backpack, 0xeed, 400);
      3: CreateItemInInventoryPergon(who.backpack, 0xeed, 500);

      default: Var item:=Target(who);
               If (item.isa(POLCLASS_ITEM))
                 SetObjProperty(item, "ct", CInt(params));
               EndIf
    EndCase
  Else
    SetObjProperty(CreateItemAtLocationPergon(who.x, who.y+1, who.z, 0xeed, 100), "ct", 1800000);
    SetObjProperty(CreateItemAtLocationPergon(who.x, who.y+2, who.z, 0xeed, 200), "ct",  800000);
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////
// TestSpyOnClient - Probiert ein bissl mit dem Spy-on-Client-Packet rum
//////////////////////////////////////////////////////////////////////////

Function TestSpyOnClient(who)
  SendSysMessagePergon(who, "Waehlt das Opfer! *fg*");

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_MOBILE) And (!mobile.isa(POLCLASS_NPC)))
    Var clientinfo:=mobile.clientinfo;

    SysLog("a "+who.clientinfo);
    SysLog("b "+clientinfo);

    If (clientinfo.unknown1)
      SysLog("SpyOnClient '"+who.name+"' ["+who.acctname+"]");
      SysLog("  Unknown1                 = "+Lower(Hex(clientinfo.unknown1)));
      SysLog("  Unique Instance ID of UO = "+Lower(Hex(clientinfo.instance)));
      SysLog("  OS Version               = "+clientinfo.os_major+"."+clientinfo.os_minor+"."+clientinfo.os_revision);
      SysLog("  CPU Manufacturer         = "+clientinfo.cpu_manufacturer);
      SysLog("  CPU Family               = "+clientinfo.cpu_family);
      SysLog("  CPU Model                = "+clientinfo.cpu_model);
      SysLog("  CPU Clock Speed          = "+clientinfo.cpu_clockspeed+" MHz");
      SysLog("  CPU Quantity             = "+clientinfo.cpu_quantity);
      SysLog("  Memory                   = "+clientinfo.memory+" MB");
      SysLog("  Screen Resolution        = "+clientinfo.screen_width+" x "+clientinfo.screen_height+" x "+clientinfo.screen_depth+" Bit");
      SysLog("  Direct X Version         = "+clientinfo.directx_major+"."+clientinfo.directx_minor);
      SysLog("  Video Card Description   = "+CChrZ(clientinfo.video_description));
      SysLog("  Video Card Vendor ID     = "+clientinfo.video_vendor);
      SysLog("  Video Card Device ID     = "+clientinfo.video_device);
      SysLog("  Video Card Memory        = "+clientinfo.video_memory+" MB");
      SysLog("  Distribution             = "+clientinfo.distribution);
      SysLog("  Clients Running          = "+clientinfo.clients_running);
      SysLog("  Clients Installed        = "+clientinfo.clients_installed);
      SysLog("  Partial Insstalled       = "+clientinfo.partial_installed);
      SysLog("  Language Code            = "+CChrZ(clientinfo.langcode));
      SysLog("  Unknown2                 = "+clientinfo.unknown2);

      SendSysMessagePergon(who, "Schaut einfach mal im Logfile nach...");
    Else
      SendSysMessagePergon(who, "Keine Informationen verfuegbar!");
    EndIf
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////
// TestRandomFloat - Probiert ein bissl mit der Funktion herum
////////////////////////////////////////////////////////////////

Function TestRandomFloat()
  SysLog("  "+RandomFloat(1)+" "+RandomFloat(1)+" "+RandomFloat(1));
  SysLog("  "+RandomFloat(1.0)+" "+RandomFloat(1.0)+" "+RandomFloat(1.0));
  SysLog("  "+RandomFloat(2.0)+" "+RandomFloat(20.0)+" "+RandomFloat(200.0));
  SysLog("  "+RandomFloat(1.0)+" "+RandomFloat(1.0)+" "+RandomFloat(1.0));
EndFunction

///////////////////////////////////////
// FindTownGuards - Sucht Stadtwachen
///////////////////////////////////////

Function FindTownGuards(who)
  Var townguardsequip:=Dictionary;
  Var townguards:=Dictionary;

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC))
      Var equip:=GetObjProperty(npc, "Equipt");
      If (!equip)
        equip:="nix";
      EndIf

      Var template:=Lower(npc.npctemplate);
      If (template in {"castleguardm", "castleguardw", "townguardm", "townguardw", "townguardgodm", "townguardgodw"})
        Var syslogtext:="  "+npc.name+" ["+npc.npctemplate+"] bei "+npc.x+" "+npc.y+" "+npc.z;
        If (!GetObjProperty(npc, "spawnnet"))
          equip:=equip+"_nixRune";
          template:=template+"_nixRune";
          syslogtext:=syslogtext+" [KEINE RUNE]";
        EndIf

        If (townguardsequip[equip])
          townguardsequip[equip]:=townguardsequip[equip]+1;
        Else
          townguardsequip[equip]:=1;
        EndIf

        If (townguards[template])
          townguards[template]:=townguards[template]+1;
        Else
          townguards[template]:=1;
        EndIf

        SysLog(syslogtext);

       // RevokePrivilege(npc, "invul");       // Und nu weg damit :)
       // SetObjProperty(npc, "guardkill", 1);
       // KillMobile(npc, "TextCMD Test-FindTownGuards");
      EndIf
    EndIf
  EndForEach

  SysLog("  townguardsequip = "+townguardsequip);
  SysLog("  townguards = "+townguards);
EndFunction

////////////////////////////////////////////////////////
// FixNPCGender - Korrigiert fehlerhafte Einstellungen
////////////////////////////////////////////////////////

Function FixNPCGender(who)
  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC))
      If ((Lower(npc.npctemplate)=="pig_w") And (!npc.gender))
        npc.gender:=1;
        SysLog("  "+npc.name+" bei "+npc.x+" "+npc.y+" "+npc.z);
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////////////////////////////
// DestroySpecialItemsFromRange - Zerstoert bestimmte Items (Mai's Haus)
//////////////////////////////////////////////////////////////////////////

Function DestroySpecialItemsFromRange(who)
  Var grasses:={};
  Var remove:=0;
  Var moved:=0;

  Var tilescfg:=ReadConfigFile("::tiles");
  If (tilescfg)
    ForEach tileobjtype in GetConfigStringKeys(tilescfg)
      Var tile:=tilescfg[tileobjtype];
      If (tile.desc=="grass")
        grasses.append(CInt(tileobjtype));
      EndIf
    EndForEach

    UnloadConfigFile("::tiles");
  EndIf

  SysLog("  Gras = "+grasses);

 // Var basisx:=2020;
 // Var basisy:=816;
 // Var basisz:=0;
  Var basisx:=5464;
  Var basisy:=1183;
  Var basisz:=0;

  SysLog("  Items loeschen");
  ForEach item in ListObjectsInBox(basisx-14, basisy-13, basisz, basisx, basisy, basisz)
    If (item.isa(POLCLASS_ITEM))
      SysLog("    "+item.desc+" "+Lower(Hex(item.objtype)));
      If (item.objtype in grasses)
        DestroyItem(item);
        remove:=remove+1;
      EndIf
    EndIf
  EndForEach
  SysLog("  Items geloescht = "+remove);

  Var hausx:=515;
  Var hausy:=1028;
  Var hausz:=1;

  SysLog("  Items verschieben");
  ForEach item in ListObjectsInBox(basisx-14, basisy-13, -128, basisx, basisy, 127)
    If (item.isa(POLCLASS_ITEM))
      SysLog("    "+item.desc+" "+Lower(Hex(item.objtype)));
      item.movable:=1;
      MoveObjectToLocation(item, item.x-basisx+hausx, item.y-basisy+hausy, item.z-basisz+hausz, item.realm, MOVEOBJECT_FORCELOCATION);
      item.movable:=0;
      moved:=moved+1;
    EndIf
  EndForEach
  SysLog("  Items verschoben = "+moved);
EndFunction

////////////////////////////////////////////////////////////////////////////
// TestServerClientPackets - Testet verschiedene Dinge mit den Packets rum
////////////////////////////////////////////////////////////////////////////

Function TestServerClientPackets(who)
  SendSysMessagePergon(who, "Pause Client"); // Pause Client 0x33
  SendPacket(who, "3301");

  Sleep(30);

  SendPacket(who, "3300");
  SendSysMessagePergon(who, "Pause Client");
EndFunction

////////////////////////////////////////////////////////
// FixItemNames - Korrigiert Fehler im Namen von Items
////////////////////////////////////////////////////////

Function FixItemNames(who)
  Var changed:=0;

 // Var serial:=0x42f6816d;
  For serial:=0x40000000 To 0x489fffff
 // For serial:=0x40000000 To 0x45000000
 // For serial:=0x4422947e To 0x44229483
    Var item:=SystemFindObjectBySerial(serial, SYSFIND_SEARCH_OFFLINE_MOBILES);
    If (item.isa(POLCLASS_ITEM))
      If (((MIN_MAGE_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_MAGE_SPELL_ITEM)) Or
         ((MIN_CLERIC_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_CLERIC_SPELL_ITEM)) Or
         ((MIN_NECRO_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_NECRO_SPELL_ITEM)))
        If (GetObjProperty(item, "copied"))
         // If (TypeOf(GetObjProperty(item, "copied"))=="String")
         //   SetObjProperty(item, "copied", 1);
         //   changed:=changed+1;
         // EndIf

          Var color:=-1;
          If ((MIN_MAGE_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_MAGE_SPELL_ITEM))
            color:=1815;
          ElseIf ((MIN_CLERIC_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_CLERIC_SPELL_ITEM))
            color:=1150;
          ElseIf ((MIN_NECRO_SPELL_ITEM<=item.objtype) And (item.objtype<=MAX_NECRO_SPELL_ITEM))
            color:=2304;
          EndIf

          If (color<>-1) // Eigentlich unnoetig
            Var castscroll:=GetItemDescriptor(item.objtype+MIN_MAGE_CAST_ITEM-MIN_MAGE_SPELL_ITEM);
            castscroll.cprops.insert("castable", 0);
            If (GetObjProperty(item, "lockeddown"))
              castscroll.cprops.insert("lockeddown", GetObjProperty(item, "lockeddown"));
            EndIf
            castscroll.color:=color;

            Var serial:=Lower(Hex(item.serial))+": ";
            LogToFile("log/scroll_convert.log", serial+item.desc);

            Var amount:=item.amount;
            Var movable:=item.movable;
            Var container:=item.container;
            If (container)
              If (DestroyItem(item))
                Var scroll:=CreateItemInContainerPergon(container, castscroll, amount);
                If (scroll)
                  scroll.movable:=movable;
                  changed:=changed+1;
                  LogToFile("log/scroll_converted.log", serial+"wurde durch "+scroll.desc+" ersetzt");
                Else
                  LogToFile("log/scroll_not_converted.log", serial+"konnte nicht durch eine neue Version ersetzt werden ("+Lower(Hex(container.serial))+")");
                EndIf
              Else
                LogToFile("log/scroll_not_deleted.log", serial+"konnte nicht geloescht werden");
              EndIf
            Else
              Var x:=item.x;
              Var y:=item.y;
              Var z:=item.z;
              If (DestroyItem(item))
                Var scroll:=CreateItemAtLocationPergon(x, y, z, castscroll, amount);
                If (scroll)
                  scroll.movable:=movable;
                  changed:=changed+1;
                  LogToFile("log/scroll_converted.log", serial+"wurde durch "+scroll.desc+" ersetzt");
                Else
                  LogToFile("log/scroll_not_converted.log", serial+"konnte nicht durch eine neue Version ersetzt werden ("+x+" "+y+" "+z+")");
                EndIf
              Else
                LogToFile("log/scroll_not_deleted.log", serial+"konnte nicht geloescht werden");
              EndIf
            EndIf
          EndIf
        EndIf
      EndIf
    EndIf

    If (CInt((serial-0x40000000)/500000)*500000==(serial-0x40000000))
      SysLog("  serial = "+Lower(Hex(serial))+" ["+(serial-0x40000000)+"] - "+changed);
    EndIf

    SleepMS(1); // Soll nebenbei laufen, aber nicht gross stoeren
  EndFor

  SysLog("  changed = "+changed);

     // If (item.desc["Eishoele"])
     //   SysLog("    "+Lower(Hex(item.serial))+" "+item.desc);

     //   Var desc:=item.desc;
     //   desc["Eishoele"]:="Eishoehle";
     //   SetName(item, desc);
     //   SysLog("      "+item.desc);
     //   SetName(item, "Beutel mit 149 Nachtsichttraenken");
     //   item.movable:=1;
EndFunction

/////////////////////////////////////////////////////////
// FixItemColor - Korrigiert Fehler in Farben von Items
/////////////////////////////////////////////////////////

Function FixItemColor(who)
 // ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
 //   If (item.isa(POLCLASS_ITEM))
 //     If (item.objtype==0x11b0)
 //       If (item.color<>0)
 //         SysLog("    Kreissage "+Lower(Hex(item.serial))+" "+item.x+" "+item.y+" "+item.z);
 //       EndIf
 //     EndIf
 //   EndIf
 // EndForEach

 // Var item:=SystemFindObjectBySerial(0x405357a7);
 // If (item)
 //   SysLog("  A "+item.x+" "+item.y+" "+item.z);
 //   item.movable:=1;item.x:=2236;item.y:=1207;item.z:=0;item.movable:=0;
 //   SysLog("  B "+item.x+" "+item.y+" "+item.z);
 // EndIf

 // item:=SystemFindObjectBySerial(0x405357bd);
 // If (item)
 //   SysLog("  C "+item.x+" "+item.y+" "+item.z);
 //   item.movable:=1;item.x:=2236;item.y:=1211;item.z:=0;item.movable:=0;
 //   SysLog("  D "+item.x+" "+item.y+" "+item.z);
 // EndIf

 // Var item:=SystemFindObjectBySerial(0x427ba804);
 // If (item)
 //   Var werkzeug:=GetObjProperty(item, "Werkzeug");
 //   werkzeug[5]:=111;
 //   SetObjProperty(item, "Werkzeug", werkzeug);
 // EndIf

  Var item:=CreateItemInBackpackPergon(who, 0x203b);
  SysLog(item.desc+" "+item.layer);
EndFunction

////////////////////////////////////////////////////////////////////
// GenerateTilesList - Sucht Tiles mit bestimmten Kriterien heraus
////////////////////////////////////////////////////////////////////

Function GenerateTilesList(who)
  Var lavaslist:={};
  Var lavas:=0;
  Var lavalist:={};
  Var lava:=0;
  Var lightlavalist:={};
  Var lightlava:=0;
  Var animlavalist:={};
  Var animlava:=0;
  Var animlightlavalist:={};
  Var animlightlava:=0;

  Var tilescfg:=ReadConfigFile("::tiles");
  If (tilescfg)
    ForEach tileobjtype in GetConfigStringKeys(tilescfg)
      Var tilef:=tilescfg[tileobjtype];
      If (tile.desc["lava"])
        lavas:=lavas+1;
        If (!(tileobjtype in lavaslist))
          lavaslist.append(tileobjtype);
        EndIf

        If (tile.desc=="lava")
          lava:=lava+1;
          If (!(tileobjtype in lavalist))
            lavalist.append(tileobjtype);
          EndIf

          If (tile.uoflags in {0x1000000, 0x1000020})
            lightlava:=lightlava+1;
            If (!(tileobjtype in lightlavalist))
              lightlavalist.append(tileobjtype);
            EndIf
          EndIf

          If (tile.uoflags==0x800040)
            animlava:=animlava+1;
            If (!(tileobjtype in animlavalist))
              animlavalist.append(tileobjtype);
            EndIf
          EndIf

          If (tile.uoflags==0x1800020)
            animlightlava:=animlightlava+1;
            If (!(tileobjtype in animlightlavalist))
              animlightlavalist.append(tileobjtype);
            EndIf
          EndIf
        EndIf
      EndIf
    EndForEach

    UnloadConfigFile("::tiles");
  EndIf

  SysLog(lavas+" "+lavaslist);
  SysLog(lava+" "+lavalist);
  SysLog(lightlava+" "+lightlavalist);
  SysLog(animlava+" "+animlavalist);
  SysLog(animlightlava+" "+animlightlavalist);
EndFunction

/////////////////////////////////////////////////////////
// TestCoreFunctions - Testet bestimmte Core-Funktionen
/////////////////////////////////////////////////////////

Function TestCoreFunctions(who)
  Var randoms:={};

  For index:=1 To 100
    randoms[index]:=0;
  EndFor

  Var durchlaeufe:=10000000;
  For anzahl:=1 To durchlaeufe
    Var index:=RandomInt(100)+1;
    randoms[index]:=randoms[index]+1;
    SleepMS(1);
  EndFor

  SysLog("  "+durchlaeufe+" Durchlaeufe ergaben "+randoms);
EndFunction

/////////////////////////////////////////////////
// SummonNPC - Holt einen beliebigen NPC herbei
/////////////////////////////////////////////////

Function SummonNPC(who, params)
 // Var npc:=SystemFindObjectBySerial(CInt(params));
 // If (npc)
 //   MoveObjectToLocation(npc, who.x, who.y, who.z, who.realm);
 // EndIf

 // Var mobile:=SystemFindObjectBySerial(0x1fdc21, SYSFIND_SEARCH_OFFLINE_MOBILES);
 // If (mobile)
 //   SendSysMessagePergon(who, "Gefunden");
 //   SendSysMessagePergon(who, GetIntPergon(mobile)+" "+GetIntModPergon(mobile));
 //   SetIntModPergon(mobile, 0);
 //   SendSysMessagePergon(who, GetIntPergon(mobile)+" "+GetIntModPergon(mobile));
 // Else
 //   SendSysMessagePergon(who, "Nicht gefunden");
 // EndIf

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_MOBILE))
    mobile.title_prefix:="";
    mobile.title_suffix:="";
    mobile.title_guild:="";
    mobile.title_race:="";
  EndIf
EndFunction

//////////////////////////////////////////////////////////////
// CheckCreateNPC - Prueft ein bissl was zum Thema CreateNPC
//////////////////////////////////////////////////////////////

Const MAX_CREATE_TRYES:=4;

Function CheckCreateNPC(who)
  Var chest:=Struct{x:=who.x, y:=who.y, z:=who.z};
  Var template:="horse";
  Var range:=4;

  Var times:=0; // Wieviele Versuche hab ich schon gebraucht?
  Var creature;
  Var origspawnx;
  Var origspawny;
  Var origspawnz;
  Var spawnx;
  Var spawny;
  Var spawnz;

  // Spawn-Location suchen
  While ((times<>-1) And (times<=MAX_CREATE_TRYES))
    spawnx:=chest.x+RandomInt(range*2)-range;
    spawny:=chest.y+RandomInt(range*2)-range;
    spawnz:=GetStandingHeight(spawnx, spawny, chest.z);

    If (spawnz==error)
      times:=times+1;
    Else
      spawnz:=spawnz.z;
      times:=-1;
    EndIf
  EndWhile

  // Keine passende Spawn-Location gefunden
  If (times>MAX_CREATE_TRYES)
    SendSysMessagePergon(who, "Konnte fuer '"+template+"' keine Location finden!");
    Return;
  EndIf

  times:=0; // Wieviele Versuche hab ich schon gebraucht?

  // NPC erzeugen
  While ((times<>-1) And (times<=MAX_CREATE_TRYES))
    origspawnx:=5280+RandomInt(9);
    origspawny:=1182+RandomInt(5);
    origspawnz:=0;

    creature:=CreateNpcFromTemplatePergon(template, origspawnx, origspawny, origspawnz, 2, 0);
    If (creature)
      times:=-1;
    Else
      times:=times+1;
    EndIf
  EndWhile

  // NPC konnte nicht erzeugt werden
  If (times>MAX_CREATE_TRYES)
    SendSysMessagePergon(who, "Konnte fuer '"+template+"' keine Location im Knast finden!");
    Return;
  EndIf

  // NPC an seine Ziellocation verschieben
  MoveObjectToLocation(creature, spawnx, spawny, spawnz, creature.realm, MOVEOBJECT_FORCELOCATION);
EndFunction

/////////////////////////////////////////////////////////
// MakeEquipMovable - Macht alle Items wieder beweglich
/////////////////////////////////////////////////////////

Function MakeEquipMovable(who)
  SendSysMessagePergon(who, "Bitte einen Mobile auswaehlen!", "");

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_MOBILE))
    ForEach item in ListEquippedItems(mobile)
      EraseObjProperty(item, "cursed");
      item.movable:=1;
    EndForEach
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ArenaQuest - Ermoeglicht den Kampf normaler Spieler in der Arena (ausgelagert nach scrtips/textcmd/5_highgm/arenaquest)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Function ArenaQuest(who, prop)
  If (CInt(prop)==2)
    ForEach accountname in ListAccounts()
      Var account:=FindAccount(accountname);
      If (account)
        For charnr:=1 To 5
          Var char:=account.getcharacter(charnr);
          If (char)
            EraseObjProperty(char, ARENABATTLE);
          EndIf
        EndFor
      Else
        SysLog("'"+accountname+"' gibt es nicht !");
      EndIf
    EndForEach
  Else
    SendSysMessagePergon(who, "Bitte einen Mobile auswaehlen!", "");

    Var mobile:=Target(who);
    If (mobile.isa(POLCLASS_MOBILE))
      If (!GetObjProperty(mobile, ARENABATTLE))
        SetObjProperty(mobile, ARENABATTLE, 1);
        mobile.hidden:=1;
        SendSysMessagePergon(mobile, "Ihr könnt nun Eure Rueste fuer den Kampf anlegen!", "", _DEFAULT_TEXT_FONT, FONTCOLOR_GREEN);
        SendSysMessagePergon(mobile, "Sobald sie angelegt ist, irgendwas sagen wie 'los'...", "", _DEFAULT_TEXT_FONT, FONTCOLOR_GREEN);
        SendSysMessagePergon(mobile, "Und dann werdet Ihr auch bald zum Start teleportiert.", "", _DEFAULT_TEXT_FONT, FONTCOLOR_GREEN);
      EndIf

      SendSysMessagePergon(who, mobile.name+" "+mobile.ar_mod+" "+GetStrModPergon(mobile)+" "+GetDexModPergon(mobile)+" "+GetIntModPergon(mobile));
      If (mobile.ar_mod And prop)
        mobile.ar_mod:=0;
        SendSysMessagePergon(who, "-> reset");
      EndIf
      EraseObjProperty(mobile, "#ss");
      EraseObjProperty(mobile, "#dd");
      EraseObjProperty(mobile, "#ii");
      EraseObjProperty(mobile, "#aa");
      EraseObjProperty(mobile, "#pp");
      EraseObjProperty(mobile, "#bb");
      EraseObjProperty(mobile, "#cc");

      ForEach item in ListEquippedItems(mobile)
        If ((item.isa(POLCLASS_WEAPON)) Or (item.isa(POLCLASS_ARMOR)))
          If (item.isa(POLCLASS_WEAPON))
            SendSysMessagePergon(who, mobile.name+" "+item.dmg_mod+" "+item.desc);
            If (item.dmg_mod And prop)
              item.dmg_mod:=0;
              SendSysMessagePergon(who, "-> reset");
            EndIf
          Else
            SendSysMessagePergon(who, mobile.name+" "+item.ar_mod+" "+item.desc);
            If (item.ar_mod And prop)
              item.ar_mod:=0;
              SendSysMessagePergon(who, "-> reset");
            EndIf
          EndIf
          EraseObjProperty(item, "blessed");

          ForEach propname in GetObjPropertyNames(item)
            If (propname<>"Werkzeug")
              SendSysMessagePergon(who, "Prop "+propname+" = "+GetObjProperty(item, propname));
            EndIf
          EndForEach
        EndIf
      EndForEach
    Else
      SendSysMessagePergon(who, "Abbruch", "Abort");
    EndIf
  EndIf
EndFunction

///////////////////////////////////////////////////////////
// ExchangeElementals - Tauscht die ganzen Elementare aus
///////////////////////////////////////////////////////////

Function ExchangeElementals(who)
  // Erstmal alle SpawnRunen aendern
  ForEach obj in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (GetObjProperty(obj, "spawnnet")) // Wird es vom SpawnNet verwaltet ?
      If (obj.isa(POLCLASS_ITEM)) // Ist es ein Item?
        If (obj.objtype==UOBJ_SPAWNRUNE) // Ist es eine SpawnRune?
          If (Lower(GetObjProperty(obj, "template")) in {"airelemental", "poisonelemental", "earthelemental", "fireelemental", "waterelemental"})
            SysLog("  Konvertiere Rune "+Lower(Hex(obj.serial)));

            Case (Lower(GetObjProperty(obj, "template"))+" bei "+obj.x+" "+obj.y+" "+obj.z)
              "airelemental":    SetObjProperty(obj, "template", "lesserairelemental");
              "poisonelemental": SetObjProperty(obj, "template", "lesserpoisonelemental");
              "earthelemental":  SetObjProperty(obj, "template", "lesserearthelemental");
              "fireelemental":   SetObjProperty(obj, "template", "lesserfireelemental");
              "waterelemental":  SetObjProperty(obj, "template", "lesserwaterelemental");
            EndCase
          EndIf
        EndIf
      EndIf
    EndIf
  EndForEach

  // Und nun noch die NPCs selber
  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC) And (Lower(npc.npctemplate) in {"airelemental", "poisonelemental", "earthelemental", "fireelemental", "waterelemental"}))
      SysLog("  Entferne Elementar "+Lower(Hex(npc.serial)));

      RevokePrivilege(npc, "invul");
      SetObjProperty(npc, "guardkill", 1);
      KillMobile(npc, "TextCMD Test-ExchangeElementals");
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////////////
// ExchangeBears - Tauscht die ganzen Baeren aus
//////////////////////////////////////////////////

Function ExchangeBears(who)
  ForEach obj in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (GetObjProperty(obj, "spawnnet")) // Wird es vom SpawnNet verwaltet ?
      If (obj.isa(POLCLASS_ITEM)) // Ist es ein Item?
        If (obj.objtype==UOBJ_SPAWNRUNE) // Ist es eine SpawnRune?
          If (Lower(GetObjProperty(obj, "template")) in {"bear", "bear_w", "blackbear", "blackbear_w", "polar", "polar_w",
              "dog", "dog_w", "cat", "cat_m", "ape", "ape_w", "gorilla", "gorilla_w", "wolf", "wolf_w", "direwolf", "direwolf_w"})
            SysLog("  Konvertiere Rune "+Lower(Hex(obj.serial))+" bei "+obj.x+" "+obj.y+" "+obj.z+
              " mit Template '"+GetObjProperty(obj, "template")+"'");

            Case (Lower(GetObjProperty(obj, "template")))
              "bear":
              "bear_w":      SetObjProperty(obj, "template", 102);
              "blackbear":
              "blackbear_w": SetObjProperty(obj, "template", 103);
              "polar":
              "polar_w":     SetObjProperty(obj, "template", 208);
              "dog":
              "dog_w":       SetObjProperty(obj, "template", 104);
              "cat":
              "cat_m":       SetObjProperty(obj, "template", 105);
              "ape":
              "ape_w":       SetObjProperty(obj, "template", 106);
              "gorilla":
              "gorilla_w":   SetObjProperty(obj, "template", 107);
              "wolf":
              "wolf_w":      SetObjProperty(obj, "template", 108);
              "direwolf":
              "direwolf_w":  SetObjProperty(obj, "template", 109);
            EndCase
          EndIf
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////////
// ExchangeMainAIAnimals - Tauscht alle Main_AI Viecher aus
/////////////////////////////////////////////////////////////

Function ExchangeMainAIAnimals(who)
  Var number:=0;
  Var subnumber:=0;

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC) And (Lower(npc.script)=="main_ai"))
      SysLog("  Entferne Tier "+Lower(Hex(npc.serial))+" "+npc.name);

      RevokePrivilege(npc, "invul");
      SetObjProperty(npc, "guardkill", 1);
      KillMobile(npc, "TextCMD ExchangeMainAIAnimals");

      number:=number+1;
      subnumber:=subnumber+1;
      If (subnumber>10)
        subnumber:=0;
        SendSysMessagePergon(who, number+" NPCs entfernt");
      EndIf
    EndIf
  EndForEach

  SendSysMessagePergon(who, "Insgesamt "+number+" NPCs entfernt.");
EndFunction

/////////////////////////////////////////////////////////////
// KillNPCsByScriptType - NPCs eines Scriptstypes entfernen
/////////////////////////////////////////////////////////////

Function KillNPCsByScriptType(who)
  Var number:=0;
  Var subnumber:=0;

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC) And (Lower(npc.script) in {"grazer", "grazer_new"}))
      SysLog("  Entferne Tier "+Lower(Hex(npc.serial))+" "+npc.name);

      RevokePrivilege(npc, "invul");
      SetObjProperty(npc, "guardkill", 1);
      KillMobile(npc, "TextCMD KillNPCsByScriptType");

      number:=number+1;
      subnumber:=subnumber+1;
      If (subnumber>10)
        subnumber:=0;
        SendSysMessagePergon(who, number+" NPCs entfernt");
      EndIf
    EndIf
  EndForEach

  SendSysMessagePergon(who, "Insgesamt "+number+" NPCs entfernt.");
EndFunction

//////////////////////////////////////////////////////
// HeavenizeNPCs - Versetzt NPCs in den Schlaf-Modus
//////////////////////////////////////////////////////

Function HeavenizeNPCs(who, params)
  If (!params) // NPCs in den Himmel verschieben
    Var timecode:=ReadGameClock();

    ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (npc.isa(POLCLASS_NPC) And (Lower(npc.npctemplate) in {"townguardm", "townguardw", "townguardgodm", "townguardgodw"}))
        SysLog("  Verschieben Stadtwache "+Lower(Hex(npc.serial))+" ["+npc.x+" "+who.y+" "+who.z+"] in den Himmel");

        SetObjProperty(npc, "Heavenize", timecode);
        PetSetHeaven(who, npc);
      EndIf
    EndForEach

    SendSysMessagePergon(who, "Beim Wiederherstellen bitte via '.test "+timecode+"' aufrufen!");
  Else
    ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
      If (npc.isa(POLCLASS_NPC) And (npc.script=="heaven"))
        If (GetObjProperty(npc, "Heavenize")==CInt(params))
          SysLog("  Verschieben Stadtwache "+Lower(Hex(npc.serial))+" ["+npc.x+" "+who.y+" "+who.z+"] auf die Erde");

          EraseObjProperty(npc, "Heavenize");
          PetGetHeaven(who, npc.serial);
          EraseObjProperty(npc, "master");
          RestartScript(npc);
        EndIf
      EndIf
    EndForEach
  EndIf
EndFunction

////////////////////////////////////////////////////////
// CheckQuestArrow - Spielt mit der Quest-Funktion rum
////////////////////////////////////////////////////////

Function CheckQuestArrow(who, params)
  If (params=="off")
    SendQuestArrow(who);
  Else
    SendQuestArrow(who, who.x-5+RandomInt(10), who.y-5+RandomInt(10));
  EndIf
EndFunction

//////////////////////////////////////////////////
// FindSpawnRunes - Findest bestimmte SpawnRunen
//////////////////////////////////////////////////

Function FindSpawnRunes(who)
  ForEach obj in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    Var spawnnet:=CInt(GetObjProperty(obj, "spawnnet"));
    If (spawnnet) // Wird es vom SpawnNet verwaltet ?
      If (obj.isa(POLCLASS_ITEM)) // Ist es ein Item?
        If (obj.objtype==UOBJ_SPAWNRUNE) // Ist es eine SpawnRune?
          Var runeflags:=CInt(GetObjProperty(obj, "flags"));
          If (runeflags<0x1000)
            runeflags:=0x1000;
          EndIf
          runeflags:=CStr(Hex(runeflags));

          If (CInt("0x"+runeflags[3, 1])==3) // ContainerSpawn
            SysLog("  Rune bei "+obj.x+" "+obj.y+" "+obj.z);
          EndIf
        EndIf
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////
// TestZonk - Testet die Sache mit dem Zonk
/////////////////////////////////////////////

Function TestZonk(who)
  Var chest:=who.backpack;

  Var item:=CreateItemInContainerPergon(chest, 0x14ef, 1);
  If (item)
    item.name:="Die Kiste scheint leer...";
    item.usescript:=":treasuremap:treasureletter";
  EndIf

  CreateItemInContainerPergon(chest, 0x3bf0, 1); // Der Zonk
EndFunction

/////////////////////////////////////////////////////////
// TestRealmBugs - Testet bestimmte Probleme mit Realms
/////////////////////////////////////////////////////////

Function TestRealmBugs(who)
  SendSysMessagePergon(who, "Geh nach Minoc und klicker mal was an!");

  Var item:=Target(who);
  If (item)
    SysLog("Item "+Lower(Hex(item.serial))+" angeklickert ["+item.realm+"]");
   // MoveObjectToLocation(item, 5285, 1174, 0, REALM_BRITANNIA);
    MoveObjectToLocation(who, 1169, 998, 41, REALM_TOKUNO, MOVEOBJECT_FORCELOCATION);
    If (MoveObjectToLocation(item, 1169, 998, 41, REALM_TOKUNO))
      If (item.isa(POLCLASS_CONTAINER))
        ForEach subitem in EnumerateItemsInContainer(item)
          SysLog("  "+subitem.desc+" "+item.realm);
        EndForEach
      EndIf
    EndIf
    SysLog("Item "+Lower(Hex(item.serial))+" verschoben ["+item.realm+"]");
  EndIf
EndFunction

////////////////////////////////////////////////
// CreateHairBeard - Erzeugt Haare oder Baerte
////////////////////////////////////////////////

Function CreateHairBeard(who, params)
  params:=SplitWords(params);
  If (CInt(params[1])==0)
    DestroyItem(GetEquipmentByLayer(who, LAYER_HAIR));
    DestroyItem(GetEquipmentByLayer(who, LAYER_BEARD));
  ElseIf (params.size()==2)
    Var item:=CreateItemAtLocationPergon(who.x, who.y, who.z, CInt(params[1]));
    If (item)
      item.color:=CInt(params[2]);
      EquipItem(who, item);
    Else
      SendSysMessagePergon(who, "Das Item konnte nicht erzeugt werden!");
    EndIf
  Else
    SendSysMessagePergon(who, "Bitte ObjType und Farbe angeben!");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////
// CheckCombatDelayMod - Testet ein bissl mit den neuen Waffen rum
////////////////////////////////////////////////////////////////////

Function CheckCombatDelayMod(who, params)
  Var old:=who.delay_mod;
  who.delay_mod:=CInt(params);

  SendSysMessagePergon(who, "Delay_Mod von "+old+" auf "+who.delay_mod+" geaendert.");
EndFunction

///////////////////////////////////////////
// TestListMobiles - Testet ein bissl rum
///////////////////////////////////////////

Function TestListMobiles(who)
  ForEach mobile in ListMobilesNearLocation(who.x, who.y, who.z, 10)
    SysLog("  "+mobile.name+" "+who.x+" "+who.y+" "+who.z);
  EndForEach
EndFunction

//////////////////////////////////////////////////////////
// ListSpawnNetItems - Sucht vom SpawnNet erzeugte Items
//////////////////////////////////////////////////////////

Function ListSpawnNetItems(who)
  ForEach item in ListObjectsInBox(5120, 0, -128, 6143, 4095, 127)
    If (item.isa(POLCLASS_CONTAINER))
      If (GetObjProperty(item, "spawnnet"))
        SysLog("  "+item.desc+" "+item.x+" "+item.y+" "+item.z);
      EndIf
    EndIf
  EndForEach
EndFunction

//////////////////////////////////////////
// DeleteAccount - Loescht einen Account
//////////////////////////////////////////

Function DeleteAccount(who, params)
  Var account:=FindAccount(params);
  If (account)
    If (account.delete())
      SendSysMessagePergon(who, "Account '"+params+"' wurde geloescht.");
    Else
      SendSysMessagePergon(who, "Account '"+params+"' konnte nicht geloescht werden!");
    EndIf
  Else
    SendSysMessagePergon(who, "Es gibt keinen Account '"+params+"' !");
  EndIf
EndFunction

/////////////////////////////////////////
// SplitAccount - Zerlegt einen Account
/////////////////////////////////////////

Function SplitAccount(who, params)
  params:=SplitWords(params);
  If (params.size()==3)
   // Var oldaccountname:=params[1];
   // Var oldindex:=CInt(params[2]);
   // Var newaccountname:=params[3];
    Var oldaccountname:="Olaf der Rote";
    Var oldindex:=2;
    Var newaccountname:="Isidora";

    Var oldaccount:=FindAccount(oldaccountname);
    If (oldaccount)
      Var oldcharacter:=oldaccount.getcharacter(oldindex);
      If (oldcharacter)
        oldaccount.split(newaccountname, oldindex);

        SendSysMessagePergon(who, "Account '"+newaccountname+"' wurde erzeugt und der Char '"+oldcharacter.name+"' wurde dorthin verschoben.");
      Else
        SendSysMessagePergon(who, "Es gibt keinen Character mit der ID "+oldindex+" !");
      EndIf
    Else
      SendSysMessagePergon(who, "Es gibt keinen Account '"+oldaccountname+"' !");
    EndIf
  Else
    SendSysMessagePergon(who, "Params: oldaccount oldindex newaccount");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////////////
// TestEnumerateItemsInContainer - Testet ein bissl an der Funktion rum
/////////////////////////////////////////////////////////////////////////

Function TestEnumerateItemsInContainer(who, params)
  SendSysMessagePergon(who, "Bitte einen Container auswaehlen!");

  Var container:=Target(who);
  If (container.isa(POLCLASS_CONTAINER))
    ForEach item in EnumerateItemsInContainer(container, CInt(params))
      SysLog("  "+item.desc);
    EndForEach
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////
// TestSecureTradeWin - Testet verschiedene Dinge mit dem TradeWin
////////////////////////////////////////////////////////////////////

Function TestSecureTradeWin(who, params)
  SendSysMessagePergon(who, "Bitte einen Spieler auswaehlen!");

  Var mobile:=Target(who);
  If (mobile.isa(POLCLASS_MOBILE) And (!mobile.isa(POLCLASS_NPC)))
    SysLog(SecureTradeWin(who, mobile));
  EndIf

  While (1)
    SendSysMessagePergon(who, "Bitte ein Item auswaehlen!");

    Var item:=Target(who);
    If (item.isa(POLCLASS_ITEM))
      SysLog(MoveItemToSecureTradeWin(item, who));
    Else
      Break;
    EndIf
  EndWhile

  SendSysMessagePergon(who, "Bitte noch ein Item auswaehlen!");

  Var item:=Target(who);
  If (item.isa(POLCLASS_ITEM))
    SysLog(MoveItemToSecureTradeWin(item, mobile));
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////
// TestFindPathCrashes - Versucht den Server zum Absturz zu bewegen...
////////////////////////////////////////////////////////////////////////

Function TestFindPathCrashes(who, params)
  SysLog("FindPath  -1 = "+FindPath(5860, 1450, 0, 5856, 1465, -2, _DEFAULT_REALM, 0));
 // SysLog("FindPath  -1 = "+FindPath(5860, 1450, 0, 5856, 1465, -2));                  // Solution Corrupted!
 // SysLog("FindPath  -2 = "+FindPath(5393, 838, 45, 5394, 826, 60));                   // Solution Corrupted!
 // SysLog("FindPath  -3 = "+FindPath(5439, 720, 15, 5449, 717, 15));                   // Solution Corrupted!
 // SysLog("FindPath  -4 = "+FindPath(5143, 678, 0, 5140, 690, 0));                     // Found Path...
 // SysLog("FindPath  -5 = "+FindPath(314, 967, -78, 317, 951, -72, REALM_ILSHENAR));   // Solution Corrupted!
 // SysLog("FindPath  -6 = "+FindPath(779, 254, -32, 779, 267, -39, REALM_ILSHENAR));   // Found Path...
 // SysLog("FindPath  -7 = "+FindPath(383, 1349, -42, 385, 1331, -39, REALM_ILSHENAR)); // Solution Corrupted!
 // SysLog("FindPath  +1 = "+FindPath(5393, 839, 45, 5394, 825, 60));                   // Solution Corrupted!
 // SysLog("FindPath  +2 = "+FindPath(5397, 816, 60, 5394, 804, 62));                   // Solution Corrupted!
 // SysLog("FindPath  +3 = "+FindPath(5462, 3077, -4, 5445, 3080, -3));                 // Solution Corrupted!
 // SysLog("FindPath  +4 = "+FindPath(5704, 824, 58, 5701, 834, 46));                   // Solution Corrupted!
 // SysLog("FindPath  +5 = "+FindPath(5681, 1411, 69, 5690, 1418, 43));                 // Failed to find a path.
 // SysLog("FindPath  +6 = "+FindPath(5711, 1414, 0, 5700, 1415, 38));                  // Found Path...
 // SysLog("FindPath  +7 = "+FindPath(5801, 1335, 1, 5789, 1344, 1));                   // Failed to find a path.
 // SysLog("FindPath  +8 = "+FindPath(802, 1305, -81, 817, 1314, -80, REALM_ILSHENAR)); // Found Path...
 // SysLog("FindPath  +9 = "+FindPath(5183, 1689, -1, 5195, 1701, 1));                  // Failed to find a path.
 // SysLog("FindPath +10 = "+FindPath(657, 836, -52, 669, 846, -61, REALM_ILSHENAR));   // Failed to find a path.
EndFunction

////////////////////////////////////////////////////
// TestDifferentThings - Testet verschiedene Dinge
////////////////////////////////////////////////////

Function TestDifferentThings(who, params)
  params:=SplitWords(params);
  If (!params[1])
    params[1]:="a";
  EndIf
  If (params[2])
    params[2]:=CInt(params[2]);
  Else
    params[2]:=LIST_IGNORE_Z;
  EndIf
  If (params[3])
    params[3]:=CInt(params[3]);
  Else
    params[3]:=0;
  EndIf
  If (params[4])
    params[4]:=CInt(params[4]);
  Else
    params[4]:=0;
  EndIf

  If (params[1]=="a")
   // SysLog("Statics "+ListStaticsAtLocation(who.x, who.y, params[2], params[3], who.realm));
   // SysLog("Items "+ListItemsAtLocation(who.x, who.y, params[2], who.realm));
   // SysLog("Objects "+ListObjectsInBox(who.x-params[2], who.y-params[2], who.z-params[2], who.x+params[2], who.y+params[2], who.z+params[2], who.realm));
    SysLog("Mobiles "+ListMobilesNearLocation(who.x, who.y, params[2], params[3], who.realm));
    ForEach mobile in ListMobilesNearLocation(who.x, who.y, params[2], params[3], who.realm)
      SysLog("  "+mobile.name);
    EndForEach
  ElseIf (params[1]=="b")
   // SysLog("Statics "+ListStaticsNearLocation(who.x, who.y, params[2], params[4], params[3], who.realm));
   // SysLog("Items "+ListItemsNearLocation(who.x, who.y, params[2], params[3], who.realm));
   // SysLog("Multis "+ListMultisInBox(who.x-params[2], who.y-params[2], who.z-params[2], who.x+params[2], who.y+params[2], who.z+params[2], who.realm));
    SysLog("Mobiles "+ListMobilesNearLocationEx(who.x, who.y, params[2], params[3], params[4], who.realm));
    ForEach mobile in ListMobilesNearLocationEx(who.x, who.y, params[2], params[3], params[4], who.realm)
      SysLog("  "+mobile.name);
    EndForEach
  ElseIf (params[1]=="c")
   // SysLog("Items "+ListItemsNearLocationOfType(who.x, who.y, params[2], params[3], params[4], who.realm));
   // SysLog("Statics "+ListStaticsInBox(who.x-params[2], who.y-params[2], who.z-params[2], who.x+params[2], who.y+params[2], who.z+params[2], params[3], who.realm));
  ElseIf (params[1]=="d")
   // SysLog("Items "+ListItemsNearLocationWithFlag(who.x, who.y, params[2], params[3], params[4], who.realm));
  EndIf
  SysLog("Layers "+GetStandingLayers(who.x, who.y, MAPDATA_FLAG_MOVELAND+MAPDATA_FLAG_MOVESEA));
EndFunction

//////////////////////////////////////////////////
// DetectSenslessNPCs - Spuert sinnlose NPCs auf
//////////////////////////////////////////////////

Function DetectSenslessNPCs(who)
  Var viecher:=Dictionary;
  Var counter:=0;

  ForEach npc in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (npc.isa(POLCLASS_NPC))
      If (GetObjProperty(npc, "ExMaster")==4580221)
        If (viecher[Lower(npc.npctemplate)])
          viecher[Lower(npc.npctemplate)]:=viecher[Lower(npc.npctemplate)]+1;
        Else
          viecher[Lower(npc.npctemplate)]:=1;
        EndIf
        counter:=counter+1;
      EndIf
    EndIf
  EndForEach

  SysLog(counter+" "+viecher);
EndFunction

///////////////////////////////////////////
// TestHousingTool - Testet ein bissl rum
///////////////////////////////////////////

Function TestHousingTool(who)
  If (who.multi)
    If (who.multi.isa(POLCLASS_HOUSE))
      Var oldexpansion:=who.acct.uo_expansion;
      who.acct.set_uo_expansion("AOS");

      SendSysMessagePergon(who, "UO-Expansion = "+who.acct.uo_expansion);
      SendHousingTool(who, who.multi.serial);

      who.acct.set_uo_expansion(oldexpansion);
    Else
      SendSysMessagePergon(who, "Ihr steht nicht in einem Haus!");
    EndIf
  Else
    SendSysMessagePergon(who, "Ihr steht nicht in einem Multi!");
  EndIf
EndFunction

/////////////////////////////////////////
// BugTest - Testet bestimmte Core-Bugs
/////////////////////////////////////////

Function BugTest()
 // Var days:=ReadConfigFile("::bug");
 // Var test:=days["test"];
 //
 // SysLog("A = "+days["test"].TestvalueA+" / "+TypeOf(days["test"].TestvalueA)+" / "+GetConfigInt(test, "TestvalueA")+" / "+GetConfigReal(test, "TestvalueA")+" / "+GetConfigString(test, "TestvalueA"));
 // SysLog("B = "+days["test"].TestvalueB+" / "+TypeOf(days["test"].TestvalueB)+" / "+GetConfigInt(test, "TestvalueB")+" / "+GetConfigReal(test, "TestvalueB")+" / "+GetConfigString(test, "TestvalueB"));
 // SysLog("C = "+days["test"].TestvalueC+" / "+TypeOf(days["test"].TestvalueC)+" / "+GetConfigInt(test, "TestvalueC")+" / "+GetConfigReal(test, "TestvalueC")+" / "+GetConfigString(test, "TestvalueC"));
 // SysLog("D = "+days["test"].TestvalueD+" / "+TypeOf(days["test"].TestvalueD)+" / "+GetConfigInt(test, "TestvalueD")+" / "+GetConfigReal(test, "TestvalueD")+" / "+GetConfigString(test, "TestvalueD"));
 // SysLog("E = "+days["test"].TestvalueE+" / "+TypeOf(days["test"].TestvalueE)+" / "+GetConfigInt(test, "TestvalueE")+" / "+GetConfigReal(test, "TestvalueE")+" / "+GetConfigString(test, "TestvalueE"));
 // SysLog("F = "+days["test"].TestvalueF+" / "+TypeOf(days["test"].TestvalueF)+" / "+GetConfigInt(test, "TestvalueF")+" / "+GetConfigReal(test, "TestvalueF")+" / "+GetConfigString(test, "TestvalueF"));

   // Pol097 Unpack() mit erweiterten Fehlerchecks vollgestopft (Bug gefunden von Turley)
   var packtest:=pack({1,"test"});
   print(packtest);
   var unpacktest:=unpack(packtest);
   print(unpacktest);

   // you'll get correct output:
   //   a2:i1S4:test
   //   { 1, test }

   packtest:=pack({"test",1,"test"});
   print(packtest);
   unpacktest:=unpack(packtest);
   print(unpacktest);

   //   a3:S4:testi1S4:test
   //   error{ errortext = "Unable to unpack array elem. Error in array elem." }

   packtest:=pack({"test","test"});
   print(packtest);
   unpacktest:=unpack(packtest);
   print(unpacktest);
EndFunction

////////////////////////////////////////////////////////////////
// TestHugeGumps - Testet, ob riesengrosse Gumps moeglich sind
////////////////////////////////////////////////////////////////

// params = 1212 -> 65525 Bytes
Function TestHugeGumps(who, params)
  Var layout:={"page 0", "nodispose", "resizepic 30 30 2620 40 40"};
  Var data:={};

  params:=CInt(params);
  If (!params)
    params:=1;
  EndIf

  For index:=1 to params
    data.append("abcdefghijklmnopqrstuvwxyz");
  EndFor

  SysLog(SendDialogGump(who, layout, data));
EndFunction

/////////////////////////////////////////////////////////////////
// TestHugeGumps2 - Testet, ob riesengrosse Gumps moeglich sind
/////////////////////////////////////////////////////////////////

// params = 630 -> 65516 Bytes
Function TestHugeGumps2(who, params)
  Var layout:={"page 0", "nodispose", "resizepic 30 30 2620 100 40"};
  Var data:={};
  Var pagecount:=1;

  params:=CInt(params);
  If (!params)
    params:=1;
  EndIf

  For index:=1 to params
    layout.append("page "+pagecount);
    If (index>1)
      layout.append("button 58 40 2650 2651 0 "+(pagecount-1));
    EndIf
    If (index<params)
      layout.append("button 38 40 2648 2647 0 "+(pagecount+1));
    EndIf

    layout.append("text 84 40 38 "+data.size());
    data.append(CStr(pagecount));

    pagecount:=pagecount+1;
  EndFor

  SysLog(SendDialogGump(who, layout, data));

  Var mobile;
  If ((mobile := Target(who, TGTOPT_NOCHECK_LOS)) == 0)
    //
  EndIf
EndFunction

//////////////////////////////////////////////////
// BloodCrash - Crash auf einem Boot provozieren
//////////////////////////////////////////////////

Function BloodCrash(who, params)
  If (params)
    params:=CInt(params);
  Else
    params:=10;
  EndIf

  While (1)
    SleepMS(RandomInt(100));

    For index:=1 to params
      CreateItemAtLocationPergon(who.x, who.y, who.z, 0xff9d, 1);
    EndFor
  EndWhile
EndFunction

///////////////////////////////////////////////////
// AttachCrash - Crash mittels Attach provozieren
///////////////////////////////////////////////////

Function AttachCrash(who)
  Syslog("Start "+GetPid());
  SysLog("Attach "+Attach(who));
  Sleep(5);
  Syslog("End   "+GetPid());
EndFunction

//////////////////////////////////////////////////////
// TestFindPathFlags - Bissl was mit FindPath testen
//////////////////////////////////////////////////////

Function TestFindPathFlags(who, params)
  SysLog(FindPath(5831, 370, -2, 5829, 364, -1, _DEFAULT_REALM, CInt(params)));
 // SysLog(FindPath(5459, 1168, 7, 5459, 1172, 0, _DEFAULT_REALM, CInt(params)));
 // SysLog(FindPath(who.x, who.y, who.z, who.x, who.y+1, who.z, _DEFAULT_REALM, CInt(params)));
EndFunction

////////////////////////////////////////////
// TestMathStuff - Testet da ein bissl rum
////////////////////////////////////////////

Function TestMathStuff(who)
  SysLog(Sqrt(10));
  SysLog(Pow(10, 0.5));
  SysLog(Root(10, 2));
  SysLog(Pow(10, 0.25));
  SysLog(Root(10, 4));
EndFunction

//////////////////////////////////////////////////
// TestPacketByteOrder - Testet da ein bissl rum
//////////////////////////////////////////////////

Function TestPacketByteOrder(who)
  Var packet:=CreatePacket(0, MSGLEN_VARIABLE);

  packet.SetInt16(10, 12345);
  packet.SetInt16Flipped(12, 12345);
  packet.SetInt32(14, 1234567890);
  packet.SetInt32Flipped(18, 1234567890);

  SysLog(packet.GetInt16(10));
  SysLog(packet.GetInt16Flipped(10));
  SysLog(packet.GetInt16(12));
  SysLog(packet.GetInt16Flipped(12));

  SysLog(packet.GetInt32(14));
  SysLog(packet.GetInt32Flipped(14));
  SysLog(packet.GetInt32(18));
  SysLog(packet.GetInt32Flipped(18));
EndFunction

///////////////////////////////////////////////
// TestRequestInput - Testet da ein bissl rum
///////////////////////////////////////////////

Function TestRequestInput(who)
  SysLog(RequestInputUC(who, who.backpack, CAscZ("Blubb"), "GER"));
EndFunction

///////////////////////////////////////////////////////////////////////////////////
// ShowRunawayScriptInfo - Zeigt Informationen ueber ein Script anhand der PID an
///////////////////////////////////////////////////////////////////////////////////

Function ShowRunawayScriptInfo(who, params)
  ForEach elem in (GetProcess(CInt(params)).globals)
    If (TypeOf(elem)=="MobileRef")
      If (elem.isa(POLCLASS_NPC))
        SendSysMessagePergon(who, "NPC '"+elem.name+"' bei "+elem.x+", "+elem.y+", "+elem.z+" ["+Lower(Hex(elem.serial))+"]");
        MoveObjectToLocation(who, elem.x, elem.y, elem.z, elem.realm, MOVEOBJECT_FORCELOCATION);
      Else
        SendSysMessagePergon(who, "Spieler '"+elem.name+"' bei "+elem.x+", "+elem.y+", "+elem.z+" ["+Lower(Hex(elem.serial))+"]");
        MoveObjectToLocation(who, elem.x, elem.y, elem.z, elem.realm, MOVEOBJECT_FORCELOCATION);
      EndIf
    EndIf
  EndForEach

  Var script:=GetProcess(GetPID());
  Attach(who);
  SysLog("1 "+script.attached_to);
  SysLog("2 "+script.attached_to.serial);
  SysLog("3 "+script.attached_to.name);
  SysLog("4 "+script.controller);
  SysLog("5 "+script.controller.serial);
  SysLog("6 "+script.controller.name);
  Detach();
  SysLog("7 "+script.attached_to);
EndFunction

////////////////////////////////////////////////////////
// TestSendDialogGump - Testet ein bissl mit Gumps rum
////////////////////////////////////////////////////////

Function TestSendDialogGump(who, params)
  params:=SplitWords(params);
  If (params.size()==2)
    Var layout:={"page 0", "nodispose", "resizepic 10 10 2620 50 50"};
    Var data:={};
    SendDialogGump(who, layout, data, CInt(params[1]), CInt(params[2]));
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

////////////////////////////////////////////////
// ModifyPunishInfo - Veraendert die Eintraege
////////////////////////////////////////////////

Function ModifyPunishInfo(who)
  Set_Critical(1);

  Var PI:=GetGlobalProperty("PunishInfos");
  SysLog("Alt = "+PI);

  ForEach entry in PI
    Var i := find(entry[2], "0x", 1);    // Serial zum Vergleich extrahieren
    Var s := entry[2][i, len(entry[2])];
    If (CInt(s) == 0x401FCA)
      entry[2]["0x401FCA"]:="0x401FCB";
    EndIf
  EndForEach

  SysLog("Neu = "+PI);
  SetGlobalProperty("PunishInfos", PI);

  Set_Critical(0);
EndFunction

///////////////////////////////////////////////////////////////////////////////////////////////////
// TestNewBuggedAustinFeatures - Austin hatte mal wieder Mist gebaut, mal schaun, ob's jetzt geht
///////////////////////////////////////////////////////////////////////////////////////////////////

Function TestNewBuggedAustinFeatures(who)
  SysLog("1 "+Bin(256));
  SysLog("2 "+Bin(255));
  SysLog("3 "+Bin(25));

  Var account:=FindAccount("Shinigami");
  If (account)
    SysLog("4 "+account.get_member("name")+" / "+account.name);
    SysLog("5 "+account.get_member("blah")+" / "+account.blah);
    SysLog("6 "+account.get_member("enabled")+" / "+account.enabled);
  EndIf

  Var script:=GetProcess(GetPID());
  If (script)
    SysLog("7 "+script.get_member("name")+" / "+script.name);
    SysLog("8 "+script.get_member("blah")+" / "+script.blah);
    SysLog("9 "+script.get_member("attached_to")+" / "+script.attached_to);
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////
// TestAccountScriptObject - Irgendwas soll da nich so richtig funktionieren
//////////////////////////////////////////////////////////////////////////////

Function TestAccountScriptObject(who)
  Var account:=FindAccount("Shinigami");
  If (account)
    SysLog("1 "+account.UsernamePasswordHash);
    SysLog("2 "+account.usernamepasswordhash);
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////
// ModifyAllBauAccounts - Setzt alle BauAccounts auf ein hoeheres CmdLevel
////////////////////////////////////////////////////////////////////////////

Function ModifyAllBauAccounts(who)
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          If (char.cmdlevel<CMDLEVEL_HIGHGM)
            char.cmdlevel:=CMDLEVEL_HIGHGM;
          EndIf
        EndIf
      EndFor
    Else
      SysLog("'"+accountname+"' gibt es nicht !");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////////////
// TestMoveObjectToLocation - Testet ein bissl rum, weil Buggy
////////////////////////////////////////////////////////////////

Function TestMoveObjectToLocation(who)
  MoveCharacterToLocation(who, 2521, 605, 0, MOVEOBJECT_FORCELOCATION);
  SysLog(who.x+" "+who.y+" "+who.z);
  MoveCharacterToLocation(who, 2521, 605, 0);
  SysLog(who.x+" "+who.y+" "+who.z);
  MoveCharacterToLocation(who, 2527, 606, 24, MOVEOBJECT_FORCELOCATION);
  SysLog(who.x+" "+who.y+" "+who.z);
  MoveCharacterToLocation(who, 2527, 606, 24);
  SysLog(who.x+" "+who.y+" "+who.z);
  MoveCharacterToLocation(who, 2528, 605, -22, MOVEOBJECT_FORCELOCATION);
  SysLog(who.x+" "+who.y+" "+who.z);
  MoveCharacterToLocation(who, 2528, 605, -22);
  SysLog(who.x+" "+who.y+" "+who.z);
EndFunction

/////////////////////////////////////////////////////////////////////////////
// CheckNPCAttaching - Prueft, inwieweit der NPC an das Script attached ist
/////////////////////////////////////////////////////////////////////////////

Function CheckNPCAttaching(who, params)
  Var process;

  If (params)
    process:=GetProcess(CInt(params));
  Else
    SendSysMessagePergon(who, "Bitte den NPC auswaehlen!");

    Var npc:=Target(who);
    If (npc.isa(POLCLASS_NPC))
      process:=npc.process;
    EndIf
  EndIf

  If (process)
    SendSysMessagePergon(who, "PID = "+process.pid);
    SendSysMessagePergon(who, "Name = "+process.name);
    If (process.attached_to)
      Var npc_text:="NPC";
      If (!process.attached_to.isa(POLCLASS_NPC))
        npc_text:="nix "+npc_text;
      EndIf

      SendSysMessagePergon(who, "Attached_to = "+process.attached_to+" "+TypeOf(process.attached_to)+" "+
        Lower(Hex(process.attached_to.serial))+" "+process.attached_to.name+" "+npc_text);
    EndIf
    SendSysMessagePergon(who, "Controller "+process.controller);
  Else
    SendSysMessagePergon(who, "Abbruch", "Abort");
  EndIf
EndFunction

/////////////////////////////////////////////////////////////////////
// FindAndDestroyTeleporterInRange - Sucht und zerstoert Teleporter
/////////////////////////////////////////////////////////////////////

Function FindAndDestroyTeleporterInRange(who, params)
  ForEach item in ListItemsNearLocation(who.x, who.y, who.z, 2, who.realm)
    If (item.objtype==0x6200)
      SendSysMessagePergon(who, item.x+" "+item.y+" nach "+GetObjProperty(item, "DestX")+" "+GetObjProperty(item, "DestY"));

      If (params=="weg")
        DestroyItem(item);
        SendSysMessagePergon(who, "  geloescht");
      EndIf
    EndIf
  EndForEach
EndFunction

/////////////////////////////////////////////////////////
// ConvertGuilds - Konvertiert altes Gildensys in Neues
/////////////////////////////////////////////////////////

Function ConvertGuilds()
  Var guild, leader, gildenname, gildentag, member;
  Var guildlist:={}, newguild;
  Var glist:=GetGlobalProperty("guild_list");
  ForEach g in (glist)  // Der Einfachheithalber nur die Serial speichern
    guildlist.append(g[1]);
  EndForEach

  ForEach stone in (ListObjectsInBox(0, 0, -128, 6143, 4095, 127))
    SleepMS(2);
    If (stone.objtype==0xa390)
      If (CInt(stone.serial) in guildlist)
        guild:=GetGlobalProperty("guild"+CInt(stone.serial));
        If (guild)
          gildenname:=guild[2];
          gildentag:=guild[3];
          If (!gildentag)
            gildentag:="";
          EndIf
          stone.eraseprop("guild_init");
          stone.eraseprop("update");
          stone.eraseprop("namechangetime");
          stone.eraseprop("abrevchangetime");
          stone.eraseprop("telechangetime");
          newguild:=CreateGuild();
          leader:=SystemFindObjectBySerial(CInt(guild[1][1]),SYSFIND_SEARCH_OFFLINE_MOBILES);  // Leader rausfinden
          newguild.setprop("name", gildenname);
          newguild.setprop("guild_tag", gildentag);
          newguild.setprop("leaders", {leader.serial});
         // EraseGlobalProperty("guild"+CInt(stone.serial));
          stone.setprop("guild_id", newguild.guildid);
          ForEach mem in (guild[6] + guild[9])
            member:=SystemFindObjectBySerial(CInt(mem[1]),SYSFIND_SEARCH_OFFLINE_MOBILES);
            If ((member) && (!member.ismember(newguild)))
              newguild.addmember(member);
              //member.eraseprop("guild_id");
              //member.eraseprop("abv");
              If (mem[3])
                member.title_race:=mem[3];
              EndIf
              member.title_suffix:="";
              member.title_guild(gildentag);

              If (member.name["Ritter"]) // RdO
                member.setprop("guildtitle","Ritter");
              ElseIf (member.name["Sir"])
                member.setprop("guildtitle","Sir");
              ElseIf (member.name["Lady"])
                member.setprop("guildtitle","Lady");
              ElseIf (member.name["Cruor"])  // OdN
                member.setprop("guildtitle","Cruor");
              ElseIf (member.name["Cruoria"])
                member.setprop("guildtitle","Cruoria");
              ElseIf (member.name["Magus"])
                member.setprop("guildtitle","Magus");
              ElseIf (member.name["Fascina"])
                member.setprop("guildtitle","Fascina");
              ElseIf (member.name["Furor"])
                member.setprop("guildtitle","Furor");
              ElseIf (member.name["Shinma"])
                member.setprop("guildtitle","Shinma");
              ElseIf (member.name["Praetor"])  // Lyrell
                member.setprop("guildtitle","Praetor");
              ElseIf (member.name["Praetorin"])
                member.setprop("guildtitle","Praetorin");
              ElseIf (member.name["Artesan"])
                member.setprop("guildtitle","Artesan");
              ElseIf (member.name["Artesana"])
                member.setprop("guildtitle","Artesana");
              ElseIf (member.name["Frater"])
                member.setprop("guildtitle","Frater");
              ElseIf (member.name["Soror"])
                member.setprop("guildtitle","Soror");
              ElseIf (member.name["Maestra"]) // IGM
                member.setprop("guildtitle","Maestra");
              ElseIf (member.name["Maestro"])
                member.setprop("guildtitle","Maestro");
              ElseIf (member.name["Signor"])
                member.setprop("guildtitle","Signor");
              ElseIf (member.name["Signora"])
                member.setprop("guildtitle","Signora");
              ElseIf (member.name["Bruder"])  // JdD
                member.setprop("guildtitle","Bruder");
              ElseIf (member.name["Bellatrix"])
                member.setprop("guildtitle","Bellatrix");
              ElseIf (member.name["Inquisitor"]) // IdF
                member.setprop("guildtitle","Inquisitor");
              ElseIf (member.name["Inquisitorin"])
                member.setprop("guildtitle","Inquisitorin");
              EndIf
            EndIf
          EndForEach
          SysLog("Gilde "+gildenname+" (ID "+newguild.guildid+") erfolgreich erzeugt");
        Else
          SysLog("Guildstone "+stone.serial+" bei "+stone.x+" "+stone.y+" "+stone.z+" ist keiner Gilde zugeordnet");
        EndIf
      Else
        SysLog("Guildstone "+stone.serial+" bei "+stone.x+" "+stone.y+" "+stone.z+" ist keiner Gilde zugeordnet");
      EndIf
    EndIf
  EndForEach
//  EraseGlobalProperty("guild_list");
EndFunction

/////////////////////////////////////////////////////////////
// TestMLStuff - Testet Mondain's Legacy Krams (z.B. Elfen)
/////////////////////////////////////////////////////////////

Function TestMLStuff(who)
 // who.race:=RACE_HUMAN;
 // who.race:=RACE_ELF;

  SendCharacterRaceChanger(who);
EndFunction


Function ConvertStabledPets(ticket)

  Var pet:=SystemFindObjectBySerial(ticket.getprop("PetSerial"));
  If (pet)
    Var cprops:=GetObjPropertyNames(pet);
    Var cpropsdict:=dictionary;
    ForEach prop in cprops
      cpropsdict[prop]:=pet.getprop(prop);
    EndForEach
    Var members:=struct;
    members.+graphic:=pet.graphic;
    members.+color:=pet.color;
    members.+npctemplate:=pet.npctemplate;
    members.+speech_color:=pet.speech_color;
    members.+speech_font:=pet.speech_font;
    members.+script:=pet.getprop("Heaven_OldScript");
    members.+use_adjustments:=pet.use_adjustments;
    members.+run_speed:=pet.run_speed;
    members.+gender:=pet.gender;
    members.+trueobjtype:=pet.trueobjtype;
    members.+truecolor:=pet.truecolor;
    members.+ar_mod:=pet.ar_mod;
    members.+ar:=pet.ar;
    members.+name:=pet.name;
    members.+STR:=GetStrPergon(pet);
    members.+INT:=GetIntPergon(pet);
    members.+DEX:=GetDexPergon(pet);
    members.+STR_MOD:=GetStrModPergon(pet);
    members.+Int_MOD:=GetIntModPergon(pet);
    members.+DEX_MOD:=GetDexModPergon(pet);
    members.+MANA:=GetManaPergon(pet);
    members.+HITS:=GetHpPergon(pet);
    members.+STAM:=GetStaminaPergon(pet);

    ticket.setprop("cprops",cpropsdict);
    ticket.setprop("members",members);

    If (pet.graphic in {ot_packhorse, ot_packllama}) //Packpferd
      If (pet.backpack)
        // Backpackinhalt in StorageArea sichern
        Var tamedarea:=FindStorageArea(STORAGE_KEYRINGS);
        If (!tamedarea)
          tamedarea:=CreateStorageArea(STORAGE_KEYRINGS);
        EndIf

        If (FindRootItemInStorageArea(tamedarea, "TicketBackpack  "+Hex(ticket.serial))) // mmmh gibt es schon, also vernichten
          DestroyRootItemInStorageArea(tamedarea, "TicketBackpack  "+Hex(ticket.serial));
        EndIf

        Var storage:=CreateRootItemInStorageArea(tamedarea, "TicketBackpack  "+Hex(ticket.serial), 0x0e7c); //Kiste createn
        ForEach items in (EnumerateItemsInContainer(pet.backpack))
          If (items.container.serial==pet.backpack.serial) //Nur Rootitems
            var oldmove:=items.movable;
            items.movable:=1;
            MoveItemToContainer(items,storage);
            items.movable:=oldmove;
          EndIf
          SleepMs(5);
        EndForEach
      EndIf
    EndIf

    KillMobileSilent(pet,"Stabled");
    Syslog("Petgefunden "+pet.name+" PetSerial "+pet.serial+" TicketSerial "+ticket.serial);

  Else
    DestroyItem(ticket);
  EndIf
EndFunction

Function ConvertStabledPetsContainer(container)
  Var unlocked:={}; // Welche SubContainer wurden aufgeschlossen?
  Var locked;       // Gabs noch was zum Aufschliessen?

  // Erstmal alles aufschliessen
  If (container.locked)
    container.locked:=0;
    unlocked.append(container);
  EndIf

  Repeat
    locked:=0;

    ForEach item in EnumerateItemsInContainer(container)
      If (item.isa(POLCLASS_CONTAINER))
        If (item.locked)
          item.locked:=0;
          locked:=1;
          unlocked.append(item);
        EndIf
      EndIf
    EndForEach
  Until (!locked);

  // Jetzt alles abarbeiten
  ForEach item in EnumerateItemsInContainer(container)
    If (item.objtype==0x14f0)
      ConvertStabledPets(item);
    EndIf
  EndForEach

  // Und wieder alles abschliessen, was aufgeschlossen wurde
  ForEach item in unlocked
    item.locked:=1;
  EndForEach
EndFunction

Function ConvertStabledPetsSearch(who)
  Var pet;
  Var storagearea:=FindStorageArea(STORAGE_MERCHANT);
  Var bankarea:=FindStorageArea(STORAGE_BANK);
  ForEach item in (ListObjectsInBox(0, 0, -128, 6143, 4095, 127))
    SleepMS(2);
    If (item.isa(POLCLASS_CONTAINER))
      ConvertStabledPetsContainer(item);
    ElseIf (item.objtype==0x14f0)
      ConvertStabledPets(item);
    ElseIf (item.isa(POLCLASS_NPC)) // NPC
      ConvertStabledPetsContainer(item);
      ConvertStabledPetsContainer(item.backpack);
      ConvertStabledPetsContainer(FindRootItemInStorageArea(storagearea, item.serial+" FS"));
      ConvertStabledPetsContainer(FindRootItemInStorageArea(storagearea, item.serial+" PB"));
      ConvertStabledPetsContainer(FindRootItemInStorageArea(storagearea, item.serial+" 1C"));
    EndIf
  EndForEach
  ForEach accountname in ListAccounts()
    Var account:=FindAccount(accountname);
    If (account)
      For charnr:=1 To 5
        Var char:=account.getcharacter(charnr);
        If (char)
          ForEach item in ListEquippedItems(char)
            If (item.objtype==0x14f0)
              ConvertStabledPets(item);
            EndIf
          EndForEach
          ConvertStabledPetsContainer(char.backpack);
          ConvertStabledPetsContainer(FindRootItemInStorageArea(bankarea, ST_PREF_BANK+char.serial));
        EndIf
      EndFor
    Else
      SysLog("  Account '"+accountname+"' gibt es nicht!");
    EndIf
  EndForEach
EndFunction

////////////////////////////////////////////////////////
// Wahlen_starten - Wahlen am alten Stadtstein starten
////////////////////////////////////////////////////////

Const ZEIT_WAHL:=7*24*3600; //12*3600; // 1   Woche

Function Wahlen_starten(who)
  Var townstone:=SystemFindObjectBySerial(0x4b3ca284); // Minoc 0x402f198e / Nirdana 0x4b3ca284
  If (townstone)
    If (townstone.objtype==0xa320)
      Var town:=GetObjProperty(townstone, "town");
      If (town)
        Var city:=GetGlobalProperty("townlist")[CInt(town)];

        If (GetObjProperty(townstone, "eleicao"))
          SendSysMessagePergon(who, "Wahl lief gerade in "+city);
          EraseObjProperty(townstone, "eleicao");
        EndIf
        If (GetObjProperty(townstone, "pleibicito"))
          SendSysMessagePergon(who, "Abstimmung lief gerade in "+city);
          EraseObjProperty(townstone, "pleibicito");
        EndIf

        ForEach runa in EnumerateItemsInContainer(townstone)
          DestroyItem(runa);
        EndForEach

        SetObjProperty(townstone, "candidatos", {});
       // SetObjProperty(townstone, "eleicao", 1); // Wahl starten
        SetObjProperty(townstone, "eleicao", 1); // Wahlen stoppen
        SetObjProperty(townstone, "votos", 0);
       // SetObjProperty(townstone, "timer", ReadGameClock()+ZEIT_WAHL); // Wahl starten
        SetObjProperty(townstone, "timer", 0); // Wahlen stoppen
        SetObjProperty(townstone, "votepercent", 0);

       // BroadcastPergon("Neue Wahlen in "+city+"!!!");
        BroadcastPergon("Wahlen in "+city+" gestoppt!");
      Else
        SendSysMessagePergon(who, "Falsch initialisierter Stadtstein!");
      EndIf
    Else
      SendSysMessagePergon(who, "Dies ist kein Stadtstein!");
    EndIf
  Else
    SendSysMessagePergon(who, "Stadtstein nicht gefunden!");
  EndIf
EndFunction

//////////////////////////////////////////////////
// StaticsExportEremit - Massendaten exportieren
//////////////////////////////////////////////////

Function StaticsExportEremit(who, params)
 // Run_Script_to_CompletionPergon("textcmd/8_test/staticsexport", {who, ""});
EndFunction

//////////////////////////////////////////////////////
// StaticsExchange - Massenweise Statics austauschen
//////////////////////////////////////////////////////
//
// MapUpdate 31.10.2006

Function StaticsExchange(who)
  StaticsExchange_remove( 1,  566, 1648,  582, 1661, 1);
  StaticsExchange_remove( 2, 1534,  549, 1548,  565, 1);
  StaticsExchange_remove( 3, 1845,  900, 1866,  918, 1);
  StaticsExchange_remove( 4, 1913, 1102, 1930, 1115, 1);
  StaticsExchange_remove( 5, 2260,  420, 2280,  450, 1);
  StaticsExchange_remove( 6, 3151,   25, 3166,   39, 1);
  StaticsExchange_remove( 7, 3434,  473, 3460,  493, 1);

  StaticsExchange_remove( 8, 179,   686,  403,  921, 1); // Eigentlich Runen nicht ignorieren, aber da is nur eine mit einer Stadtwache in Yew...
  StaticsExchange_remove( 9, 2390,  498, 2451,  569, 1);
  StaticsExchange_remove(10, 2584,  209, 2703,  351, 1);

  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_566_1648_582_1661");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_1534_549_1548_565");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_1845_900_1866_918");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_1913_1102_1930_1115");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_2260_420_2280_450");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_3151_25_3166_39");
  StaticsExchange_import(0, "statics/statics/alten kram loeschen bis auf spawnrunen/staticsno_3434_473_3460_493");

  StaticsExchange_import(0, "statics/statics/vorher alten kram loeschen/staticsno_179_686_403_921");
  StaticsExchange_import(0, "statics/statics/vorher alten kram loeschen/staticsno_2390_498_2451_569");
  StaticsExchange_import(0, "statics/statics/vorher alten kram loeschen/staticsno_2584_209_2703_351");

  StaticsExchange_import(1, "statics/statics/nur einspielen/Gildehaeuser Einrichtung/statics_drachenbrueder");
  StaticsExchange_import(1, "statics/statics/nur einspielen/Gildehaeuser Einrichtung/statics_Hueter_Gildehaus");
  StaticsExchange_import(1, "statics/statics/nur einspielen/Gildehaeuser Einrichtung/statics_nekrogilde");
  StaticsExchange_import(1, "statics/statics/nur einspielen/Gildehaeuser Einrichtung/statics_NErkzul");
  StaticsExchange_import(1, "statics/statics/nur einspielen/Gildehaeuser Einrichtung/statics_Rose_und_Kelch");
  StaticsExchange_import(1, "statics/statics/nur einspielen/statics_1390_3684_1457_3733");
  StaticsExchange_import(0, "statics/statics/nur einspielen/staticsno_808_1616_999_1724");
  StaticsExchange_import(0, "statics/statics/nur einspielen/staticsno_3170_56_3574_450");
  StaticsExchange_import(0, "statics/statics/nur einspielen/staticsno_5122_2045_5193_2103");
EndFunction

////////////////////////////////////////////////////////////////////////////////////
// StaticsExchange_remove - Statics entfernen (angelehnt an TextCMD StaticsExport)
////////////////////////////////////////////////////////////////////////////////////

Function StaticsExchange_remove(number, x1, y1, x2, y2, ignorerunes)
  Var datafile:=ReadConfigFile("statics/statics");
  Var datafileno:=ReadConfigFile("statics/staticsno");

  If (datafile And datafileno)
    SysLog("  StaticsExchange_remove: "+x1+" "+y1+" "+x2+" "+y2+" loeschen...");

    Var itemdesc:=ReadConfigFile("::itemdesc");
    Var counter:=StaticsExchange_GetNextCounterNumber(datafile);
    Var counterno:=StaticsExchange_GetNextCounterNumber(datafileno);
    Var subcounter:=0;
    Var subcounterno:=0;

    Var elem;
    Var result;
    ForEach item in ListObjectsInBox(x1, y1, -128, x2, y2, 127)
      If (item.isa(POLCLASS_ITEM) And (!item.multi) And (!(ignorerunes And (item.objtype==0xa300))))
        result:=StaticsExchange_ShouldMakeStatic(itemdesc, item);
        If (result.makestatic)
          elem:={};
          elem.append({"NAME",   "#"});
          elem.append({"Serial", Hex(item.serial)});
          elem.append({"ID",     item.graphic});
          elem.append({"X",      item.x});
          elem.append({"Y",      item.y});
          elem.append({"Z",      item.z});
          elem.append({"COLOR",  item.color});
          elem.append({"CONT",   -1});
          elem.append({"TYPE",   255});
          AppendConfigFileElem("statics/statics", "SECTION", "WORLDITEM "+counter+" "+number, elem);

          counter:=counter+1;
          subcounter+=1;
        Else
          elem:={};
          elem.append({"Serial",  Hex(item.serial)});
          elem.append({"ObjType", Hex(item.objtype)});
          elem.append({"X",       item.x});
          elem.append({"Y",       item.y});
          elem.append({"Z",       item.z});
          elem.append({"Color",   item.color});
          If (result.name)
            elem.append({"Name",  result.name});
          EndIf
          If (result.type<>"")
            elem.append({"Type", result.type});
          EndIf
          If (result.usescript)
            elem.append({"UseScript", result.usescript});
          EndIf
          If (result.script)
            elem.append({"Script", result.script});
          EndIf
          If (result.walkonscript)
            elem.append({"WalkOnScript", result.walkonscript});
          EndIf
          If (result.controlscript)
            elem.append({"ControlScript", result.controlscript});
          EndIf
          Var cprops:=Dictionary;
          ForEach cpropname in GetObjPropertyNames(item)
            cprops[cpropname]:=item.getprop(cpropname);
          EndForEach
          elem.append({"CProps", cprops});
          AppendConfigFileElem("statics/staticsno", "SECTION", "WORLDITEM "+counterno+" "+number, elem);

          counterno:=counterno+1;
          subcounterno+=1;
        EndIf

        result:=DestroyItem(item);
        If (!result)
          SysLog("    StaticsExchange_remove: FEHLER: Konnte das Item '"+item.desc+"' ("+Lower(Hex(item.serial))+") nicht loeschen ("+result.errortext+") !");
        EndIf
      EndIf
    EndForEach

    UnloadConfigFile("statics/staticsno");
    UnloadConfigFile("statics/statics");

    SysLog("  StaticsExchange_remove: "+x1+" "+y1+" "+x2+" "+y2+" geloescht ("+subcounter+" "+subcounterno+").");
  Else
    SysLog("  StaticsExchange_remove: FEHLER: Kann statics und/oder staticsno nicht oeffnen!");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////////////////////////////
// StaticsExchange_import - Statics importieren (angelehnt an TextCMD StaticsImport)
//////////////////////////////////////////////////////////////////////////////////////

Function StaticsExchange_import(statics, cfgname)
  Var datafile:=ReadConfigFile(cfgname);
  If (datafile)
    SysLog("  StaticsExchange_import: '"+cfgname+"' importieren...");

    Var counter:=0;
    Var item;
    Var object;
    ForEach name in GetConfigStringKeys(datafile)
      item:=datafile[name];
      If (item)
        If (statics)
          object:=CreateItemAtLocationPergon(item.x, item.y, item.z, item.id, 1);
        Else
          object:=CreateItemAtLocationPergon(item.x, item.y, item.z, item.objtype, 1);
          If (object)
            If (item.name)
              SetName(object, item.name);
            EndIf
          EndIf
        EndIf

        If (object)
          object.color:=item.color;
          object.decayat:=0;
          object.movable:=0;

          If (object.isa(POLCLASS_DOOR))
            object.locked:=1; // Gildenhaeuser etc.
          EndIf

          counter+=1;
        Else
          If (statics)
            SysLog("    StaticsExchange_import: FEHLER: Kann "+Lower(Hex(item.id))+" bei "+item.x+" "+item.y+" "+item.z+" nicht importieren!");
          Else
            SysLog("    StaticsExchange_import: FEHLER: Kann "+Lower(Hex(item.objtype))+" bei "+item.x+" "+item.y+" "+item.z+" nicht importieren!");
          EndIf
        EndIf
      EndIf
    EndForEach

    UnloadConfigFile(cfgname);

    SysLog("  StaticsExchange_import: '"+cfgname+"' importiert ("+counter+").");
  Else
    SysLog("  StaticsExchange_import: FEHLER: Kann '"+cfgname+"' nicht oeffnen!");
  EndIf
EndFunction

///////////////////////////////////////////////////////////////////////////////////////////////////////////
// StaticsExchange_GetNextCounterNumber - Die naechste Nummer ermitteln (Kopie aus TextCMD StaticsExport)
///////////////////////////////////////////////////////////////////////////////////////////////////////////

Function StaticsExchange_GetNextCounterNumber(datafile)
  Var counter:=GetConfigStringKeys(datafile);
  If (Len(counter))
    Return (Len(counter));
  Else
    Return (0);
  EndIf
EndFunction

////////////////////////////////////////////////////////////////////////////////////////////////////////////
// StaticsExchange_ShouldMakeStatic - Kann man das Item statisch machen? (Kopie aus TextCMD StaticsExport)
////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Folgendes fliegt raus:
//   Abschliessbares - Container, Tueren
//   Multis          - Haeuser, Boote
//   SpawnNet        - SpawnRunen, gespawnte Gegenstaende
//   Name            - Gegenstaende mit unueblichem Namen
//   UseScript       - Gegenstaende mit Script
//   Script          - Gegenstaende mit Script
//   WalkOnScript    - Gegenstaende mit WalkOnScript
//   ControlScript   - Gegenstaende mit ControlScript
//   IGNORE_ITEMS    - Sonstiges
//   STATIZISE_ITEMS - Items zum so oder so Statisieren

Var IGNORE_ITEMS:={0xfaf, 0xfb0, 0x19f9, 0x19fc, 0xff11, 0xff12};
Var STATIZISE_ITEMS:={0xe57, 0xc9a, 0xccd, 0xd94, 0xda4, 0xce0, 0xcf8, 0xcda, 0xcd6, 0xd9c, 0xce6, 0xd43, // Baeume
  0x12b8, 0x12b9, 0x12ba, 0x12bb, 0x224D, 0x224C, 0x224B, 0x247A, 0x247E, 0x247D, 0x2471, 0x224A, 0x26ED, 0x26F3};

Function StaticsExchange_ShouldMakeStatic(itemdesc, item)
  Var result:={};
  result.+makestatic:=1;

  Var iteminfo:=itemdesc[item.graphic];
  If (((item.isa(POLCLASS_LOCKABLE) Or item.isa(POLCLASS_MULTI) Or GetObjProperty(item, "spawnnet") Or
     (item.name And (item.name<>iteminfo.desc)) Or (item.graphic in IGNORE_ITEMS) Or item.usescript Or
     iteminfo.script Or iteminfo.walkonscript Or iteminfo.controlscript)) And (!(item.graphic in STATIZISE_ITEMS)))
    result.+type:="";
    If (item.isa(POLCLASS_LOCKABLE))
      result.type:=result.type+"Lockable ";
    EndIf
    If (item.isa(POLCLASS_MULTI))
      result.type:=result.type+"Multi ";
    EndIf
    If (GetObjProperty(item, "spawnnet"))
      result.type:=result.type+"SpawnNet ";
    EndIf
    If ((iteminfo.facing==0) Or (iteminfo.facing))
      result.type:=result.type+"Light ";
    EndIf
    If (item.name And (item.name<>iteminfo.desc))
      result.+name:=item.name;
    EndIf
    result.+usescript:=item.usescript;
    result.+script:=iteminfo.script;
    result.+walkonscript:=iteminfo.walkonscript;
    result.+controlscript:=iteminfo.controlscript;

    result.makestatic:=0;
  EndIf

  Return (result);
EndFunction

///////////////////////////////////////////////////////////////////////////////////////////
// UnBlockAccounts - Entsperrt mehrere Accounts und loescht ggf. fehlkonfigurierten Chars
///////////////////////////////////////////////////////////////////////////////////////////

Function UnBlockAccounts(who)
 // UnBlockAccount("", 0);
EndFunction

////////////////////////////////////////////////////////////////////////////////////////////
// UnBlockAccount - Entsperrt einen Account und loescht ggf. einen fehlkonfigurierten Char
////////////////////////////////////////////////////////////////////////////////////////////

Function UnBlockAccount(accountname, removecharacterid:=0)
  Var account:=FindAccount(accountname);
  If (account)
    If (account.getprop(ACCT_NEWCHAR_BLOCK))
      account.eraseprop(ACCT_NEWCHAR_BLOCK);

      If (removecharacterid)
        Var character:=account.getcharacter(removecharacterid);
        If (character)
          SysLog("  Char '"+character.name+"' von Account '"+accountname+"' wird geloescht.");
          DeleteCharacterPergon(account, removecharacterid);
        Else
          SysLog("  Es gibt keinen Character mit der ID "+removecharacterid+" !");
        EndIf
      EndIf

      For index:=1 To 5
        Var character:=account.getcharacter(index);
        If (character)
          character.frozen:=0;
          character.paralyzed:=0;
          EraseObjProperty(character, "frozen");
        EndIf
      EndFor

      SysLog("  Der Account '"+accountname+"' sollte wieder funktionieren.");
    Else
      SysLog("  Der Account '"+accountname+"' war nicht gesperrt.");
    EndIf
  Else
    SysLog("  '"+accountname+"' gibt es nicht !");
  EndIf
EndFunction

//////////////////////////////////////////////////////////////
// DeleteItemsWithSerial - Loescht Items anhand ihrer Serial
//////////////////////////////////////////////////////////////

Function DeleteItemsWithSerial(who)
  Var anzahl:=0;
  Var item;

  For serial:=0x41b59f16 To 0x41b62037
    item:=SystemFindObjectBySerial(serial);
    If (item)
      If (item.objtype in {0x35b2, 0x35b3, 0x35b4, 0x35b5, 0x35b6})
        DestroyItem(item);
        anzahl:=anzahl+1;
      EndIf
    EndIf
  EndFor

  SysLog(anzahl+" Items geloescht");
EndFunction

Function RemoveForgottenBlood()
  // Welt durchsuchen
  var count := 0;
  ForEach item in ListObjectsInBox(0, 0, -128, 6143, 4095, 127)
    If (!item.isa(POLCLASS_ITEM))
      continue;
    EndIf

    // Jehova
    If (item.objtype == 0x1cf3 and item.name == "noch warmes Blut")
      DestroyItem(item);
      count += 1;
    EndIf

    // diverse Spells
    If (item.objtype == 0x122d or item.objtype == 0x122f)
      DestroyItem(item);
      count += 1;
    EndIf

    // Obduktion/Blutglas
    If (
      item.objtype in (array{
          0x1cf2, 0x1cf4, 0x1cf6, 0x1d06, 0x1d12, 0x5ff1,
          0x5ff2, 0x5ff3, 0x5ff4, 0x5ff5, 0x5ff6, 0x5ff7,
          0x5ffb, 0x5ffc, 0x5ffd, 0x5ffe, 0x5fff, 0x6000
      }) and item.name == "Blutlache"
    )
      DestroyItem(item);
      count += 1;
    EndIf
  EndForEach

  syslog(count+" Blutitems geloescht");
EndFunction
